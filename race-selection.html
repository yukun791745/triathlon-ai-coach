<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triathlon AI Coach - ãƒ¬ãƒ¼ã‚¹é¸æŠ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #dbeafe 0%, #ffffff 50%, #cffafe 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
        }
        .flow-navbar {
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: 240px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 24px 0;
            overflow-y: auto;
        }
        .flow-nav-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            text-align: center;
            padding: 0 20px 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        .flow-nav-steps { display: flex; flex-direction: column; gap: 8px; padding: 0 16px; }
        .flow-nav-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        .flow-nav-step .nav-icon { font-size: 1.4rem; }
        .flow-nav-step.current { background: rgba(255, 255, 255, 0.25); color: white; }
        .flow-nav-step.available:hover { background: rgba(255, 255, 255, 0.15); color: white; transform: translateX(5px); }
        .content-wrapper { margin-left: 240px; flex: 1; padding: 24px; width: calc(100% - 240px); }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .title { font-size: 28px; font-weight: bold; color: #1f2937; margin-bottom: 6px; }
        .subtitle { font-size: 14px; color: #4b5563; }
        .stats { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
        .stat-card { background: white; border-radius: 8px; padding: 10px 14px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08); text-align: center; }
        .stat-number { font-size: 18px; font-weight: bold; color: #2563eb; }
        .stat-label { font-size: 10px; color: #6b7280; }
        .source-badges { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
        .source-badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; border: 2px solid transparent; opacity: 0.5; transition: all 0.2s; }
        .source-badge.active { opacity: 1; border-color: currentColor; }
        .source-badge.jtu { background: #e0f2fe; color: #0369a1; }
        .source-badge.lumina { background: #fef3c7; color: #b45309; }
        .source-badge.ironman { background: #fce7f3; color: #be185d; }
        .source-badge.challenge { background: #dcfce7; color: #166534; }
        .source-badge.t100 { background: #f3e8ff; color: #7c3aed; }
        .source-badge.xterra { background: #fed7aa; color: #c2410c; }
        .selection-panel { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 10px; padding: 14px 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .selection-title { font-size: 14px; font-weight: 600; }
        .selection-stat { display: flex; align-items: center; gap: 6px; }
        .selection-stat-number { font-size: 20px; font-weight: bold; }
        .selection-stat-label { font-size: 12px; opacity: 0.9; }
        .goal-button { background: white; color: #d97706; border: none; padding: 10px 18px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px; margin-left: auto; }
        .goal-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .filters-panel { background: white; border-radius: 10px; padding: 14px 18px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08); }
        .filters-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; flex-direction: column; gap: 3px; }
        .filter-label { font-size: 10px; color: #6b7280; font-weight: 600; }
        .filter-select, .filter-input { padding: 7px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; min-width: 120px; }
        .filter-input { min-width: 180px; }
        .refresh-btn { padding: 7px 14px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .refresh-btn:disabled { opacity: 0.6; }
        .search-result { margin-left: auto; font-size: 13px; color: #6b7280; font-weight: 600; }
        .races-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 14px; margin-bottom: 20px; }
        .race-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); transition: all 0.2s; position: relative; }
        .race-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12); }
        .race-card.selected-a-race { border: 3px solid #f59e0b; }
        .race-card.selected-other-race { border: 3px solid #8b5cf6; }
        .selection-badge { position: absolute; top: 8px; right: 8px; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; z-index: 10; }
        .selection-badge.a-race { background: #f59e0b; color: white; }
        .selection-badge.other-race { background: #8b5cf6; color: white; }
        .race-content { padding: 14px; }
        .race-header { display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
        .category-badge { padding: 2px 7px; border-radius: 4px; font-size: 9px; font-weight: 600; }
        .category-jtu { background: #dbeafe; color: #1e40af; }
        .category-lumina { background: #fef3c7; color: #92400e; }
        .category-ironman { background: #fce7f3; color: #9d174d; }
        .category-challenge { background: #d1fae5; color: #065f46; }
        .category-t100 { background: #ede9fe; color: #5b21b6; }
        .category-xterra { background: #ffedd5; color: #9a3412; }
        .race-title { font-size: 14px; font-weight: 600; color: #111827; margin-bottom: 8px; line-height: 1.3; }
        .race-info { display: flex; flex-direction: column; gap: 3px; margin-bottom: 8px; font-size: 11px; color: #4b5563; }
        .distance-badges { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
        .distance-badge { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 2px 7px; border-radius: 4px; font-size: 9px; font-weight: 600; }
        .race-features { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
        .feature-tag { background: #f3f4f6; color: #4b5563; padding: 2px 6px; border-radius: 4px; font-size: 9px; }
        .race-actions { display: flex; flex-direction: column; gap: 6px; padding-top: 10px; border-top: 1px solid #e5e7eb; }
        .race-button { display: flex; align-items: center; justify-content: center; gap: 5px; padding: 7px 10px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; text-decoration: none; border-radius: 6px; font-size: 11px; font-weight: 500; }
        .selection-buttons { display: flex; gap: 5px; }
        .selection-button { flex: 1; padding: 6px; border: 2px solid #e5e7eb; background: white; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; }
        .selection-button.a-race:hover, .selection-button.a-race.active { border-color: #f59e0b; background: #fffbeb; color: #b45309; }
        .selection-button.other-race:hover, .selection-button.other-race.active { border-color: #8b5cf6; background: #f5f3ff; color: #6d28d9; }
        .selection-button.remove { flex: 0; padding: 6px 10px; background: #fee2e2; border-color: #fca5a5; color: #dc2626; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        .loading-text { margin-top: 12px; font-size: 14px; color: #4b5563; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .no-results { grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #6b7280; }
        .footer { text-align: center; padding: 16px; color: #6b7280; font-size: 12px; }
        @media (max-width: 768px) {
            .flow-navbar { width: 100%; height: 60px; bottom: auto; padding: 10px; }
            .flow-nav-logo { padding: 0; margin: 0; border: none; font-size: 1rem; }
            .flow-nav-steps { display: none; }
            .content-wrapper { margin-left: 0; padding: 16px; padding-top: 80px; width: 100%; }
            .races-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="flow-navbar">
        <div class="flow-nav-logo">AI Triathlon Coach</div>
        <div class="flow-nav-steps">
            <a href="home.html" class="flow-nav-step available"><span class="nav-icon">ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span></a>
            <a href="index.html" class="flow-nav-step available"><span class="nav-icon">ğŸ¤–</span><span>AIã‚³ãƒ¼ãƒ</span></a>
            <a href="news.html" class="flow-nav-step available"><span class="nav-icon">ğŸ“°</span><span>ãƒ‹ãƒ¥ãƒ¼ã‚¹</span></a>
            <a href="race-selection.html" class="flow-nav-step current"><span class="nav-icon">ğŸ¯</span><span>ãƒ¬ãƒ¼ã‚¹é¸æŠ</span></a>
            <a href="goal-setting.html" class="flow-nav-step available"><span class="nav-icon">ğŸ†</span><span>ç›®æ¨™è¨­å®š</span></a>
            <a href="training-plan.html" class="flow-nav-step available"><span class="nav-icon">ğŸ“‹</span><span>è¨ˆç”»</span></a>
            <a href="simulator.html" class="flow-nav-step available"><span class="nav-icon">ğŸ”¬</span><span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</span></a>
            <a href="data.html" class="flow-nav-step available"><span class="nav-icon">ğŸ“Š</span><span>é€²æ—</span></a>
        </div>
    </nav>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>
    </div>

    <div class="content-wrapper">
        <div class="container">
            <div class="header">
                <h1 class="title">ğŸŠğŸš´ğŸƒ ãƒ¬ãƒ¼ã‚¹é¸æŠ</h1>
                <p class="subtitle">ç›®æ¨™ãƒ¬ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ã‚‡ã†</p>
            </div>
            
            <div class="stats">
                <div class="stat-card"><div class="stat-number" id="total-count">0</div><div class="stat-label">å…¨å¤§ä¼š</div></div>
                <div class="stat-card"><div class="stat-number" id="filtered-count">0</div><div class="stat-label">è¡¨ç¤ºä¸­</div></div>
                <div class="stat-card"><div class="stat-number" id="japan-count">0</div><div class="stat-label">å›½å†…</div></div>
                <div class="stat-card"><div class="stat-number" id="overseas-count">0</div><div class="stat-label">æµ·å¤–</div></div>
            </div>

            <div class="source-badges">
                <span class="source-badge jtu active" data-source="jtu" onclick="toggleSource('jtu')">JTUå…¬èª</span>
                <span class="source-badge lumina active" data-source="lumina" onclick="toggleSource('lumina')">LUMINA</span>
                <span class="source-badge ironman active" data-source="ironman" onclick="toggleSource('ironman')">IRONMAN</span>
                <span class="source-badge challenge active" data-source="challenge" onclick="toggleSource('challenge')">Challenge</span>
                <span class="source-badge t100 active" data-source="t100" onclick="toggleSource('t100')">T100</span>
                <span class="source-badge xterra active" data-source="xterra" onclick="toggleSource('xterra')">XTERRA</span>
            </div>
            
            <div class="selection-panel">
                <div class="selection-title">ğŸ“Œ é¸æŠä¸­ã®ãƒ¬ãƒ¼ã‚¹</div>
                <div class="selection-stat"><span class="selection-stat-number" id="a-race-count">0</span><span class="selection-stat-label">ğŸ† Aãƒ¬ãƒ¼ã‚¹</span></div>
                <div class="selection-stat"><span class="selection-stat-number" id="other-race-count">0</span><span class="selection-stat-label">ğŸª ãã®ä»–</span></div>
                <button class="goal-button" id="goal-setting-button" disabled onclick="goToGoalSetting()">ğŸ¯ ç›®æ¨™è¨­å®šãƒšãƒ¼ã‚¸ã¸é€²ã‚€</button>
            </div>
            
            <div class="filters-panel">
                <div class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="text" class="filter-input" id="search-input" placeholder="å¤§ä¼šåãƒ»å ´æ‰€ã§æ¤œç´¢...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“… é–‹å‚¬æœˆ</label>
                        <select class="filter-select" id="month-select">
                            <option value="">å…¨ã¦ã®æœˆ</option>
                            <option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option>
                            <option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                            <option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09">9æœˆ</option>
                            <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸŒ åœ°åŸŸ</label>
                        <select class="filter-select" id="region-select">
                            <option value="">å…¨åœ°åŸŸ</option>
                            <option value="japan">æ—¥æœ¬å›½å†…</option>
                            <option value="overseas">æµ·å¤–</option>
                            <option value="asia">ã‚¢ã‚¸ã‚¢</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ† ç«¶æŠ€è·é›¢</label>
                        <select class="filter-select" id="distance-select">
                            <option value="">å…¨ã¦ã®è·é›¢</option>
                            <option value="ã‚¹ãƒ—ãƒªãƒ³ãƒˆ">ã‚¹ãƒ—ãƒªãƒ³ãƒˆ</option>
                            <option value="ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</option>
                            <option value="ãƒŸãƒ‰ãƒ«">ãƒŸãƒ‰ãƒ« / 70.3</option>
                            <option value="ãƒ­ãƒ³ã‚°">ãƒ­ãƒ³ã‚° / ãƒ•ãƒ«</option>
                            <option value="ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰">ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰</option>
                        </select>
                    </div>
                    <button class="refresh-btn" id="refresh-btn" onclick="refreshRaces()">ğŸ”„ æ›´æ–°</button>
                    <div class="search-result" id="search-result">0 ä»¶ã®å¤§ä¼š</div>
                </div>
            </div>
            
            <div class="races-grid" id="races-container"></div>
            
            <div class="footer">
                <p>ğŸŒ ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: JTUã€LUMINAã€IRONMANã€Challenge Familyã€T100ã€XTERRA</p>
                <p id="last-updated">æœ€çµ‚æ›´æ–°: --</p>
            </div>
        </div>
    </div>

    <script>
        let races = [];
        let filteredRaces = [];
        let selectedRaces = { aRaces: new Set(), otherRaces: new Set() };
        let activeSources = new Set(['jtu', 'lumina', 'ironman', 'challenge', 't100', 'xterra']);
        
        document.addEventListener('DOMContentLoaded', async () => {
            const cached = localStorage.getItem('races_cache');
            if (cached) {
                try {
                    const data = JSON.parse(cached);
                    const cacheAge = Date.now() - new Date(data.lastUpdated).getTime();
                    if (cacheAge < 3600000) {
                        races = data.races;
                        updateStats();
                        filterRaces();
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('last-updated').textContent = 'æœ€çµ‚æ›´æ–°: ' + new Date(data.lastUpdated).toLocaleString('ja-JP');
                        return;
                    }
                } catch (e) { console.error('Cache error:', e); }
            }
            await fetchRacesFromAPI();
        });
        
        async function fetchRacesFromAPI() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('refresh-btn').disabled = true;
            
            try {
                const response = await fetch('/.netlify/functions/fetch-races');
                if (!response.ok) throw new Error('API error');
                const data = await response.json();
                
                if (data.success && data.races) {
                    races = data.races;
                    localStorage.setItem('races_cache', JSON.stringify({ races: races, lastUpdated: data.lastUpdated }));
                    document.getElementById('last-updated').textContent = 'æœ€çµ‚æ›´æ–°: ' + new Date(data.lastUpdated).toLocaleString('ja-JP');
                    updateStats();
                    filterRaces();
                }
            } catch (error) {
                console.error('Fetch error:', error);
                races = getStaticRaces();
                updateStats();
                filterRaces();
                document.getElementById('last-updated').textContent = 'âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ä¸­';
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('refresh-btn').disabled = false;
            }
        }
        
        function getStaticRaces() {
            return [
                { id: 'jtu_miyako_2026', name: 'å…¨æ—¥æœ¬ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³å®®å¤å³¶å¤§ä¼š', date: '2026-04-19', location: 'æ²–ç¸„çœŒå®®å¤å³¶å¸‚', country: 'æ—¥æœ¬', distance: 'ãƒ­ãƒ³ã‚°', category: 'JTUå…¬èªå¤§ä¼š', source: 'JTU', url: 'https://tri-miyako.com/', description: 'å›½å†…æœ€é«˜å³°ã®ãƒ­ãƒ³ã‚°å¤§ä¼š', features: ['JTU', 'ãƒ­ãƒ³ã‚°'] },
                { id: 'jtu_ishigaki_2026', name: 'çŸ³å£å³¶ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³å¤§ä¼š', date: '2026-04-26', location: 'æ²–ç¸„çœŒçŸ³å£å¸‚', country: 'æ—¥æœ¬', distance: 'ãƒ­ãƒ³ã‚°', category: 'JTUå…¬èªå¤§ä¼š', source: 'JTU', url: 'https://ishigaki-triathlon.jp/', description: 'ç¾ã—ã„æµ·ã‚’æ³³ã', features: ['JTU', 'ãƒ­ãƒ³ã‚°'] },
                { id: 'jtu_yokohama_2026', name: 'ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã‚·ãƒªãƒ¼ã‚ºæ¨ªæµœå¤§ä¼š', date: '2026-05-16', location: 'ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚', country: 'æ—¥æœ¬', distance: 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰', category: 'JTUå›½éš›å¤§ä¼š', source: 'JTU', url: 'https://yokohamatriathlon.jp/', description: 'WTSã‚·ãƒªãƒ¼ã‚ºæˆ¦', features: ['WTS', 'å›½éš›'] },
                { id: 'jtu_sado_2026', name: 'ä½æ¸¡å›½éš›ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³å¤§ä¼š', date: '2026-09-06', location: 'æ–°æ½ŸçœŒä½æ¸¡å¸‚', country: 'æ—¥æœ¬', distance: 'ãƒ­ãƒ³ã‚°', category: 'JTUé¸æ‰‹æ¨©', source: 'JTU', url: 'https://www.scsf.jp/', description: 'æ—¥æœ¬ãƒ­ãƒ³ã‚°é¸æ‰‹æ¨©', features: ['JTUé¸æ‰‹æ¨©', 'ãƒ­ãƒ³ã‚°'] },
                { id: 'lumina_shonan_2026', name: 'æ¹˜å—å›½éš›ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³', date: '2026-05-17', location: 'ç¥å¥ˆå·çœŒè—¤æ²¢å¸‚', country: 'æ—¥æœ¬', distance: 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰', category: 'LUMINAå¤§ä¼š', source: 'LUMINA', url: '#', description: 'é–¢æ±æœ€å¤§ç´š', features: ['LUMINA'] },
                { id: 'ironman_japan_2026', name: 'IRONMAN Japan South Hokkaido', date: '2026-09-13', location: 'åŒ—æµ·é“', country: 'æ—¥æœ¬', distance: 'ãƒ­ãƒ³ã‚°', category: 'IRONMAN', source: 'IRONMAN', url: 'https://www.ironman.com/', description: 'æ—¥æœ¬å”¯ä¸€ã®ãƒ•ãƒ«ã‚¢ã‚¤ã‚¢ãƒ³ãƒãƒ³', features: ['IRONMAN', 'ãƒ­ãƒ³ã‚°'] },
                { id: 'ironman703_japan_2026', name: 'IRONMAN 70.3 Japan', date: '2026-11-01', location: 'æ„›çŸ¥çœŒ', country: 'æ—¥æœ¬', distance: 'ãƒŸãƒ‰ãƒ«', category: 'IRONMAN 70.3', source: 'IRONMAN', url: 'https://www.ironman.com/', description: 'IRONMAN 70.3 æ—¥æœ¬å¤§ä¼š', features: ['IRONMAN 70.3', 'ãƒŸãƒ‰ãƒ«'] },
                { id: 'ironman_kona_2026', name: 'IRONMAN World Championship', date: '2026-10-10', location: 'Kona, Hawaii', country: 'ã‚¢ãƒ¡ãƒªã‚«', distance: 'ãƒ­ãƒ³ã‚°', category: 'World Championship', source: 'IRONMAN', url: 'https://www.ironman.com/', description: 'ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã®æœ€é«˜å³°', features: ['Kona', 'World Championship'] },
                { id: 'challenge_taiwan_2026', name: 'Challenge Taiwan', date: '2026-04-26', location: 'Taitung', country: 'å°æ¹¾', distance: 'ãƒ­ãƒ³ã‚°', category: 'Challenge Family', source: 'Challenge', url: 'https://challengefamily.com/', description: 'ã‚¢ã‚¸ã‚¢æœ€å¤§ç´šã®ãƒ­ãƒ³ã‚°å¤§ä¼š', features: ['Challenge', 'ã‚¢ã‚¸ã‚¢'] },
                { id: 'challenge_roth_2026', name: 'DATEV Challenge Roth', date: '2026-07-05', location: 'Roth', country: 'ãƒ‰ã‚¤ãƒ„', distance: 'ãƒ­ãƒ³ã‚°', category: 'Challenge Family', source: 'Challenge', url: 'https://challengefamily.com/', description: 'ä¸–ç•Œæœ€å¤§ã®ãƒ­ãƒ³ã‚°å¤§ä¼š', features: ['Challenge', 'Roth'] },
                { id: 't100_singapore_2026', name: 'T100 Singapore', date: '2026-02-28', location: 'Singapore', country: 'ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«', distance: 'T100', category: 'T100 World Tour', source: 'T100', url: 'https://t100triathlon.com/', description: 'PTO T100ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ„ã‚¢ãƒ¼', features: ['T100', 'ã‚¢ã‚¸ã‚¢'] },
                { id: 'xterra_japan_2026', name: 'XTERRA Japan', date: '2026-05-16', location: 'é•·é‡çœŒ', country: 'æ—¥æœ¬', distance: 'ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰', category: 'XTERRA', source: 'XTERRA', url: 'https://www.xterrajapan.com/', description: 'ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³', features: ['XTERRA', 'MTB'] }
            ];
        }
        
        async function refreshRaces() {
            localStorage.removeItem('races_cache');
            await fetchRacesFromAPI();
        }
        
        function toggleSource(source) {
            const badge = document.querySelector('.source-badge[data-source="' + source + '"]');
            if (activeSources.has(source)) {
                activeSources.delete(source);
                badge.classList.remove('active');
            } else {
                activeSources.add(source);
                badge.classList.add('active');
            }
            filterRaces();
        }
        
        function updateStats() {
            document.getElementById('total-count').textContent = races.length;
            document.getElementById('japan-count').textContent = races.filter(r => r.country === 'æ—¥æœ¬').length;
            document.getElementById('overseas-count').textContent = races.filter(r => r.country !== 'æ—¥æœ¬').length;
        }
        
        function filterRaces() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const selectedMonth = document.getElementById('month-select').value;
            const selectedRegion = document.getElementById('region-select').value;
            const selectedDistance = document.getElementById('distance-select').value;
            
            filteredRaces = races.filter(race => {
                if (!activeSources.has(race.source.toLowerCase())) return false;
                const matchesSearch = !searchTerm || race.name.toLowerCase().includes(searchTerm) || race.location.toLowerCase().includes(searchTerm);
                const matchesMonth = !selectedMonth || race.date.substring(5, 7) === selectedMonth;
                let matchesRegion = true;
                if (selectedRegion === 'japan') matchesRegion = race.country === 'æ—¥æœ¬';
                else if (selectedRegion === 'overseas') matchesRegion = race.country !== 'æ—¥æœ¬';
                else if (selectedRegion === 'asia') matchesRegion = ['æ—¥æœ¬', 'å°æ¹¾', 'éŸ“å›½', 'ãƒ•ã‚£ãƒªãƒ”ãƒ³', 'ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«', 'ã‚¿ã‚¤', 'ãƒãƒ¬ãƒ¼ã‚·ã‚¢'].includes(race.country);
                const matchesDistance = !selectedDistance || race.distance === selectedDistance || (selectedDistance === 'ãƒŸãƒ‰ãƒ«' && race.distance.includes('70.3'));
                return matchesSearch && matchesMonth && matchesRegion && matchesDistance;
            });
            
            document.getElementById('filtered-count').textContent = filteredRaces.length;
            document.getElementById('search-result').textContent = filteredRaces.length + ' ä»¶ã®å¤§ä¼š';
            renderRaces();
        }
        
        function renderRaces() {
            const container = document.getElementById('races-container');
            if (filteredRaces.length === 0) {
                container.innerHTML = '<div class="no-results"><h3>è©²å½“ã™ã‚‹å¤§ä¼šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h3><p>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</p></div>';
                return;
            }
            container.innerHTML = filteredRaces.map(race => {
                const selectionState = selectedRaces.aRaces.has(race.id) ? 'a-race' : selectedRaces.otherRaces.has(race.id) ? 'other-race' : null;
                const cardClass = selectionState ? 'race-card selected-' + selectionState : 'race-card';
                const selectionBadge = selectionState ? '<div class="selection-badge ' + selectionState + '">' + (selectionState === 'a-race' ? 'ğŸ† Aãƒ¬ãƒ¼ã‚¹' : 'ğŸª ãã®ä»–') + '</div>' : '';
                const catClass = 'category-' + race.source.toLowerCase();
                const features = (race.features || []).map(f => '<span class="feature-tag">' + f + '</span>').join('');
                const date = new Date(race.date).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
                
                return '<div class="' + cardClass + '" data-id="' + race.id + '">' + selectionBadge +
                    '<div class="race-content">' +
                    '<div class="race-header"><span class="category-badge ' + catClass + '">' + race.source + '</span><span class="category-badge">' + race.category + '</span></div>' +
                    '<h3 class="race-title">' + race.name + '</h3>' +
                    '<div class="race-info"><div>ğŸ“… ' + date + '</div><div>ğŸ“ ' + race.location + (race.country !== 'æ—¥æœ¬' ? ' (' + race.country + ')' : '') + '</div></div>' +
                    '<div class="distance-badges"><span class="distance-badge">' + race.distance + '</span></div>' +
                    '<div class="race-features">' + features + '</div>' +
                    '<p style="font-size:11px;color:#6b7280;margin-bottom:10px;">' + (race.description || '') + '</p>' +
                    '<div class="race-actions">' +
                    '<a href="' + race.url + '" target="_blank" class="race-button">ğŸ”— å…¬å¼ã‚µã‚¤ãƒˆ</a>' +
                    '<div class="selection-buttons">' +
                    '<button class="selection-button a-race' + (selectionState === 'a-race' ? ' active' : '') + '" onclick="selectRace(\'' + race.id + '\', \'a-race\')">ğŸ† Aãƒ¬ãƒ¼ã‚¹</button>' +
                    '<button class="selection-button other-race' + (selectionState === 'other-race' ? ' active' : '') + '" onclick="selectRace(\'' + race.id + '\', \'other-race\')">ğŸª ãã®ä»–</button>' +
                    (selectionState ? '<button class="selection-button remove" onclick="removeSelection(\'' + race.id + '\')">âŒ</button>' : '') +
                    '</div></div></div></div>';
            }).join('');
        }
        
        function selectRace(raceId, type) {
            selectedRaces.aRaces.delete(raceId);
            selectedRaces.otherRaces.delete(raceId);
            if (type === 'a-race') selectedRaces.aRaces.add(raceId);
            else if (type === 'other-race') selectedRaces.otherRaces.add(raceId);
            updateSelectionStats();
            renderRaces();
        }
        
        function removeSelection(raceId) {
            selectedRaces.aRaces.delete(raceId);
            selectedRaces.otherRaces.delete(raceId);
            updateSelectionStats();
            renderRaces();
        }
        
        function updateSelectionStats() {
            const total = selectedRaces.aRaces.size + selectedRaces.otherRaces.size;
            document.getElementById('a-race-count').textContent = selectedRaces.aRaces.size;
            document.getElementById('other-race-count').textContent = selectedRaces.otherRaces.size;
            const btn = document.getElementById('goal-setting-button');
            btn.disabled = total === 0;
            btn.textContent = total > 0 ? 'ğŸ¯ ç›®æ¨™è¨­å®šãƒšãƒ¼ã‚¸ã¸ (' + total + 'å¤§ä¼š)' : 'ğŸ¯ ç›®æ¨™è¨­å®šãƒšãƒ¼ã‚¸ã¸é€²ã‚€';
        }
        
        function goToGoalSetting() {
            const data = { aRaces: [...selectedRaces.aRaces], otherRaces: [...selectedRaces.otherRaces], raceDetails: {} };
            [...selectedRaces.aRaces, ...selectedRaces.otherRaces].forEach(id => {
                const race = races.find(r => r.id === id);
                if (race) data.raceDetails[id] = race;
            });
            localStorage.setItem('selected_races', JSON.stringify(data));
            window.location.href = 'goal-setting.html';
        }
        
        document.getElementById('search-input').addEventListener('input', filterRaces);
        document.getElementById('month-select').addEventListener('change', filterRaces);
        document.getElementById('region-select').addEventListener('change', filterRaces);
        document.getElementById('distance-select').addEventListener('change', filterRaces);
    </script>
</body>
</html>
