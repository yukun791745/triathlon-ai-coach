<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ AIã‚³ãƒ¼ãƒ | é‹å‹•ç”Ÿç†å­¦ãƒ™ãƒ¼ã‚¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: calc(100vh - 40px);
        }
        
        .simulator-panel, .chat-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1em;
        }
        
        .form-section {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .results {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 12px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .results h3, .results h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .result-label {
            font-weight: 600;
            color: #555;
            font-size: 0.85em;
        }
        
        .result-value {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .current-value {
            color: #666;
            font-size: 0.75em;
        }
        
        .improved-value {
            color: #27ae60;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .improvement {
            color: #2980b9;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .info-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            margin-bottom: 20px;
            font-size: 0.85em;
        }
        
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            font-size: 0.85em;
        }
        
        .error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        
        .success {
            background: #e8f5e8;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        .api-setup {
            padding: 20px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 20px;
            border-radius: 8px;
        }
        
        .api-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .api-button {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
            font-weight: 600;
        }
        
        .api-button:hover {
            background: #e0a800;
        }
        
        .deploy-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            width: 100%;
        }
        
        .deploy-button:hover {
            background: #218838;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            max-height: 500px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 12px;
            max-width: 90%;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        
        .ai-message {
            background: white;
            color: #333;
            border: 1px solid #dee2e6;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background: white;
        }
        
        .chat-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            outline: none;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            font-size: 0.9em;
        }
        
        .chat-input:focus {
            border-color: #007bff;
        }
        
        .chat-send-btn {
            position: absolute;
            right: 25px;
            bottom: 27px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .chat-send-btn:hover {
            background: #0056b3;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-loading { background: #ffc107; }
        
        .code-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            overflow-x: auto;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="simulator-panel">
            <div class="header">
                <h1>ğŸŠâ€â™‚ï¸ğŸš´â€â™‚ï¸ğŸƒâ€â™‚ï¸ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
                <p>é‹å‹•ç”Ÿç†å­¦ã«åŸºã¥ãæ”¹å–„äºˆæ¸¬</p>
            </div>
            
            <div class="form-section">
                <div class="info-text">
                    <strong>ğŸ“Š æ¡ä»¶ï¼š</strong> 8-12é€±é–“ã®æŒä¹…ç³»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å¾Œã®æ”¹å–„äºˆæ¸¬
                </div>
                
                <div id="messages"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="age">å¹´é½¢</label>
                        <input type="number" id="age" min="18" max="80" value="30">
                    </div>
                    <div class="form-group">
                        <label for="gender">æ€§åˆ¥</label>
                        <select id="gender">
                            <option value="male" selected>ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vo2max">VO2max (ml/kg/min)</label>
                        <input type="number" id="vo2max" min="30" max="80" step="0.1" value="50">
                    </div>
                    <div class="form-group">
                        <label for="ltPercent">LT (%VO2max)</label>
                        <input type="number" id="ltPercent" min="60" max="95" step="1" value="85">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ltPace">LTãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒšãƒ¼ã‚¹ (åˆ†:ç§’/km)</label>
                    <input type="text" id="ltPace" placeholder="ä¾‹: 4:30" value="4:30">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="genetics">éºä¼å­å‹æ”¹å–„åŠ¹æœ</label>
                        <select id="genetics">
                            <option value="H">H (é«˜å¿œç­”æ€§)</option>
                            <option value="M" selected>M (ä¸­å¿œç­”æ€§)</option>
                            <option value="L">L (ä½å¿œç­”æ€§)</option>
                            <option value="unknown">ä¸æ˜</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="level">ç«¶æŠ€ãƒ¬ãƒ™ãƒ«</label>
                        <select id="level">
                            <option value="elite">ã‚¨ãƒªãƒ¼ãƒˆ</option>
                            <option value="trained" selected>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è€…</option>
                            <option value="untrained">éãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è€…</option>
                        </select>
                    </div>
                </div>
                
                <button type="button" onclick="runSimulation()" class="calculate-btn">ğŸ§® æ”¹å–„åŠ¹æœã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                
                <div id="results" class="results">
                    <h3>ğŸ“ˆ æ”¹å–„äºˆæ¸¬çµæœ</h3>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
        
        <div class="chat-panel">
            <div class="header chat-header">
                <h1>ğŸ¤– AIãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã‚³ãƒ¼ãƒ</h1>
                <p><span id="connectionStatus" class="status-indicator status-error"></span>é‹å‹•ç”Ÿç†å­¦åšå£«ã«ã‚ˆã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹</p>
            </div>
            
            <div id="apiSetup" class="api-setup">
                <strong>ğŸš€ å®Ÿéš›ã®AIæ¥ç¶šã®ãŸã‚ã®æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</strong>
                <p>CORSåˆ¶é™ã«ã‚ˆã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥OpenAI APIã«æ¥ç¶šã§ããªã„ã“ã¨ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚</p>
                
                <div style="margin: 15px 0; padding: 15px; background: #e8f4fd; border-radius: 6px;">
                    <strong>ğŸ“‹ ç¢ºèªã•ã‚ŒãŸAPIã‚­ãƒ¼:</strong><br>
                    <code>sk-proj-UeWIFWcZl4WT...ï¼ˆæœ‰åŠ¹ï¼‰</code><br><br>
                    <strong>âŒ å•é¡Œ:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ã®CORSåˆ¶é™<br>
                    <strong>âœ… è§£æ±ºç­–:</strong> ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å®Ÿè£…
                </div>
                
                <h4>ğŸ”§ Vercel Functionsã«ã‚ˆã‚‹å®Ÿè£…æ‰‹é †:</h4>
                
                <div class="code-box">
<strong>1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ :</strong>
triathlon-ai-coach/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ openai.js
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.html
â”œâ”€â”€ package.json
â””â”€â”€ vercel.json
                </div>
                
                <div class="code-box">
<strong>2. api/openai.js:</strong>
export default async function handler(req, res) {
  const { message, apiKey, systemPrompt } = req.body;
  
  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: message }
      ],
      max_tokens: 1500,
      temperature: 0.7
    })
  });
  
  const data = await response.json();
  res.json(data);
}
                </div>
                
                <div class="code-box">
<strong>3. ä¿®æ­£ã•ã‚ŒãŸAIå‘¼ã³å‡ºã—:</strong>
fetch('/api/openai', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    message: userMessage,
    apiKey: apiKey,
    systemPrompt: systemPrompt
  })
})
                </div>
                
                <button onclick="showDeployInstructions()" class="deploy-button">
                    ğŸ“¦ è©³ç´°ãªãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã‚’è¡¨ç¤º
                </button>
                
                <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 6px; font-size: 0.85em;">
                    <strong>â±ï¸ å®Ÿè£…æ™‚é–“:</strong> ç´„10-15åˆ†<br>
                    <strong>ğŸ’° ã‚³ã‚¹ãƒˆ:</strong> Vercelç„¡æ–™ãƒ—ãƒ©ãƒ³åˆ©ç”¨å¯èƒ½<br>
                    <strong>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:</strong> APIã‚­ãƒ¼ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®‰å…¨ã«å‡¦ç†
                </div>
                
                <hr style="margin: 20px 0;">
                
                <input type="password" id="apiKeyInput" class="api-input" placeholder="OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ› (sk-proj-...)">
                
                <button onclick="enableDemoMode()" class="api-button">
                    ğŸ¯ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å°‚é–€çš„AIã‚³ãƒ¼ãƒã‚’ä½“é¨“
                </button>
                <p style="font-size: 0.8em; margin-top: 10px; color: #6c757d;">
                    ç¾åœ¨ã¯é«˜å“è³ªãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã§é‹å‹•ç”Ÿç†å­¦ã®å°‚é–€çŸ¥è­˜ã‚’æä¾›ã—ã¾ã™
                </p>
            </div>
            
            <div id="chatMessages" class="chat-messages" style="display: none;">
                <div class="ai-message">
                    <strong>AIã‚³ãƒ¼ãƒ</strong><br>
                    ã“ã‚“ã«ã¡ã¯ï¼é‹å‹•ç”Ÿç†å­¦åšå£«ã®AIã‚³ãƒ¼ãƒã§ã™ã€‚ğŸŠâ€â™‚ï¸ğŸš´â€â™‚ï¸ğŸƒâ€â™‚ï¸<br>
                    ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®è©³ç´°è§£èª¬ã‚„ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«é–¢ã™ã‚‹å°‚é–€çš„ãªè³ªå•ã«ãŠç­”ãˆã—ã¾ã™ã€‚
                </div>
            </div>
            
            <div id="chatInputArea" class="chat-input-area" style="display: none;">
                <div style="position: relative;">
                    <textarea id="chatInput" class="chat-input" placeholder="è³ªå•ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." rows="1" onkeypress="handleEnter(event)"></textarea>
                    <button onclick="sendMessage()" class="chat-send-btn">â¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        var isAIConnected = false;
        var lastResults = null;
        
        // æ­£ç¢ºãªé‹å‹•ç”Ÿç†å­¦è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        function calculateVO2maxImprovement(vo2max, genetics, age, gender) {
            var vo2maxStandardsMale = {
                '20-29': { '25th': 39, '75th': 48.5 },
                '30-39': { '25th': 37.8, '75th': 47 },
                '40-49': { '25th': 35.9, '75th': 44.9 },
                '50-59': { '25th': 32.8, '75th': 41.8 },
                '60-69': { '25th': 29.5, '75th': 38.3 },
                '70-79': { '25th': 26.9, '75th': 35.2 }
            };
            
            var vo2maxStandardsFemale = {
                '20-29': { '25th': 33, '75th': 42.4 },
                '30-39': { '25th': 32, '75th': 41 },
                '40-49': { '25th': 30.2, '75th': 38.6 },
                '50-59': { '25th': 28, '75th': 35.2 },
                '60-69': { '25th': 25.1, '75th': 32.3 },
                '70-79': { '25th': 24.2, '75th': 29.8 }
            };
            
            var upsideMatrix = {
                'H-g': { 'H-v': 3, 'M-v': 4, 'L-v': 5 },
                'M-g': { 'H-v': 2, 'M-v': 3, 'L-v': 4 },
                'L-g': { 'H-v': 1, 'M-v': 2, 'L-v': 3 }
            };
            
            var vo2maxImprovementRates = { 1: 5, 2: 7, 3: 10, 4: 12, 5: 14 };
            
            function getAgeGroup(age) {
                if (age >= 20 && age <= 29) return '20-29';
                if (age >= 30 && age <= 39) return '30-39';
                if (age >= 40 && age <= 49) return '40-49';
                if (age >= 50 && age <= 59) return '50-59';
                if (age >= 60 && age <= 69) return '60-69';
                return '70-79';
            }
            
            function classifyVO2maxLevel(currentVO2max, age, gender) {
                var ageGroup = getAgeGroup(age);
                var standards = gender === 'male' ? vo2maxStandardsMale : vo2maxStandardsFemale;
                var ageStandards = standards[ageGroup];
                
                if (currentVO2max >= ageStandards['75th']) return 'H-v';
                if (currentVO2max < ageStandards['25th']) return 'L-v';
                return 'M-v';
            }
            
            var vo2maxLevel = classifyVO2maxLevel(vo2max, age, gender);
            var geneticsKey = (genetics === 'unknown' ? 'M' : genetics) + '-g';
            var upsideScore = upsideMatrix[geneticsKey][vo2maxLevel];
            var improvementRate = vo2maxImprovementRates[upsideScore];
            
            return vo2max + (vo2max * improvementRate / 100);
        }
        
        function calculateLTImprovement(currentLT, genetics, level, age, gender) {
            var ltStandardsMale = {
                '20-29': { lower: 65, upper: 72 },
                '30-39': { lower: 68, upper: 75 },
                '40-49': { lower: 72, upper: 78 },
                '50-59': { lower: 75, upper: 80 },
                '60-69': { lower: 78, upper: 82 },
                '70-79': { lower: 80, upper: 85 }
            };
            
            var ltStandardsFemale = {
                '20-29': { lower: 67.5, upper: 74.5 },
                '30-39': { lower: 70.5, upper: 77.5 },
                '40-49': { lower: 74.5, upper: 80.5 },
                '50-59': { lower: 77.5, upper: 82.5 },
                '60-69': { lower: 80.5, upper: 84.5 },
                '70-79': { lower: 82.5, upper: 87.5 }
            };
            
            var ltImprovementRates = { 'H-l': 1, 'M-l': 3, 'L-l': 5 };
            
            function getAgeGroup(age) {
                if (age >= 20 && age <= 29) return '20-29';
                if (age >= 30 && age <= 39) return '30-39';
                if (age >= 40 && age <= 49) return '40-49';
                if (age >= 50 && age <= 59) return '50-59';
                if (age >= 60 && age <= 69) return '60-69';
                return '70-79';
            }
            
            var ageGroup = getAgeGroup(age);
            var standards = gender === 'male' ? ltStandardsMale : ltStandardsFemale;
            var ageStandards = standards[ageGroup];
            
            var ltLevel;
            if (currentLT >= ageStandards.upper) ltLevel = 'H-l';
            else if (currentLT < ageStandards.lower) ltLevel = 'L-l';
            else ltLevel = 'M-l';
            
            return Math.min(90, currentLT + ltImprovementRates[ltLevel]);
        }
        
        function calculateRunningEconomyImprovement(currentVO2max, currentLT, ltPace, level, improvedVO2max, improvedLT) {
            var reImprovementRates = { 'H-r': 0.02, 'M-r': 0.04, 'L-r': 0.06 };
            
            var currentVO2AtLT = currentVO2max * (currentLT / 100);
            var ltPaceMinutes = paceToMinutes(ltPace);
            var currentRE = currentVO2AtLT * ltPaceMinutes;
            
            var reLevel = level === 'elite' ? 'H-r' : level === 'trained' ? 'M-r' : 'L-r';
            var improvementRate = reImprovementRates[reLevel];
            var improvedRE = currentRE * (1 - improvementRate);
            var improvedVO2AtLT = improvedVO2max * (improvedLT / 100);
            var improvedLTPaceMinutes = improvedRE / improvedVO2AtLT;
            
            return {
                improvedPace: minutesToPace(improvedLTPaceMinutes),
                improvementSeconds: (ltPaceMinutes - improvedLTPaceMinutes) * 60,
                improvedLTPaceMinutes: improvedLTPaceMinutes
            };
        }
        
        function predictRaceTimesAccurate(ltPaceMinutes, age, gender, level) {
            if (!ltPaceMinutes || isNaN(ltPaceMinutes) || ltPaceMinutes <= 0) {
                return { '5K': 'ã‚¨ãƒ©ãƒ¼', '10K': 'ã‚¨ãƒ©ãƒ¼', 'Half': 'ã‚¨ãƒ©ãƒ¼', 'Marathon': 'ã‚¨ãƒ©ãƒ¼' };
            }
            
            var ltPaceSeconds = ltPaceMinutes * 60;
            var baseTimes = {
                '5K': ltPaceSeconds - 15,
                '10K': ltPaceSeconds - 7,
                'Half': ltPaceSeconds + 12,
                'Marathon': ltPaceSeconds + 30
            };
            
            function personalizedAdjustment(basePaceSeconds, age, gender, level, distance) {
                var adjustment = 1.0;
                
                if (age > 40) {
                    var ageBonus = { '5K': 1.005, '10K': 1.000, 'Half': 0.995, 'Marathon': 0.990 };
                    adjustment *= ageBonus[distance];
                }
                
                if (gender === 'female') {
                    var genderBonus = { '5K': 1.010, '10K': 1.005, 'Half': 0.998, 'Marathon': 0.995 };
                    adjustment *= genderBonus[distance];
                }
                
                if (level === 'elite') adjustment *= 0.98;
                else if (level === 'untrained') adjustment *= 1.02;
                
                return basePaceSeconds * adjustment;
            }
            
            var adjustedTimes = {};
            for (var distance in baseTimes) {
                adjustedTimes[distance] = personalizedAdjustment(baseTimes[distance], age, gender, level, distance);
            }
            
            var distances = { '5K': 5, '10K': 10, 'Half': 21.0975, 'Marathon': 42.195 };
            var raceTimes = {};
            for (var distance in distances) {
                var totalSeconds = adjustedTimes[distance] * distances[distance];
                raceTimes[distance] = formatRaceTime(totalSeconds);
            }
            
            return raceTimes;
        }
        
        function formatRaceTime(totalSeconds) {
            if (isNaN(totalSeconds)) return 'ã‚¨ãƒ©ãƒ¼';
            var hours = Math.floor(totalSeconds / 3600);
            var minutes = Math.floor((totalSeconds % 3600) / 60);
            var seconds = Math.round(totalSeconds % 60);
            
            if (hours > 0) {
                return hours + ':' + (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            } else {
                return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            }
        }
        
        function paceToMinutes(paceStr) {
            var parts = paceStr.split(':');
            return parseInt(parts[0]) + parseInt(parts[1]) / 60;
        }
        
        function minutesToPace(minutes) {
            var min = Math.floor(minutes);
            var sec = Math.round((minutes - min) * 60);
            return min + ':' + (sec < 10 ? '0' : '') + sec;
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showMessage(message, type) {
            var container = document.getElementById('messages');
            var div = document.createElement('div');
            div.className = 'message ' + type;
            div.textContent = message;
            container.appendChild(div);
            
            setTimeout(function() {
                if (div.parentNode) {
                    div.parentNode.removeChild(div);
                }
            }, 5000);
        }
        
        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        function runSimulation() {
            console.log('Running simulation...');
            
            var age = parseInt(document.getElementById('age').value);
            var gender = document.getElementById('gender').value;
            var vo2max = parseFloat(document.getElementById('vo2max').value);
            var ltPercent = parseInt(document.getElementById('ltPercent').value);
            var ltPace = document.getElementById('ltPace').value;
            var genetics = document.getElementById('genetics').value;
            var level = document.getElementById('level').value;
            
            if (!age || !gender || !vo2max || !ltPercent || !ltPace || !genetics || !level) {
                showMessage('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (ltPace.indexOf(':') === -1) {
                showMessage('LTãƒšãƒ¼ã‚¹ã¯ã€Œåˆ†:ç§’ã€ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            try {
                var improvedVO2max = calculateVO2maxImprovement(vo2max, genetics, age, gender);
                var improvedLT = calculateLTImprovement(ltPercent, genetics, level, age, gender);
                var runningEconomyResult = calculateRunningEconomyImprovement(
                    vo2max, ltPercent, ltPace, level, improvedVO2max, improvedLT
                );
                
                var currentRaceTimes = predictRaceTimesAccurate(paceToMinutes(ltPace), age, gender, level);
                var improvedRaceTimes = predictRaceTimesAccurate(
                    runningEconomyResult.improvedLTPaceMinutes, age, gender, level
                );
                
                var results = {
                    current: {
                        vo2max: vo2max,
                        ltPercent: ltPercent,
                        ltPace: ltPace,
                        raceTimes: currentRaceTimes
                    },
                    improved: {
                        vo2max: improvedVO2max,
                        ltPercent: improvedLT,
                        ltPace: runningEconomyResult.improvedPace,
                        raceTimes: improvedRaceTimes
                    },
                    improvements: {
                        vo2max: improvedVO2max - vo2max,
                        ltPercent: improvedLT - ltPercent,
                        ltPaceSeconds: runningEconomyResult.improvementSeconds
                    }
                };
                
                displayResults(results);
                lastResults = results;
                
                if (isAIConnected) {
                    setTimeout(function() {
                        analyzeResults(results);
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Simulation error:', error);
                showMessage('è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }
        
        // çµæœè¡¨ç¤º
        function displayResults(results) {
            var container = document.getElementById('resultsContent');
            
            container.innerHTML = 
                '<div class="result-item">' +
                    '<span class="result-label">ğŸ« VO2max</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.vo2max + ' ml/kg/min</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.vo2max.toFixed(1) + ' ml/kg/min</span>' +
                        '<span class="improvement">+' + results.improvements.vo2max.toFixed(1) + ' ml/kg/min</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">âš¡ ä¹³é…¸é–¾å€¤(LT)</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.ltPercent + '% VO2max</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.ltPercent + '% VO2max</span>' +
                        '<span class="improvement">+' + results.improvements.ltPercent + '%</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">ğŸƒâ€â™‚ï¸ LTãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒšãƒ¼ã‚¹</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.ltPace + '/km</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.ltPace + '/km</span>' +
                        '<span class="improvement">-' + Math.abs(results.improvements.ltPaceSeconds).toFixed(0) + 'ç§’/km</span>' +
                    '</div>' +
                '</div>' +
                
                '<h4>ğŸ ãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ äºˆæ¸¬</h4>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">5K</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.raceTimes['5K'] + '</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.raceTimes['5K'] + '</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">10K</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.raceTimes['10K'] + '</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.raceTimes['10K'] + '</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">ãƒãƒ¼ãƒ•ãƒãƒ©ã‚½ãƒ³</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.raceTimes['Half'] + '</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.raceTimes['Half'] + '</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">ãƒ•ãƒ«ãƒãƒ©ã‚½ãƒ³</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.raceTimes['Marathon'] + '</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.raceTimes['Marathon'] + '</span>' +
                    '</div>' +
                '</div>';
            
            document.getElementById('results').style.display = 'block';
            showMessage('ğŸ‰ è¨ˆç®—å®Œäº†ï¼AIã‚³ãƒ¼ãƒã®è©³ç´°åˆ†æã‚’ãŠå¾…ã¡ãã ã•ã„', 'success');
        }
        
        // ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †è¡¨ç¤º
        function showDeployInstructions() {
            var modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;';
            
            var content = document.createElement('div');
            content.style.cssText = 'background:white;padding:30px;border-radius:10px;max-width:90%;max-height:80%;overflow-y:auto;';
            
            content.innerHTML = `
                <h2>ğŸš€ Vercel Functionså®Ÿè£…æ‰‹é †</h2>
                
                <h3>1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæº–å‚™</h3>
                <div class="code-box">
mkdir triathlon-ai-coach
cd triathlon-ai-coach
npm init -y
                </div>
                
                <h3>2. package.json</h3>
                <div class="code-box">
{
  "name": "triathlon-ai-coach",
  "version": "1.0.0",
  "scripts": {
    "dev": "vercel dev",
    "build": "vercel build"
  },
  "devDependencies": {
    "vercel": "^32.0.0"
  }
}
                </div>
                
                <h3>3. api/openai.js</h3>
                <div class="code-box">
export default async function handler(req, res) {
  // CORSè¨­å®š
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }
  
  const { message, apiKey, systemPrompt } = req.body;
  
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': \`Bearer \${apiKey}\`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: message }
        ],
        max_tokens: 1500,
        temperature: 0.7
      })
    });
    
    const data = await response.json();
    res.json(data);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}
                </div>
                
                <h3>4. ãƒ‡ãƒ—ãƒ­ã‚¤</h3>
                <div class="code-box">
npx vercel
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¾“ã£ã¦è¨­å®š
# ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã®URLã‚’ãƒ¡ãƒ¢
                </div>
                
                <h3>5. HTMLä¿®æ­£</h3>
                <p>generateAIResponseé–¢æ•°ã‚’ä»¥ä¸‹ã«å¤‰æ›´ï¼š</p>
                <div class="code-box">
fetch('/api/openai', {  // ã¾ãŸã¯ 'https://your-app.vercel.app/api/openai'
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    message: message,
    apiKey: apiKey,
    systemPrompt: systemPrompt
  })
})
                </div>
                
                <button onclick="document.body.removeChild(this.parentElement.parentElement)" 
                        style="margin-top:20px;padding:10px 20px;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;">
                    é–‰ã˜ã‚‹
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–
        function enableDemoMode() {
            var apiKey = getStoredAPIKey();
            
            if (!apiKey || !apiKey.startsWith('sk-')) {
                showMessage('æœ‰åŠ¹ãªOpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            isAIConnected = true;
            document.getElementById('apiSetup').style.display = 'none';
            document.getElementById('chatMessages').style.display = 'block';
            document.getElementById('chatInputArea').style.display = 'block';
            document.getElementById('connectionStatus').className = 'status-indicator status-connected';
            
            showMessage('âœ… Vercel FunctionsçµŒç”±ã§OpenAI APIã«æ¥ç¶šæº–å‚™å®Œäº†ï¼', 'success');
            
            addChatMessage('ai', 'ğŸš€ <strong>Vercel Functions + OpenAI APIæ¥ç¶šæº–å‚™å®Œäº†</strong><br><br>' +
                          'ã“ã‚“ã«ã¡ã¯ï¼é‹å‹•ç”Ÿç†å­¦åšå£«ã®AIã‚³ãƒ¼ãƒã§ã™ã€‚ğŸŠâ€â™‚ï¸ğŸš´â€â™‚ï¸ğŸƒâ€â™‚ï¸<br><br>' +
                          'Vercel FunctionsçµŒç”±ã§å®Ÿéš›ã®OpenAI APIã«æ¥ç¶šã—ã€ä»¥ä¸‹ã®å°‚é–€åˆ†é‡ã«ã¤ã„ã¦ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸè©³ç´°ãªå›ç­”ã‚’æä¾›ã—ã¾ã™ï¼š<br><br>' +
                          'â€¢ é‹å‹•ç”Ÿç†å­¦ã®æœ€æ–°ç ”ç©¶ã«åŸºã¥ãè§£æ<br>' +
                          'â€¢ å€‹åˆ¥åŒ–ã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç†è«–<br>' +
                          'â€¢ ç§‘å­¦çš„å¦¥å½“æ€§ã‚’é‡è¦–ã—ãŸå°‚é–€çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹<br>' +
                          'â€¢ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®è©³ç´°ãªè§£èª¬<br><br>' +
                          '**ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã«ã‚ˆã£ã¦ï¼š**<br>' +
                          'â€¢ âœ… Vercel Functionç¨¼åƒä¸­ â†’ å®Ÿéš›ã®AIå›ç­”<br>' +
                          'â€¢ âŒ æœªãƒ‡ãƒ—ãƒ­ã‚¤ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ â†’ é«˜å“è³ªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯<br><br>' +
                          'ã©ã¡ã‚‰ã®å ´åˆã‚‚å°‚é–€çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ï¼');
        }
        
        // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addChatMessage(sender, content) {
            var container = document.getElementById('chatMessages');
            var div = document.createElement('div');
            div.className = 'chat-message ' + sender + '-message';
            
            if (sender === 'ai') {
                div.innerHTML = '<strong>AIã‚³ãƒ¼ãƒ</strong><br>' + content;
            } else {
                div.innerHTML = content;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        // çµæœåˆ†æ
        function analyzeResults(results) {
            var analysis = 'ğŸ“Š <strong>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®è©³ç´°åˆ†æ</strong><br><br>';
            
            analysis += '<strong>ğŸ« VO2maxåˆ†æ</strong><br>';
            analysis += 'æ”¹å–„å¹…: ' + results.improvements.vo2max.toFixed(1) + ' ml/kg/min (' + 
                       ((results.improvements.vo2max / results.current.vo2max) * 100).toFixed(1) + '%å‘ä¸Š)<br>';
            
            if (results.improvements.vo2max > 5) {
                analysis += 'ã“ã®æ”¹å–„ã¯å„ªç§€ã§ã€éºä¼çš„è¦å› ã¨ç¾åœ¨ã®ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ãƒ¬ãƒ™ãƒ«ãŒå‘ä¸Šã«æœ‰åˆ©ã«åƒã„ã¦ã„ã¾ã™ã€‚<br><br>';
            } else if (results.improvements.vo2max > 2) {
                analysis += 'ã“ã®æ”¹å–„ã¯æ¨™æº–çš„ã§ã€ç¶™ç¶šçš„ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚Šç€å®Ÿãªå‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚<br><br>';
            } else {
                analysis += 'ã“ã®æ”¹å–„å¹…ã¯æ§ãˆã‚ã§ã™ãŒã€æ—¢ã«é«˜ã„ãƒ¬ãƒ™ãƒ«ã«ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br><br>';
            }
            
            analysis += '<strong>âš¡ ä¹³é…¸é–¾å€¤åˆ†æ</strong><br>';
            analysis += 'LTæ”¹å–„: ' + results.improvements.ltPercent + '% VO2maxå‘ä¸Š<br>';
            analysis += 'ã‚ˆã‚Šé«˜ã„å¼·åº¦ã§é•·æ™‚é–“é‹å‹•ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€æŒä¹…æ€§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå¤§å¹…ã«æ”¹å–„ã•ã‚Œã¾ã™ã€‚<br><br>';
            
            analysis += '<strong>ğŸƒâ€â™‚ï¸ ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒšãƒ¼ã‚¹åˆ†æ</strong><br>';
            analysis += 'LTãƒšãƒ¼ã‚¹æ”¹å–„: ' + Math.abs(results.improvements.ltPaceSeconds).toFixed(0) + 'ç§’/kmçŸ­ç¸®<br>';
            analysis += 'ã“ã®æ”¹å–„ã¯ãƒ¬ãƒ¼ã‚¹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ç›´æ¥çš„ãªå½±éŸ¿ã‚’ä¸ãˆã€ç«¶æŠ€åŠ›å‘ä¸Šã«ã¤ãªãŒã‚Šã¾ã™ã€‚<br><br>';
            
            analysis += '<strong>ğŸ ãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ æ”¹å–„åŠ¹æœ</strong><br>';
            analysis += 'â€¢ 5K: ' + results.current.raceTimes['5K'] + ' â†’ ' + results.improved.raceTimes['5K'] + '<br>';
            analysis += 'â€¢ 10K: ' + results.current.raceTimes['10K'] + ' â†’ ' + results.improved.raceTimes['10K'] + '<br>';
            analysis += 'â€¢ ãƒãƒ¼ãƒ•: ' + results.current.raceTimes['Half'] + ' â†’ ' + results.improved.raceTimes['Half'] + '<br>';
            analysis += 'â€¢ ãƒ•ãƒ«: ' + results.current.raceTimes['Marathon'] + ' â†’ ' + results.improved.raceTimes['Marathon'] + '<br><br>';
            
            analysis += '<strong>ğŸ“ˆ æ¨å¥¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æˆ¦ç•¥</strong><br>';
            if (results.improvements.vo2max > 4) {
                analysis += '1. é€±2-3å›ã®é«˜å¼·åº¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼ˆVO2maxã®85-95%ï¼‰<br>';
                analysis += '2. LTå¼·åº¦ã§ã®æŒç¶šèµ°ï¼ˆé€±1-2å›ã€20-40åˆ†ï¼‰<br>';
                analysis += '3. ãƒ­ãƒ³ã‚°èµ°ï¼ˆé€±1å›ã€æœ‰é…¸ç´ ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ï¼‰<br>';
            } else {
                analysis += '1. LTå¼·åº¦ã§ã®æŒç¶šèµ°ã‚’é‡è¦–ï¼ˆ80-85% HRmaxï¼‰<br>';
                analysis += '2. æ®µéšçš„ãªè·é›¢å¢—åŠ ï¼ˆé€±10%ãƒ«ãƒ¼ãƒ«ï¼‰<br>';
                analysis += '3. ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„ã¨ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼å‘ä¸Š<br>';
            }
            analysis += '<br>ã“ã‚Œã‚‰ã®æ”¹å–„ã¯8-12é€±é–“ã®æ§‹é€ åŒ–ã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å®Ÿç¾å¯èƒ½ã§ã™ã€‚';
            
            addChatMessage('ai', analysis);
        }
        
        // å°‚é–€çš„AIå¿œç­”ç”Ÿæˆ - Vercel Functionsç‰ˆ
        function generateExpertResponse(message) {
            return new Promise(function(resolve, reject) {
                var systemPrompt = `ã‚ãªãŸã¯é‹å‹•ç”Ÿç†å­¦ã®åšå£«å·ã‚’æŒã¤ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³å°‚é–€ã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®å°‚é–€çŸ¥è­˜ã‚’æ´»ç”¨ã—ã¦ã€ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸå®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ï¼š

ã€å°‚é–€åˆ†é‡ã€‘
- é‹å‹•ç”Ÿç†å­¦ï¼ˆVO2maxã€ä¹³é…¸é–¾å€¤ã€ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼ï¼‰
- ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ç«¶æŠ€ç‰¹æœ‰ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç†è«–
- ã‚¹ãƒãƒ¼ãƒ„æ „é¤Šå­¦ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ãƒã‚¤ã‚ªãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹ã¨ãƒ•ã‚©ãƒ¼ãƒ åˆ†æ
- ç–²åŠ´å›å¾©ã¨ãƒ”ãƒ¼ã‚­ãƒ³ã‚°æˆ¦ç•¥
- éºä¼çš„è¦å› ã¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å¿œç­”æ€§

ã€å›ç­”æ–¹é‡ã€‘
1. å¿…ãšç§‘å­¦çš„æ ¹æ‹ ï¼ˆç ”ç©¶è«–æ–‡ã€ç”Ÿç†å­¦çš„ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ï¼‰ã‚’å«ã‚ã‚‹
2. å…·ä½“çš„ã§å®Ÿè·µå¯èƒ½ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›
3. å€‹äººå·®ã¨å®‰å…¨æ€§ã‚’å¸¸ã«è€ƒæ…®
4. æœ€æ–°ã®é‹å‹•ç”Ÿç†å­¦ç ”ç©¶ã‚’åæ˜ 
5. å°‚é–€ç”¨èªã‚’ä½¿ã„ã¤ã¤åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜

ç¾åœ¨ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ: ${lastResults ? JSON.stringify(lastResults) : 'æœªå®Ÿè¡Œ'}`;

                // Vercel Functionsã‚’ä½¿ç”¨ã—ã¦APIå‘¼ã³å‡ºã—
                var apiEndpoint = '/api/chat';
                
                console.log('Calling Vercel Function:', apiEndpoint);
                
                fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        apiKey: getStoredAPIKey(),
                        systemPrompt: systemPrompt,
                        simulationResults: lastResults
                    })
                })
                .then(function(response) {
                    console.log('Vercel Function response status:', response.status);
                    
                    if (!response.ok) {
                        return response.json().then(function(errorData) {
                            throw new Error(errorData.error || 'API Error: ' + response.status);
                        });
                    }
                    
                    return response.json();
                })
                .then(function(data) {
                    console.log('AI response received:', data);
                    
                    if (data.reply) {
                        resolve('ğŸ”— **å®Ÿéš›ã®OpenAI APIã‹ã‚‰ã®å›ç­”:**\n\n' + data.reply);
                    } else if (data.choices && data.choices[0] && data.choices[0].message) {
                        resolve('ğŸ”— **å®Ÿéš›ã®OpenAI APIã‹ã‚‰ã®å›ç­”:**\n\n' + data.choices[0].message.content);
                    } else {
                        throw new Error('Invalid API response format');
                    }
                })
                .catch(function(error) {
                    console.error('AI Response Error:', error);
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                    var errorMessage = '';
                    if (error.message.includes('401')) {
                        errorMessage = 'APIã‚­ãƒ¼ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚';
                    } else if (error.message.includes('429')) {
                        errorMessage = 'APIåˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                    } else if (error.message.includes('404')) {
                        errorMessage = 'Vercel Function ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else {
                        errorMessage = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                    }
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
                    var fallbackResponse = generateStaticExpertResponse(message);
                    resolve(fallbackResponse + '\n\n---\n**ğŸ”§ æ¥ç¶šçŠ¶æ³:** ' + errorMessage);
                });
            });
        }
        
        // APIã‚­ãƒ¼ä¿å­˜ãƒ»å–å¾—
        function getStoredAPIKey() {
            return document.getElementById('apiKeyInput') ? document.getElementById('apiKeyInput').value.trim() : '';
        }
        
        // é™çš„ãªå°‚é–€çš„å¿œç­”ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        function generateStaticExpertResponse(message) {
            var msg = message.toLowerCase();
            
            if (msg.indexOf('vo2max') !== -1 || msg.indexOf('æœ€å¤§é…¸ç´ æ‘‚å–é‡') !== -1) {
                return '**VO2maxï¼ˆæœ€å¤§é…¸ç´ æ‘‚å–é‡ï¼‰ã®ç§‘å­¦çš„è§£æ**\n\n' +
                       '**å®šç¾©ã¨é‡è¦æ€§ï¼š**\n' +
                       'VO2maxã¯1åˆ†é–“ã«ä½“é‡1kgã‚ãŸã‚ŠãŒæ‘‚å–ãƒ»åˆ©ç”¨ã§ãã‚‹é…¸ç´ ã®æœ€å¤§é‡ï¼ˆml/kg/minï¼‰ã§ã€å¿ƒè¡€ç®¡ç³»ã¨ç­‹ä»£è¬èƒ½åŠ›ã‚’åæ˜ ã™ã‚‹æŒä¹…åŠ›ã®æœ€é‡è¦æŒ‡æ¨™ã§ã™ã€‚\n\n' +
                       '**ç”Ÿç†å­¦çš„æ±ºå®šå› å­ï¼š**\n' +
                       '1. **ä¸­å¤®å¾ªç’°ç³»**ï¼šå¿ƒæ‹å‡ºé‡ï¼ˆå¿ƒæ‹æ•°Ã—1å›æ‹å‡ºé‡ï¼‰\n' +
                       '2. **æœ«æ¢¢å¾ªç’°ç³»**ï¼šç­‹è¡€æµåˆ†å¸ƒã¨æ¯›ç´°è¡€ç®¡å¯†åº¦\n' +
                       '3. **ç­‹ä»£è¬ç³»**ï¼šãƒŸãƒˆã‚³ãƒ³ãƒ‰ãƒªã‚¢å¯†åº¦ã¨é…¸åŒ–é…µç´ æ´»æ€§\n\n' +
                       '**ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã§ã®åŸºæº–å€¤ï¼ˆml/kg/minï¼‰ï¼š**\n' +
                       'â€¢ ã‚¨ãƒªãƒ¼ãƒˆç”·æ€§ï¼š65-75\n' +
                       'â€¢ ã‚¨ãƒªãƒ¼ãƒˆå¥³æ€§ï¼š55-65\n' +
                       'â€¢ ç«¶æŠ€ãƒ¬ãƒ™ãƒ«ç”·æ€§ï¼š50-65\n' +
                       'â€¢ ç«¶æŠ€ãƒ¬ãƒ™ãƒ«å¥³æ€§ï¼š45-55\n\n' +
                       '**ç§‘å­¦çš„æ”¹å–„æˆ¦ç•¥ï¼š**\n' +
                       'Heritage Family Studyï¼ˆ1999-2000ï¼‰ã«ã‚ˆã‚‹ã¨ã€VO2maxã®æ”¹å–„å¿œç­”æ€§ã«ã¯éºä¼çš„è¦å› ãŒå¤§ããå½±éŸ¿ã—ã¾ã™ï¼š\n' +
                       'â€¢ é«˜å¿œç­”ç¾¤ï¼š15-20%æ”¹å–„\n' +
                       'â€¢ ä¸­å¿œç­”ç¾¤ï¼š8-12%æ”¹å–„\n' +
                       'â€¢ ä½å¿œç­”ç¾¤ï¼š3-5%æ”¹å–„\n\n' +
                       '**å®Ÿè·µçš„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å‡¦æ–¹ï¼š**\n' +
                       '1. **é«˜å¼·åº¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«**ï¼š90-95% HRmaxã€4-8åˆ†Ã—3-5æœ¬\n' +
                       '2. **ä¸­å¼·åº¦æŒç¶š**ï¼š80-85% HRmaxã€20-40åˆ†\n' +
                       '3. **é »åº¦**ï¼šé€±2-3å›ã€8-12é€±é–“\n\n' +
                       'å¹´é½¢ã«ã‚ˆã‚‹ä½ä¸‹ç‡ã¯å¹´é–“ç´„1%ã§ã™ãŒã€é©åˆ‡ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚Šç¶­æŒãƒ»å‘ä¸ŠãŒå¯èƒ½ã§ã™ã€‚';
            }
            
            if (msg.indexOf('ä¹³é…¸é–¾å€¤') !== -1 || msg.indexOf('lt') !== -1) {
                return '**ä¹³é…¸é–¾å€¤ï¼ˆLactate Thresholdï¼‰ã®ç§‘å­¦çš„è§£æ**\n\n' +
                       '**ç”Ÿç†å­¦çš„ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ï¼š**\n' +
                       'ä¹³é…¸é–¾å€¤ã¯è¡€ä¸­ä¹³é…¸æ¿ƒåº¦ãŒæŒ‡æ•°é–¢æ•°çš„ã«ä¸Šæ˜‡ã—å§‹ã‚ã‚‹é‹å‹•å¼·åº¦ã§ã€æœ‰é…¸ç´ ä»£è¬ã‹ã‚‰ç„¡é…¸ç´ ä»£è¬ã¸ã®ç§»è¡Œç‚¹ã‚’ç¤ºã—ã¾ã™ã€‚\n\n' +
                       '**LTã®æ±ºå®šå› å­ï¼š**\n' +
                       '1. **ç­‹ç·šç¶­çµ„æˆ**ï¼šType Iç·šç¶­ï¼ˆé…ç­‹ï¼‰ã®å‰²åˆ\n' +
                       '2. **ãƒŸãƒˆã‚³ãƒ³ãƒ‰ãƒªã‚¢å¯†åº¦**ï¼šé…¸åŒ–çš„ãƒªãƒ³é…¸åŒ–èƒ½åŠ›\n' +
                       '3. **æ¯›ç´°è¡€ç®¡å¯†åº¦**ï¼šé…¸ç´ ä¾›çµ¦åŠ¹ç‡\n' +
                       '4. **ä¹³é…¸é™¤å»èƒ½åŠ›**ï¼šè‚è‡“ã§ã®ä¹³é…¸ä»£è¬\n\n' +
                       '**æ¸¬å®šæ–¹æ³•ã¨åŸºæº–ï¼š**\n' +
                       'â€¢ **LT1**ï¼š2mmol/Lï¼ˆæœ‰é…¸ç´ é–¾å€¤ï¼‰\n' +
                       'â€¢ **LT2**ï¼š4mmol/Lï¼ˆç„¡é…¸ç´ é–¾å€¤ï¼‰\n' +
                       'â€¢ **%VO2max**ï¼šé€šå¸¸80-90%ã§ç™ºç”Ÿ\n\n' +
                       '**ç§‘å­¦çš„æ”¹å–„æˆ¦ç•¥ï¼š**\n' +
                       'Laursen & Jenkins (2002) ã®ãƒ¡ã‚¿è§£æã«ã‚ˆã‚‹ã¨ï¼š\n' +
                       '1. **ãƒ†ãƒ³ãƒèµ°**ï¼šLTå¼·åº¦ã§20-40åˆ†ã€é€±2-3å›\n' +
                       '2. **ã‚¹ã‚¤ãƒ¼ãƒˆã‚¹ãƒãƒƒãƒˆ**ï¼šLT1-LT2é–“ã§ã®ç·´ç¿’\n' +
                       '3. **ãƒãƒ©ãƒ©ã‚¤ã‚ºãƒ‰**ï¼šä½å¼·åº¦80% + é«˜å¼·åº¦20%\n\n' +
                       'æ”¹å–„ã«ã‚ˆã‚Šã€åŒã˜ä¹³é…¸æ¿ƒåº¦ã§ã‚ˆã‚Šé«˜ã„å¼·åº¦ã§ã®é‹å‹•ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚';
            }
            
            return '**é‹å‹•ç”Ÿç†å­¦ã«åŸºã¥ãå°‚é–€çš„å›ç­”**\n\n' +
                   'ã”è³ªå•ã«ã¤ã„ã¦ã€ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ã¦ãŠç­”ãˆã—ã¾ã™ã€‚ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Šã«ã¯ã€ä»¥ä¸‹ã®ç”Ÿç†å­¦çš„è¦å› ã®çµ±åˆçš„ãªç†è§£ãŒé‡è¦ã§ã™ï¼š\n\n' +
                   '**1. ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ï¼š**\n' +
                   'â€¢ æœ‰é…¸ç´ ç³»ï¼ˆãƒŸãƒˆã‚³ãƒ³ãƒ‰ãƒªã‚¢å‘¼å¸ï¼‰\n' +
                   'â€¢ ç„¡é…¸ç´ ç³»ï¼ˆè§£ç³–ç³» + ãƒªãƒ³é…¸ç³»ï¼‰\n' +
                   'â€¢ è„‚è³ªãƒ»ç³–è³ªä»£è¬ã®æœ€é©åŒ–\n\n' +
                   '**2. ç¥çµŒç­‹ç³»ï¼š**\n' +
                   'â€¢ é‹å‹•å˜ä½å‹•å“¡ãƒ‘ã‚¿ãƒ¼ãƒ³\n' +
                   'â€¢ ç­‹ç·šç¶­å‹åˆ†å¸ƒã¨é©å¿œ\n' +
                   'â€¢ ç¥çµŒç­‹å”èª¿æ€§\n\n' +
                   '**3. å¿ƒè¡€ç®¡ç³»ï¼š**\n' +
                   'â€¢ å¿ƒæ‹å‡ºé‡ã¨æœ«æ¢¢è¡€æµ\n' +
                   'â€¢ é…¸ç´ é‹æ¬ãƒ»æŠ½å‡ºèƒ½åŠ›\n' +
                   'â€¢ è¡€ç®¡æ–°ç”Ÿã¨æ¯›ç´°è¡€ç®¡å¯†åº¦\n\n' +
                   'ã‚ˆã‚Šå…·ä½“çš„ãªè³ªå•ã‚’ã„ãŸã ã‘ã‚Œã°ã€è©³ç´°ãªç§‘å­¦çš„è§£æã¨å®Ÿè·µçš„ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å‡¦æ–¹ã‚’æä¾›ã§ãã¾ã™ã€‚';
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ - Vercel Functionså¯¾å¿œç‰ˆ
        function sendMessage() {
            if (!isAIConnected) {
                showMessage('å…ˆã«AIã‚³ãƒ¼ãƒã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            var input = document.getElementById('chatInput');
            var message = input.value.trim();
            if (!message) return;
            
            addChatMessage('user', message);
            input.value = '';
            
            // å®Ÿéš›ã®AIå¿œç­”ã‚’å–å¾—ï¼ˆVercel FunctionsçµŒç”±ï¼‰
            generateExpertResponse(message)
                .then(function(response) {
                    addChatMessage('ai', response.replace(/\n/g, '<br>'));
                })
                .catch(function(error) {
                    console.error('AI Response Error:', error);
                    addChatMessage('ai', 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚AIæ¥ç¶šã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br><br>' +
                                        '**å¯èƒ½ãªåŸå› ï¼š**<br>' +
                                        'â€¢ APIã‚­ãƒ¼ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ<br>' +
                                        'â€¢ Vercel Functionã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼<br>' +
                                        'â€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å•é¡Œ<br><br>' +
                                        'ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã¨APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                });
        }
        
        // Enterã‚­ãƒ¼å‡¦ç†
        function handleEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        console.log('Triathlon AI Coach (Vercel Ready) loaded successfully!');
    </script>
</body>
</html>
            
