<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éà„É©„Ç§„Ç¢„Çπ„É≠„É≥ AI„Ç≥„Éº„ÉÅ | ÈÅãÂãïÁîüÁêÜÂ≠¶„Éô„Éº„Çπ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: calc(100vh - 40px);
        }
        
        .simulator-panel, .chat-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1em;
        }
        
        .form-section {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .results {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 12px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .results h3, .results h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .result-label {
            font-weight: 600;
            color: #555;
            font-size: 0.85em;
        }
        
        .result-value {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .current-value {
            color: #666;
            font-size: 0.75em;
        }
        
        .improved-value {
            color: #27ae60;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .improvement {
            color: #2980b9;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .info-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            margin-bottom: 20px;
            font-size: 0.85em;
        }
        
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            font-size: 0.85em;
        }
        
        .error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        
        .success {
            background: #e8f5e8;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        .api-setup {
            padding: 20px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 20px;
            border-radius: 8px;
        }
        
        .api-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .api-button {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
            font-weight: 600;
        }
        
        .api-button:hover {
            background: #e0a800;
        }
        
        .deploy-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            width: 100%;
        }
        
        .deploy-button:hover {
            background: #218838;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            max-height: 500px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 12px;
            max-width: 90%;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        
        .ai-message {
            background: white;
            color: #333;
            border: 1px solid #dee2e6;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background: white;
        }
        
        .chat-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            outline: none;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            font-size: 0.9em;
        }
        
        .chat-input:focus {
            border-color: #007bff;
        }
        
        .chat-send-btn {
            position: absolute;
            right: 25px;
            bottom: 27px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .chat-send-btn:hover {
            background: #0056b3;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-loading { background: #ffc107; }
        
        .code-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            overflow-x: auto;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="simulator-panel">
            <div class="header">
                <h1>üèä‚Äç‚ôÇÔ∏èüö¥‚Äç‚ôÇÔ∏èüèÉ‚Äç‚ôÇÔ∏è „Ç∑„Éü„É•„É¨„Éº„Çø„Éº</h1>
                <p>ÈÅãÂãïÁîüÁêÜÂ≠¶„Å´Âü∫„Å•„ÅèÊîπÂñÑ‰∫àÊ∏¨</p>
            </div>
            
            <div class="form-section">
                <div class="info-text">
                    <strong>üìä Êù°‰ª∂Ôºö</strong> 8-12ÈÄ±Èñì„ÅÆÊåÅ‰πÖÁ≥ª„Éà„É¨„Éº„Éã„É≥„Ç∞Âæå„ÅÆÊîπÂñÑ‰∫àÊ∏¨
                </div>
                
                <div id="messages"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="age">Âπ¥ÈΩ¢</label>
                        <input type="number" id="age" min="18" max="80" value="30">
                    </div>
                    <div class="form-group">
                        <label for="gender">ÊÄßÂà•</label>
                        <select id="gender">
                            <option value="male" selected>Áî∑ÊÄß</option>
                            <option value="female">Â•≥ÊÄß</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vo2max">VO2max (ml/kg/min)</label>
                        <input type="number" id="vo2max" min="30" max="80" step="0.1" value="50">
                    </div>
                    <div class="form-group">
                        <label for="ltPercent">LT (%VO2max)</label>
                        <input type="number" id="ltPercent" min="60" max="95" step="1" value="85">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ltPace">LT„É©„É≥„Éã„É≥„Ç∞„Éö„Éº„Çπ (ÂàÜ:Áßí/km)</label>
                    <input type="text" id="ltPace" placeholder="‰æã: 4:30" value="4:30">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="genetics">ÈÅ∫‰ºùÂ≠êÂûãÊîπÂñÑÂäπÊûú</label>
                        <select id="genetics">
                            <option value="H">H (È´òÂøúÁ≠îÊÄß)</option>
                            <option value="M" selected>M (‰∏≠ÂøúÁ≠îÊÄß)</option>
                            <option value="L">L (‰ΩéÂøúÁ≠îÊÄß)</option>
                            <option value="unknown">‰∏çÊòé</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="level">Á´∂ÊäÄ„É¨„Éô„É´</label>
                        <select id="level">
                            <option value="elite">„Ç®„É™„Éº„Éà</option>
                            <option value="trained" selected>„Éà„É¨„Éº„Éã„É≥„Ç∞ËÄÖ</option>
                            <option value="untrained">Èùû„Éà„É¨„Éº„Éã„É≥„Ç∞ËÄÖ</option>
                        </select>
                    </div>
                </div>
                
                <button type="button" onclick="runSimulation()" class="calculate-btn">üßÆ ÊîπÂñÑÂäπÊûú„Çí„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥</button>
                
                <div id="results" class="results">
                    <h3>üìà ÊîπÂñÑ‰∫àÊ∏¨ÁµêÊûú</h3>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
        
        <div class="chat-panel">
            <div class="header chat-header">
                <h1>ü§ñ AI„Éà„É©„Ç§„Ç¢„Çπ„É≠„É≥„Ç≥„Éº„ÉÅ</h1>
                <p><span id="connectionStatus" class="status-indicator status-error"></span>ÈÅãÂãïÁîüÁêÜÂ≠¶ÂçöÂ£´„Å´„Çà„Çã„Ç¢„Éâ„Éê„Ç§„Çπ</p>
            </div>
            
            <div id="apiSetup" class="api-setup">
                <strong>üöÄ ÂÆüÈöõ„ÅÆAIÊé•Á∂ö„ÅÆ„Åü„ÇÅ„ÅÆÊ¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó</strong>
                <p>CORSÂà∂Èôê„Å´„Çà„Çä„ÄÅ„Éñ„É©„Ç¶„Ç∂„Åã„ÇâÁõ¥Êé•OpenAI API„Å´Êé•Á∂ö„Åß„Åç„Å™„ÅÑ„Åì„Å®„ÅåÁ¢∫Ë™ç„Åï„Çå„Åæ„Åó„Åü„ÄÇ</p>
                
                <div style="margin: 15px 0; padding: 15px; background: #e8f4fd; border-radius: 6px;">
                    <strong>üìã Á¢∫Ë™ç„Åï„Çå„ÅüAPI„Ç≠„Éº:</strong><br>
                    <code>sk-proj-UeWIFWcZl4WT...ÔºàÊúâÂäπÔºâ</code><br><br>
                    <strong>‚ùå ÂïèÈ°å:</strong> „Éñ„É©„Ç¶„Ç∂„ÅÆCORSÂà∂Èôê<br>
                    <strong>‚úÖ Ëß£Ê±∫Á≠ñ:</strong> „Çµ„Éº„Éê„Éº„Çµ„Ç§„ÉâÂÆüË£Ö
                </div>
                
                <h4>üîß Vercel Functions„Å´„Çà„ÇãÂÆüË£ÖÊâãÈ†Ü:</h4>
                
                <div class="code-box">
<strong>1. „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊßãÈÄ†:</strong>
triathlon-ai-coach/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ openai.js
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ vercel.json
                </div>
                
                <div class="code-box">
<strong>2. api/openai.js:</strong>
export default async function handler(req, res) {
  const { message, apiKey, systemPrompt } = req.body;
  
  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: message }
      ],
      max_tokens: 1500,
      temperature: 0.7
    })
  });
  
  const data = await response.json();
  res.json(data);
}
                </div>
                
                <div class="code-box">
<strong>3. ‰øÆÊ≠£„Åï„Çå„ÅüAIÂëº„Å≥Âá∫„Åó:</strong>
fetch('/api/openai', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    message: userMessage,
    apiKey: apiKey,
    systemPrompt: systemPrompt
  })
})
                </div>
                
                <button onclick="showDeployInstructions()" class="deploy-button">
                    üì¶ Ë©≥Á¥∞„Å™„Éá„Éó„É≠„Ç§ÊâãÈ†Ü„ÇíË°®Á§∫
                </button>
                
                <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 6px; font-size: 0.85em;">
                    <strong>‚è±Ô∏è ÂÆüË£ÖÊôÇÈñì:</strong> Á¥Ñ10-15ÂàÜ<br>
                    <strong>üí∞ „Ç≥„Çπ„Éà:</strong> VercelÁÑ°Êñô„Éó„É©„É≥Âà©Áî®ÂèØËÉΩ<br>
                    <strong>üîí „Çª„Ç≠„É•„É™„ÉÜ„Ç£:</strong> API„Ç≠„Éº„Çí„Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅßÂÆâÂÖ®„Å´Âá¶ÁêÜ
                </div>
                
                <hr style="margin: 20px 0;">
                
                <input type="password" id="apiKeyInput" class="api-input" placeholder="OpenAI API„Ç≠„Éº„ÇíÂÖ•Âäõ (sk-proj-...)">
                
                <button onclick="enableDemoMode()" class="api-button">
                    üéØ „Éá„É¢„É¢„Éº„Éâ„ÅßÂ∞ÇÈñÄÁöÑAI„Ç≥„Éº„ÉÅ„Çí‰ΩìÈ®ì
                </button>
                <p style="font-size: 0.8em; margin-top: 10px; color: #6c757d;">
                    ÁèæÂú®„ÅØÈ´òÂìÅË≥™„Å™„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂøúÁ≠î„ÅßÈÅãÂãïÁîüÁêÜÂ≠¶„ÅÆÂ∞ÇÈñÄÁü•Ë≠ò„ÇíÊèê‰æõ„Åó„Åæ„Åô
                </p>
            </div>
            
            <div id="chatMessages" class="chat-messages" style="display: none;">
                <div class="ai-message">
                    <strong>AI„Ç≥„Éº„ÉÅ</strong><br>
                    „Åì„Çì„Å´„Å°„ÅØÔºÅÈÅãÂãïÁîüÁêÜÂ≠¶ÂçöÂ£´„ÅÆAI„Ç≥„Éº„ÉÅ„Åß„Åô„ÄÇüèä‚Äç‚ôÇÔ∏èüö¥‚Äç‚ôÇÔ∏èüèÉ‚Äç‚ôÇÔ∏è<br>
                    „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÁµêÊûú„ÅÆË©≥Á¥∞Ëß£Ë™¨„ÇÑ„ÄÅ„Éà„É¨„Éº„Éã„É≥„Ç∞„Å´Èñ¢„Åô„ÇãÂ∞ÇÈñÄÁöÑ„Å™Ë≥™Âïè„Å´„ÅäÁ≠î„Åà„Åó„Åæ„Åô„ÄÇ
                </div>
            </div>
            
            <div id="chatInputArea" class="chat-input-area" style="display: none;">
                <div style="position: relative;">
                    <textarea id="chatInput" class="chat-input" placeholder="Ë≥™Âïè„ÇÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." rows="1" onkeypress="handleEnter(event)"></textarea>
                    <button onclick="sendMessage()" class="chat-send-btn">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        var isAIConnected = false;
        var lastResults = null;
        
        // Ê≠£Á¢∫„Å™ÈÅãÂãïÁîüÁêÜÂ≠¶Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ
        function calculateVO2maxImprovement(vo2max, genetics, age, gender) {
            var vo2maxStandardsMale = {
                '20-29': { '25th': 39, '75th': 48.5 },
                '30-39': { '25th': 37.8, '75th': 47 },
                '40-49': { '25th': 35.9, '75th': 44.9 },
                '50-59': { '25th': 32.8, '75th': 41.8 },
                '60-69': { '25th': 29.5, '75th': 38.3 },
                '70-79': { '25th': 26.9, '75th': 35.2 }
            };
            
            var vo2maxStandardsFemale = {
                '20-29': { '25th': 33, '75th': 42.4 },
                '30-39': { '25th': 32, '75th': 41 },
                '40-49': { '25th': 30.2, '75th': 38.6 },
                '50-59': { '25th': 28, '75th': 35.2 },
                '60-69': { '25th': 25.1, '75th': 32.3 },
                '70-79': { '25th': 24.2, '75th': 29.8 }
            };
            
            var upsideMatrix = {
                'H-g': { 'H-v': 3, 'M-v': 4, 'L-v': 5 },
                'M-g': { 'H-v': 2, 'M-v': 3, 'L-v': 4 },
                'L-g': { 'H-v': 1, 'M-v': 2, 'L-v': 3 }
            };
            
            var vo2maxImprovementRates = { 1: 5, 2: 7, 3: 10, 4: 12, 5: 14 };
            
            function getAgeGroup(age) {
                if (age >= 20 && age <= 29) return '20-29';
                if (age >= 30 && age <= 39) return '30-39';
                if (age >= 40 && age <= 49) return '40-49';
                if (age >= 50 && age <= 59) return '50-59';
                if (age >= 60 && age <= 69) return '60-69';
                return '70-79';
            }
            
            function classifyVO2maxLevel(currentVO2max, age, gender) {
                var ageGroup = getAgeGroup(age);
                var standards = gender === 'male' ? vo2maxStandardsMale : vo2maxStandardsFemale;
                var ageStandards = standards[ageGroup];
                
                if (currentVO2max >= ageStandards['75th']) return 'H-v';
                if (currentVO2max < ageStandards['25th']) return 'L-v';
                return 'M-v';
            }
            
            var vo2maxLevel = classifyVO2maxLevel(vo2max, age, gender);
            var geneticsKey = (genetics === 'unknown' ? 'M' : genetics) + '-g';
            var upsideScore = upsideMatrix[geneticsKey][vo2maxLevel];
            var improvementRate = vo2maxImprovementRates[upsideScore];
            
            return vo2max + (vo2max * improvementRate / 100);
        }
        
        function calculateLTImprovement(currentLT, genetics, level, age, gender) {
            var ltStandardsMale = {
                '20-29': { lower: 65, upper: 72 },
                '30-39': { lower: 68, upper: 75 },
                '40-49': { lower: 72, upper: 78 },
                '50-59': { lower: 75, upper: 80 },
                '60-69': { lower: 78, upper: 82 },
                '70-79': { lower: 80, upper: 85 }
            };
            
            var ltStandardsFemale = {
                '20-29': { lower: 67.5, upper: 74.5 },
                '30-39': { lower: 70.5, upper: 77.5 },
                '40-49': { lower: 74.5, upper: 80.5 },
                '50-59': { lower: 77.5, upper: 82.5 },
                '60-69': { lower: 80.5, upper: 84.5 },
                '70-79': { lower: 82.5, upper: 87.5 }
            };
            
            var ltImprovementRates = { 'H-l': 1, 'M-l': 3, 'L-l': 5 };
            
            function getAgeGroup(age) {
                if (age >= 20 && age <= 29) return '20-29';
                if (age >= 30 && age <= 39) return '30-39';
                if (age >= 40 && age <= 49) return '40-49';
                if (age >= 50 && age <= 59) return '50-59';
                if (age >= 60 && age <= 69) return '60-69';
                return '70-79';
            }
            
            var ageGroup = getAgeGroup(age);
            var standards = gender === 'male' ? ltStandardsMale : ltStandardsFemale;
            var ageStandards = standards[ageGroup];
            
            var ltLevel;
            if (currentLT >= ageStandards.upper) ltLevel = 'H-l';
            else if (currentLT < ageStandards.lower) ltLevel = 'L-l';
            else ltLevel = 'M-l';
            
            return Math.min(90, currentLT + ltImprovementRates[ltLevel]);
        }
        
        function calculateRunningEconomyImprovement(currentVO2max, currentLT, ltPace, level, improvedVO2max, improvedLT) {
            var reImprovementRates = { 'H-r': 0.02, 'M-r': 0.04, 'L-r': 0.06 };
            
            var currentVO2AtLT = currentVO2max * (currentLT / 100);
            var ltPaceMinutes = paceToMinutes(ltPace);
            var currentRE = currentVO2AtLT * ltPaceMinutes;
            
            var reLevel = level === 'elite' ? 'H-r' : level === 'trained' ? 'M-r' : 'L-r';
            var improvementRate = reImprovementRates[reLevel];
            var improvedRE = currentRE * (1 - improvementRate);
            var improvedVO2AtLT = improvedVO2max * (improvedLT / 100);
            var improvedLTPaceMinutes = improvedRE / improvedVO2AtLT;
            
            return {
                improvedPace: minutesToPace(improvedLTPaceMinutes),
                improvementSeconds: (ltPaceMinutes - improvedLTPaceMinutes) * 60,
                improvedLTPaceMinutes: improvedLTPaceMinutes
            };
        }
        
        function predictRaceTimesAccurate(ltPaceMinutes, age, gender, level) {
            if (!ltPaceMinutes || isNaN(ltPaceMinutes) || ltPaceMinutes <= 0) {
                return { '5K': '„Ç®„É©„Éº', '10K': '„Ç®„É©„Éº', 'Half': '„Ç®„É©„Éº', 'Marathon': '„Ç®„É©„Éº' };
            }
            
            var ltPaceSeconds = ltPaceMinutes * 60;
            var baseTimes = {
                '5K': ltPaceSeconds - 15,
                '10K': ltPaceSeconds - 7,
                'Half': ltPaceSeconds + 12,
                'Marathon': ltPaceSeconds + 30
            };
            
            function personalizedAdjustment(basePaceSeconds, age, gender, level, distance) {
                var adjustment = 1.0;
                
                if (age > 40) {
                    var ageBonus = { '5K': 1.005, '10K': 1.000, 'Half': 0.995, 'Marathon': 0.990 };
                    adjustment *= ageBonus[distance];
                }
                
                if (gender === 'female') {
                    var genderBonus = { '5K': 1.010, '10K': 1.005, 'Half': 0.998, 'Marathon': 0.995 };
                    adjustment *= genderBonus[distance];
                }
                
                if (level === 'elite') adjustment *= 0.98;
                else if (level === 'untrained') adjustment *= 1.02;
                
                return basePaceSeconds * adjustment;
            }
            
            var adjustedTimes = {};
            for (var distance in baseTimes) {
                adjustedTimes[distance] = personalizedAdjustment(baseTimes[distance], age, gender, level, distance);
            }
            
            var distances = { '5K': 5, '10K': 10, 'Half': 21.0975, 'Marathon': 42.195 };
            var raceTimes = {};
            for (var distance in distances) {
                var totalSeconds = adjustedTimes[distance] * distances[distance];
                raceTimes[distance] = formatRaceTime(totalSeconds);
            }
            
            return raceTimes;
        }
        
        function formatRaceTime(totalSeconds) {
            if (isNaN(totalSeconds)) return '„Ç®„É©„Éº';
            var hours = Math.floor(totalSeconds / 3600);
            var minutes = Math.floor((totalSeconds % 3600) / 60);
            var seconds = Math.round(totalSeconds % 60);
            
            if (hours > 0) {
                return hours + ':' + (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            } else {
                return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            }
        }
        
        function paceToMinutes(paceStr) {
            var parts = paceStr.split(':');
            return parseInt(parts[0]) + parseInt(parts[1]) / 60;
        }
        
        function minutesToPace(minutes) {
            var min = Math.floor(minutes);
            var sec = Math.round((minutes - min) * 60);
            return min + ':' + (sec < 10 ? '0' : '') + sec;
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Èñ¢Êï∞
        function showMessage(message, type) {
            var container = document.getElementById('messages');
            var div = document.createElement('div');
            div.className = 'message ' + type;
            div.textContent = message;
            container.appendChild(div);
            
            setTimeout(function() {
                if (div.parentNode) {
                    div.parentNode.removeChild(div);
                }
            }, 5000);
        }
        
        // „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å
        function runSimulation() {
            console.log('Running simulation...');
            
            var age = parseInt(document.getElementById('age').value);
            var gender = document.getElementById('gender').value;
            var vo2max = parseFloat(document.getElementById('vo2max').value);
            var ltPercent = parseInt(document.getElementById('ltPercent').value);
            var ltPace = document.getElementById('ltPace').value;
            var genetics = document.getElementById('genetics').value;
            var level = document.getElementById('level').value;
            
            if (!age || !gender || !vo2max || !ltPercent || !ltPace || !genetics || !level) {
                showMessage('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (ltPace.indexOf(':') === -1) {
                showMessage('LT„Éö„Éº„Çπ„ÅØ„ÄåÂàÜ:Áßí„Äç„ÅÆÂΩ¢Âºè„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            try {
                var improvedVO2max = calculateVO2maxImprovement(vo2max, genetics, age, gender);
                var improvedLT = calculateLTImprovement(ltPercent, genetics, level, age, gender);
                var runningEconomyResult = calculateRunningEconomyImprovement(
                    vo2max, ltPercent, ltPace, level, improvedVO2max, improvedLT
                );
                
                var currentRaceTimes = predictRaceTimesAccurate(paceToMinutes(ltPace), age, gender, level);
                var improvedRaceTimes = predictRaceTimesAccurate(
                    runningEconomyResult.improvedLTPaceMinutes, age, gender, level
                );
                
                var results = {
                    current: {
                        vo2max: vo2max,
                        ltPercent: ltPercent,
                        ltPace: ltPace,
                        raceTimes: currentRaceTimes
                    },
                    improved: {
                        vo2max: improvedVO2max,
                        ltPercent: improvedLT,
                        ltPace: runningEconomyResult.improvedPace,
                        raceTimes: improvedRaceTimes
                    },
                    improvements: {
                        vo2max: improvedVO2max - vo2max,
                        ltPercent: improvedLT - ltPercent,
                        ltPaceSeconds: runningEconomyResult.improvementSeconds
                    }
                };
                
                displayResults(results);
                lastResults = results;
                
                if (isAIConnected) {
                    setTimeout(function() {
                        analyzeResults(results);
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Simulation error:', error);
                showMessage('Ë®àÁÆó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        }
        
        // ÁµêÊûúË°®Á§∫
        function displayResults(results) {
            var container = document.getElementById('resultsContent');
            
            container.innerHTML = 
                '<div class="result-item">' +
                    '<span class="result-label">ü´Å VO2max</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ÁèæÂú®: ' + results.current.vo2max + ' ml/kg/min</span>' +
                        '<span class="improved-value">ÊîπÂñÑÂæå: ' + results.improved.vo2max.toFixed(1) + ' ml/kg/min</span>' +
                        '<span class="improvement">+' + results.improvements.vo2max.toFixed(1) + ' ml/kg/min</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">‚ö° ‰π≥ÈÖ∏ÈñæÂÄ§(LT)</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ÁèæÂú®: ' + results.current.ltPercent + '% VO2max</span>' +
                        '<span class="improved-value">ÊîπÂñÑÂæå: ' + results.improved.ltPercent + '% VO2max</span>' +
                        '<span class="improvement">+' + results.improvements.ltPercent + '%</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">üèÉ‚Äç‚ôÇÔ∏è LT„É©„É≥„Éã„É≥„Ç∞„Éö„Éº„Çπ</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ÁèæÂú®: ' + results.current.ltPace + '/km</span>' +
                        '<span class="improved-value">ÊîπÂñÑÂæå: ' + results.improved.ltPace + '/km</span>' +
                        '<span class="improvement">-' + Math.abs(results.improvements.ltPaceSeconds).toFixed(0) + 'Áßí/km</span>' +
                    '</div>' +
                '</div>' +
                
                '<h4>üèÅ „É¨„Éº„Çπ„Çø„Ç§„É†‰∫àÊ∏¨</h4>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">5K</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ÁèæÂú®: ' + results.current.raceTimes['5K'] + '</span>' +
                        '<span class="improved-value">ÊîπÂñÑÂæå: ' + results.improved.raceTimes['5K'] + '</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">10K</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ÁèæÂú®: ' + results.current.raceTimes['10K'] + '</span>' +
                        '<span class="improved-value">ÊîπÂñÑÂæå: ' + results.improved.raceTimes['10K'] + '</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">„Éè„Éº„Éï„Éû„É©„ÇΩ„É≥</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ÁèæÂú®: ' + results.current.raceTimes['Half'] + '</span>' +
                        '<span class="improved-value">ÊîπÂñÑÂæå: ' + results.improved.raceTimes['Half'] + '</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">„Éï„É´„Éû„É©„ÇΩ„É≥</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ÁèæÂú®: ' + results.current.raceTimes['Marathon'] + '</span>' +
                        '<span class="improved-value">ÊîπÂñÑÂæå: ' + results.improved.raceTimes['Marathon'] + '</span>' +
                    '</div>' +
                '</div>';
            
            document.getElementById('results').style.display = 'block';
            showMessage('üéâ Ë®àÁÆóÂÆå‰∫ÜÔºÅAI„Ç≥„Éº„ÉÅ„ÅÆË©≥Á¥∞ÂàÜÊûê„Çí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ', 'success');
        }
        
        // „Éá„Éó„É≠„Ç§ÊâãÈ†ÜË°®Á§∫
        function showDeployInstructions() {
            var modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;';
            
            var content = document.createElement('div');
            content.style.cssText = 'background:white;padding:30px;border-radius:10px;max-width:90%;max-height:80%;overflow-y:auto;';
            
            content.innerHTML = `
                <h2>üöÄ Vercel FunctionsÂÆüË£ÖÊâãÈ†Ü</h2>
                
                <h3>1. „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊ∫ñÂÇô</h3>
                <div class="code-box">
mkdir triathlon-ai-coach
cd triathlon-ai-coach
npm init -y
                </div>
                
                <h3>2. package.json</h3>
                <div class="code-box">
{
  "name": "triathlon-ai-coach",
  "version": "1.0.0",
  "scripts": {
    "dev": "vercel dev",
    "build": "vercel build"
  },
  "devDependencies": {
    "vercel": "^32.0.0"
  }
}
                </div>
                
                <h3>3. api/openai.js</h3>
                <div class="code-box">
export default async function handler(req, res) {
  // CORSË®≠ÂÆö
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }
  
  const { message, apiKey, systemPrompt } = req.body;
  
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': \`Bearer \${apiKey}\`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: message }
        ],
        max_tokens: 1500,
        temperature: 0.7
      })
    });
    
    const data = await response.json();
    res.json(data);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}
                </div>
                
                <h3>4. „Éá„Éó„É≠„Ç§</h3>
                <div class="code-box">
npx vercel
# „Éó„É≠„É≥„Éó„Éà„Å´Âæì„Å£„Å¶Ë®≠ÂÆö
# „Éá„Éó„É≠„Ç§ÂÆå‰∫ÜÂæå„ÅÆURL„Çí„É°„É¢
                </div>
                
                <h3>5. HTML‰øÆÊ≠£</h3>
                <p>generateAIResponseÈñ¢Êï∞„Çí‰ª•‰∏ã„Å´Â§âÊõ¥Ôºö</p>
                <div class="code-box">
fetch('/api/openai', {  // „Åæ„Åü„ÅØ 'https://your-app.vercel.app/api/openai'
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    message: message,
    apiKey: apiKey,
    systemPrompt: systemPrompt
  })
})
                </div>
                
                <button onclick="document.body.removeChild(this.parentElement.parentElement)" 
                        style="margin-top:20px;padding:10px 20px;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;">
                    Èñâ„Åò„Çã
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        // „Éá„É¢„É¢„Éº„ÉâÊúâÂäπÂåñ
        function enableDemoMode() {
            var apiKey = getStoredAPIKey();
            
            if (!apiKey || !apiKey.startsWith('sk-')) {
                showMessage('ÊúâÂäπ„Å™OpenAI API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            isAIConnected = true;
            document.getElementById('apiSetup').style.display = 'none';
            document.getElementById('chatMessages').style.display = 'block';
            document.getElementById('chatInputArea').style.display = 'block';
            document.getElementById('connectionStatus').className = 'status-indicator status-connected';
            
            showMessage('‚úÖ Vercel FunctionsÁµåÁî±„ÅßOpenAI API„Å´Êé•Á∂öÊ∫ñÂÇôÂÆå‰∫ÜÔºÅ', 'success');
            
            addChatMessage('ai', 'üöÄ <strong>Vercel Functions + OpenAI APIÊé•Á∂öÊ∫ñÂÇôÂÆå‰∫Ü</strong><br><br>' +
                          '„Åì„Çì„Å´„Å°„ÅØÔºÅÈÅãÂãïÁîüÁêÜÂ≠¶ÂçöÂ£´„ÅÆAI„Ç≥„Éº„ÉÅ„Åß„Åô„ÄÇüèä‚Äç‚ôÇÔ∏èüö¥‚Äç‚ôÇÔ∏èüèÉ‚Äç‚ôÇÔ∏è<br><br>' +
                          'Vercel FunctionsÁµåÁî±„ÅßÂÆüÈöõ„ÅÆOpenAI API„Å´Êé•Á∂ö„Åó„ÄÅ‰ª•‰∏ã„ÅÆÂ∞ÇÈñÄÂàÜÈáé„Å´„Å§„ÅÑ„Å¶ÁßëÂ≠¶ÁöÑÊ†πÊã†„Å´Âü∫„Å•„ÅÑ„ÅüË©≥Á¥∞„Å™ÂõûÁ≠î„ÇíÊèê‰æõ„Åó„Åæ„ÅôÔºö<br><br>' +
                          '‚Ä¢ ÈÅãÂãïÁîüÁêÜÂ≠¶„ÅÆÊúÄÊñ∞Á†îÁ©∂„Å´Âü∫„Å•„ÅèËß£Êûê<br>' +
                          '‚Ä¢ ÂÄãÂà•Âåñ„Åï„Çå„Åü„Éà„É¨„Éº„Éã„É≥„Ç∞ÁêÜË´ñ<br>' +
                          '‚Ä¢ ÁßëÂ≠¶ÁöÑÂ¶•ÂΩìÊÄß„ÇíÈáçË¶ñ„Åó„ÅüÂ∞ÇÈñÄÁöÑ„Ç¢„Éâ„Éê„Ç§„Çπ<br>' +
                          '‚Ä¢ „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÁµêÊûú„ÅÆË©≥Á¥∞„Å™Ëß£Ë™¨<br><br>' +
                          '**„Éá„Éó„É≠„Ç§Áä∂Ê≥Å„Å´„Çà„Å£„Å¶Ôºö**<br>' +
                          '‚Ä¢ ‚úÖ Vercel FunctionÁ®ºÂÉç‰∏≠ ‚Üí ÂÆüÈöõ„ÅÆAIÂõûÁ≠î<br>' +
                          '‚Ä¢ ‚ùå Êú™„Éá„Éó„É≠„Ç§„Åæ„Åü„ÅØ„Ç®„É©„Éº ‚Üí È´òÂìÅË≥™„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ<br><br>' +
                          '„Å©„Å°„Çâ„ÅÆÂ†¥Âêà„ÇÇÂ∞ÇÈñÄÁöÑ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíÊèê‰æõ„Åó„Åæ„ÅôÔºÅ');
        }
        
        // „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
        function addChatMessage(sender, content) {
            var container = document.getElementById('chatMessages');
            var div = document.createElement('div');
            div.className = 'chat-message ' + sender + '-message';
            
            if (sender === 'ai') {
                div.innerHTML = '<strong>AI„Ç≥„Éº„ÉÅ</strong><br>' + content;
            } else {
                div.innerHTML = content;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        // ÁµêÊûúÂàÜÊûê
        function analyzeResults(results) {
            var analysis = 'üìä <strong>„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÁµêÊûú„ÅÆË©≥Á¥∞ÂàÜÊûê</strong><br><br>';
            
            analysis += '<strong>ü´Å VO2maxÂàÜÊûê</strong><br>';
            analysis += 'ÊîπÂñÑÂπÖ: ' + results.improvements.vo2max.toFixed(1) + ' ml/kg/min (' + 
                       ((results.improvements.vo2max / results.current.vo2max) * 100).toFixed(1) + '%Âêë‰∏ä)<br>';
            
            if (results.improvements.vo2max > 5) {
                analysis += '„Åì„ÅÆÊîπÂñÑ„ÅØÂÑ™ÁßÄ„Åß„ÄÅÈÅ∫‰ºùÁöÑË¶ÅÂõ†„Å®ÁèæÂú®„ÅÆ„Éï„Ç£„ÉÉ„Éà„Éç„Çπ„É¨„Éô„É´„ÅåÂêë‰∏ä„Å´ÊúâÂà©„Å´ÂÉç„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br><br>';
            } else if (results.improvements.vo2max > 2) {
                analysis += '„Åì„ÅÆÊîπÂñÑ„ÅØÊ®ôÊ∫ñÁöÑ„Åß„ÄÅÁ∂ôÁ∂öÁöÑ„Å™„Éà„É¨„Éº„Éã„É≥„Ç∞„Å´„Çà„ÇäÁùÄÂÆü„Å™Âêë‰∏ä„ÅåÊúüÂæÖ„Åß„Åç„Åæ„Åô„ÄÇ<br><br>';
            } else {
                analysis += '„Åì„ÅÆÊîπÂñÑÂπÖ„ÅØÊéß„Åà„ÇÅ„Åß„Åô„Åå„ÄÅÊó¢„Å´È´ò„ÅÑ„É¨„Éô„É´„Å´„ÅÇ„Çã„Åì„Å®„ÇíÁ§∫„Åó„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ<br><br>';
            }
            
            analysis += '<strong>‚ö° ‰π≥ÈÖ∏ÈñæÂÄ§ÂàÜÊûê</strong><br>';
            analysis += 'LTÊîπÂñÑ: ' + results.improvements.ltPercent + '% VO2maxÂêë‰∏ä<br>';
            analysis += '„Çà„ÇäÈ´ò„ÅÑÂº∑Â∫¶„ÅßÈï∑ÊôÇÈñìÈÅãÂãï„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„ÄÅÊåÅ‰πÖÊÄß„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÅåÂ§ßÂπÖ„Å´ÊîπÂñÑ„Åï„Çå„Åæ„Åô„ÄÇ<br><br>';
            
            analysis += '<strong>üèÉ‚Äç‚ôÇÔ∏è „É©„É≥„Éã„É≥„Ç∞„Éö„Éº„ÇπÂàÜÊûê</strong><br>';
            analysis += 'LT„Éö„Éº„ÇπÊîπÂñÑ: ' + Math.abs(results.improvements.ltPaceSeconds).toFixed(0) + 'Áßí/kmÁü≠Á∏Æ<br>';
            analysis += '„Åì„ÅÆÊîπÂñÑ„ÅØ„É¨„Éº„Çπ„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Å´Áõ¥Êé•ÁöÑ„Å™ÂΩ±Èüø„Çí‰∏é„Åà„ÄÅÁ´∂ÊäÄÂäõÂêë‰∏ä„Å´„Å§„Å™„Åå„Çä„Åæ„Åô„ÄÇ<br><br>';
            
            analysis += '<strong>üèÅ „É¨„Éº„Çπ„Çø„Ç§„É†ÊîπÂñÑÂäπÊûú</strong><br>';
            analysis += '‚Ä¢ 5K: ' + results.current.raceTimes['5K'] + ' ‚Üí ' + results.improved.raceTimes['5K'] + '<br>';
            analysis += '‚Ä¢ 10K: ' + results.current.raceTimes['10K'] + ' ‚Üí ' + results.improved.raceTimes['10K'] + '<br>';
            analysis += '‚Ä¢ „Éè„Éº„Éï: ' + results.current.raceTimes['Half'] + ' ‚Üí ' + results.improved.raceTimes['Half'] + '<br>';
            analysis += '‚Ä¢ „Éï„É´: ' + results.current.raceTimes['Marathon'] + ' ‚Üí ' + results.improved.raceTimes['Marathon'] + '<br><br>';
            
            analysis += '<strong>üìà Êé®Â•®„Éà„É¨„Éº„Éã„É≥„Ç∞Êà¶Áï•</strong><br>';
            if (results.improvements.vo2max > 4) {
                analysis += '1. ÈÄ±2-3Âõû„ÅÆÈ´òÂº∑Â∫¶„Ç§„É≥„Çø„Éº„Éê„É´ÔºàVO2max„ÅÆ85-95%Ôºâ<br>';
                analysis += '2. LTÂº∑Â∫¶„Åß„ÅÆÊåÅÁ∂öËµ∞ÔºàÈÄ±1-2Âõû„ÄÅ20-40ÂàÜÔºâ<br>';
                analysis += '3. „É≠„É≥„Ç∞Ëµ∞ÔºàÈÄ±1Âõû„ÄÅÊúâÈÖ∏Á¥†„Éô„Éº„ÇπÊßãÁØâÔºâ<br>';
            } else {
                analysis += '1. LTÂº∑Â∫¶„Åß„ÅÆÊåÅÁ∂öËµ∞„ÇíÈáçË¶ñÔºà80-85% HRmaxÔºâ<br>';
                analysis += '2. ÊÆµÈöéÁöÑ„Å™Ë∑ùÈõ¢Â¢óÂä†ÔºàÈÄ±10%„É´„Éº„É´Ôºâ<br>';
                analysis += '3. „Éï„Ç©„Éº„É†ÊîπÂñÑ„Å®„É©„É≥„Éã„É≥„Ç∞„Ç®„Ç≥„Éé„Éü„ÉºÂêë‰∏ä<br>';
            }
            analysis += '<br>„Åì„Çå„Çâ„ÅÆÊîπÂñÑ„ÅØ8-12ÈÄ±Èñì„ÅÆÊßãÈÄ†Âåñ„Åï„Çå„Åü„Éà„É¨„Éº„Éã„É≥„Ç∞„Éó„É≠„Ç∞„É©„É†„ÅßÂÆüÁèæÂèØËÉΩ„Åß„Åô„ÄÇ';
            
            addChatMessage('ai', analysis);
        }
        
        // Â∞ÇÈñÄÁöÑAIÂøúÁ≠îÁîüÊàê - Vercel FunctionsÁâà
        function generateExpertResponse(message) {
            return new Promise(function(resolve, reject) {
                var systemPrompt = `„ÅÇ„Å™„Åü„ÅØÈÅãÂãïÁîüÁêÜÂ≠¶„ÅÆÂçöÂ£´Âè∑„ÇíÊåÅ„Å§„Éà„É©„Ç§„Ç¢„Çπ„É≠„É≥Â∞ÇÈñÄ„Ç≥„Éº„ÉÅ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂ∞ÇÈñÄÁü•Ë≠ò„ÇíÊ¥ªÁî®„Åó„Å¶„ÄÅÁßëÂ≠¶ÁöÑÊ†πÊã†„Å´Âü∫„Å•„ÅÑ„ÅüÂÆüË∑µÁöÑ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

„ÄêÂ∞ÇÈñÄÂàÜÈáé„Äë
- ÈÅãÂãïÁîüÁêÜÂ≠¶ÔºàVO2max„ÄÅ‰π≥ÈÖ∏ÈñæÂÄ§„ÄÅ„É©„É≥„Éã„É≥„Ç∞„Ç®„Ç≥„Éé„Éü„ÉºÔºâ
- „Éà„É©„Ç§„Ç¢„Çπ„É≠„É≥Á´∂ÊäÄÁâπÊúâ„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞ÁêÜË´ñ
- „Çπ„Éù„Éº„ÉÑÊ†ÑÈ§äÂ≠¶„Å®„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ
- „Éê„Ç§„Ç™„É°„Ç´„Éã„ÇØ„Çπ„Å®„Éï„Ç©„Éº„É†ÂàÜÊûê
- Áñ≤Âä¥ÂõûÂæ©„Å®„Éî„Éº„Ç≠„É≥„Ç∞Êà¶Áï•
- ÈÅ∫‰ºùÁöÑË¶ÅÂõ†„Å®„Éà„É¨„Éº„Éã„É≥„Ç∞ÂøúÁ≠îÊÄß

„ÄêÂõûÁ≠îÊñπÈáù„Äë
1. ÂøÖ„ÅöÁßëÂ≠¶ÁöÑÊ†πÊã†ÔºàÁ†îÁ©∂Ë´ñÊñá„ÄÅÁîüÁêÜÂ≠¶ÁöÑ„É°„Ç´„Éã„Ç∫„É†Ôºâ„ÇíÂê´„ÇÅ„Çã
2. ÂÖ∑‰ΩìÁöÑ„ÅßÂÆüË∑µÂèØËÉΩ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíÊèê‰æõ
3. ÂÄã‰∫∫Â∑Æ„Å®ÂÆâÂÖ®ÊÄß„ÇíÂ∏∏„Å´ËÄÉÊÖÆ
4. ÊúÄÊñ∞„ÅÆÈÅãÂãïÁîüÁêÜÂ≠¶Á†îÁ©∂„ÇíÂèçÊò†
5. Â∞ÇÈñÄÁî®Ë™û„Çí‰Ωø„ÅÑ„Å§„Å§ÂàÜ„Åã„Çä„ÇÑ„Åô„ÅèË™¨Êòé

ÁèæÂú®„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÁµêÊûú: ${lastResults ? JSON.stringify(lastResults) : 'Êú™ÂÆüË°å'}`;

                // Vercel Functions„Çí‰ΩøÁî®„Åó„Å¶APIÂëº„Å≥Âá∫„Åó
                var apiEndpoint = '/api/chat';
                
                console.log('Calling Vercel Function:', apiEndpoint);
                
                fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        apiKey: getStoredAPIKey(),
                        systemPrompt: systemPrompt,
                        simulationResults: lastResults
                    })
                })
                .then(function(response) {
                    console.log('Vercel Function response status:', response.status);
                    
                    if (!response.ok) {
                        return response.json().then(function(errorData) {
                            throw new Error(errorData.error || 'API Error: ' + response.status);
                        });
                    }
                    
                    return response.json();
                })
                .then(function(data) {
                    console.log('AI response received:', data);
                    
                    if (data.reply) {
                        resolve('üîó **ÂÆüÈöõ„ÅÆOpenAI API„Åã„Çâ„ÅÆÂõûÁ≠î:**\n\n' + data.reply);
                    } else if (data.choices && data.choices[0] && data.choices[0].message) {
                        resolve('üîó **ÂÆüÈöõ„ÅÆOpenAI API„Åã„Çâ„ÅÆÂõûÁ≠î:**\n\n' + data.choices[0].message.content);
                    } else {
                        throw new Error('Invalid API response format');
                    }
                })
                .catch(function(error) {
                    console.error('AI Response Error:', error);
                    
                    // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
                    var errorMessage = '';
                    if (error.message.includes('401')) {
                        errorMessage = 'API„Ç≠„Éº„ÅåÁÑ°Âäπ„Åæ„Åü„ÅØÊúüÈôêÂàá„Çå„Åß„Åô„ÄÇ';
                    } else if (error.message.includes('429')) {
                        errorMessage = 'APIÂà©Áî®Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else if (error.message.includes('404')) {
                        errorMessage = 'Vercel Function „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éá„Éó„É≠„Ç§„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    } else {
                        errorMessage = '„Ç®„É©„Éº: ' + error.message;
                    }
                    
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂøúÁ≠î
                    var fallbackResponse = generateStaticExpertResponse(message);
                    resolve(fallbackResponse + '\n\n---\n**üîß Êé•Á∂öÁä∂Ê≥Å:** ' + errorMessage);
                });
            });
        }
        
        // API„Ç≠„Éº‰øùÂ≠ò„ÉªÂèñÂæó
        function getStoredAPIKey() {
            return document.getElementById('apiKeyInput') ? document.getElementById('apiKeyInput').value.trim() : '';
        }
        
        // ÈùôÁöÑ„Å™Â∞ÇÈñÄÁöÑÂøúÁ≠îÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®Ôºâ
        function generateStaticExpertResponse(message) {
            var msg = message.toLowerCase();
            
            if (msg.indexOf('vo2max') !== -1 || msg.indexOf('ÊúÄÂ§ßÈÖ∏Á¥†ÊëÇÂèñÈáè') !== -1) {
                return '**VO2maxÔºàÊúÄÂ§ßÈÖ∏Á¥†ÊëÇÂèñÈáèÔºâ„ÅÆÁßëÂ≠¶ÁöÑËß£Êûê**\n\n' +
                       '**ÂÆöÁæ©„Å®ÈáçË¶ÅÊÄßÔºö**\n' +
                       'VO2max„ÅØ1ÂàÜÈñì„Å´‰ΩìÈáç1kg„ÅÇ„Åü„Çä„ÅåÊëÇÂèñ„ÉªÂà©Áî®„Åß„Åç„ÇãÈÖ∏Á¥†„ÅÆÊúÄÂ§ßÈáèÔºàml/kg/minÔºâ„Åß„ÄÅÂøÉË°ÄÁÆ°Á≥ª„Å®Á≠ã‰ª£Ë¨ùËÉΩÂäõ„ÇíÂèçÊò†„Åô„ÇãÊåÅ‰πÖÂäõ„ÅÆÊúÄÈáçË¶ÅÊåáÊ®ô„Åß„Åô„ÄÇ\n\n' +
                       '**ÁîüÁêÜÂ≠¶ÁöÑÊ±∫ÂÆöÂõ†Â≠êÔºö**\n' +
                       '1. **‰∏≠Â§ÆÂæ™Áí∞Á≥ª**ÔºöÂøÉÊãçÂá∫ÈáèÔºàÂøÉÊãçÊï∞√ó1ÂõûÊãçÂá∫ÈáèÔºâ\n' +
                       '2. **Êú´Ê¢¢Âæ™Áí∞Á≥ª**ÔºöÁ≠ãË°ÄÊµÅÂàÜÂ∏É„Å®ÊØõÁ¥∞Ë°ÄÁÆ°ÂØÜÂ∫¶\n' +
                       '3. **Á≠ã‰ª£Ë¨ùÁ≥ª**Ôºö„Éü„Éà„Ç≥„É≥„Éâ„É™„Ç¢ÂØÜÂ∫¶„Å®ÈÖ∏ÂåñÈÖµÁ¥†Ê¥ªÊÄß\n\n' +
                       '**„Éà„É©„Ç§„Ç¢„Çπ„É≠„É≥„Åß„ÅÆÂü∫Ê∫ñÂÄ§Ôºàml/kg/minÔºâÔºö**\n' +
                       '‚Ä¢ „Ç®„É™„Éº„ÉàÁî∑ÊÄßÔºö65-75\n' +
                       '‚Ä¢ „Ç®„É™„Éº„ÉàÂ•≥ÊÄßÔºö55-65\n' +
                       '‚Ä¢ Á´∂ÊäÄ„É¨„Éô„É´Áî∑ÊÄßÔºö50-65\n' +
                       '‚Ä¢ Á´∂ÊäÄ„É¨„Éô„É´Â•≥ÊÄßÔºö45-55\n\n' +
                       '**ÁßëÂ≠¶ÁöÑÊîπÂñÑÊà¶Áï•Ôºö**\n' +
                       'Heritage Family StudyÔºà1999-2000Ôºâ„Å´„Çà„Çã„Å®„ÄÅVO2max„ÅÆÊîπÂñÑÂøúÁ≠îÊÄß„Å´„ÅØÈÅ∫‰ºùÁöÑË¶ÅÂõ†„ÅåÂ§ß„Åç„ÅèÂΩ±Èüø„Åó„Åæ„ÅôÔºö\n' +
                       '‚Ä¢ È´òÂøúÁ≠îÁæ§Ôºö15-20%ÊîπÂñÑ\n' +
                       '‚Ä¢ ‰∏≠ÂøúÁ≠îÁæ§Ôºö8-12%ÊîπÂñÑ\n' +
                       '‚Ä¢ ‰ΩéÂøúÁ≠îÁæ§Ôºö3-5%ÊîπÂñÑ\n\n' +
                       '**ÂÆüË∑µÁöÑ„Éà„É¨„Éº„Éã„É≥„Ç∞Âá¶ÊñπÔºö**\n' +
                       '1. **È´òÂº∑Â∫¶„Ç§„É≥„Çø„Éº„Éê„É´**Ôºö90-95% HRmax„ÄÅ4-8ÂàÜ√ó3-5Êú¨\n' +
                       '2. **‰∏≠Âº∑Â∫¶ÊåÅÁ∂ö**Ôºö80-85% HRmax„ÄÅ20-40ÂàÜ\n' +
                       '3. **È†ªÂ∫¶**ÔºöÈÄ±2-3Âõû„ÄÅ8-12ÈÄ±Èñì\n\n' +
                       'Âπ¥ÈΩ¢„Å´„Çà„Çã‰Ωé‰∏ãÁéá„ÅØÂπ¥ÈñìÁ¥Ñ1%„Åß„Åô„Åå„ÄÅÈÅ©Âàá„Å™„Éà„É¨„Éº„Éã„É≥„Ç∞„Å´„Çà„ÇäÁ∂≠ÊåÅ„ÉªÂêë‰∏ä„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ';
            }
            
            if (msg.indexOf('‰π≥ÈÖ∏ÈñæÂÄ§') !== -1 || msg.indexOf('lt') !== -1) {
                return '**‰π≥ÈÖ∏ÈñæÂÄ§ÔºàLactate ThresholdÔºâ„ÅÆÁßëÂ≠¶ÁöÑËß£Êûê**\n\n' +
                       '**ÁîüÁêÜÂ≠¶ÁöÑ„É°„Ç´„Éã„Ç∫„É†Ôºö**\n' +
                       '‰π≥ÈÖ∏ÈñæÂÄ§„ÅØË°Ä‰∏≠‰π≥ÈÖ∏ÊøÉÂ∫¶„ÅåÊåáÊï∞Èñ¢Êï∞ÁöÑ„Å´‰∏äÊòá„ÅóÂßã„ÇÅ„ÇãÈÅãÂãïÂº∑Â∫¶„Åß„ÄÅÊúâÈÖ∏Á¥†‰ª£Ë¨ù„Åã„ÇâÁÑ°ÈÖ∏Á¥†‰ª£Ë¨ù„Å∏„ÅÆÁßªË°åÁÇπ„ÇíÁ§∫„Åó„Åæ„Åô„ÄÇ\n\n' +
                       '**LT„ÅÆÊ±∫ÂÆöÂõ†Â≠êÔºö**\n' +
                       '1. **Á≠ãÁ∑öÁ∂≠ÁµÑÊàê**ÔºöType IÁ∑öÁ∂≠ÔºàÈÅÖÁ≠ãÔºâ„ÅÆÂâ≤Âêà\n' +
                       '2. **„Éü„Éà„Ç≥„É≥„Éâ„É™„Ç¢ÂØÜÂ∫¶**ÔºöÈÖ∏ÂåñÁöÑ„É™„É≥ÈÖ∏ÂåñËÉΩÂäõ\n' +
                       '3. **ÊØõÁ¥∞Ë°ÄÁÆ°ÂØÜÂ∫¶**ÔºöÈÖ∏Á¥†‰æõÁµ¶ÂäπÁéá\n' +
                       '4. **‰π≥ÈÖ∏Èô§ÂéªËÉΩÂäõ**ÔºöËÇùËáì„Åß„ÅÆ‰π≥ÈÖ∏‰ª£Ë¨ù\n\n' +
                       '**Ê∏¨ÂÆöÊñπÊ≥ï„Å®Âü∫Ê∫ñÔºö**\n' +
                       '‚Ä¢ **LT1**Ôºö2mmol/LÔºàÊúâÈÖ∏Á¥†ÈñæÂÄ§Ôºâ\n' +
                       '‚Ä¢ **LT2**Ôºö4mmol/LÔºàÁÑ°ÈÖ∏Á¥†ÈñæÂÄ§Ôºâ\n' +
                       '‚Ä¢ **%VO2max**ÔºöÈÄöÂ∏∏80-90%„ÅßÁô∫Áîü\n\n' +
                       '**ÁßëÂ≠¶ÁöÑÊîπÂñÑÊà¶Áï•Ôºö**\n' +
                       'Laursen & Jenkins (2002) „ÅÆ„É°„ÇøËß£Êûê„Å´„Çà„Çã„Å®Ôºö\n' +
                       '1. **„ÉÜ„É≥„ÉùËµ∞**ÔºöLTÂº∑Â∫¶„Åß20-40ÂàÜ„ÄÅÈÄ±2-3Âõû\n' +
                       '2. **„Çπ„Ç§„Éº„Éà„Çπ„Éù„ÉÉ„Éà**ÔºöLT1-LT2Èñì„Åß„ÅÆÁ∑¥Áøí\n' +
                       '3. **„Éù„É©„É©„Ç§„Ç∫„Éâ**Ôºö‰ΩéÂº∑Â∫¶80% + È´òÂº∑Â∫¶20%\n\n' +
                       'ÊîπÂñÑ„Å´„Çà„Çä„ÄÅÂêå„Åò‰π≥ÈÖ∏ÊøÉÂ∫¶„Åß„Çà„ÇäÈ´ò„ÅÑÂº∑Â∫¶„Åß„ÅÆÈÅãÂãï„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ';
            }
            
            return '**ÈÅãÂãïÁîüÁêÜÂ≠¶„Å´Âü∫„Å•„ÅèÂ∞ÇÈñÄÁöÑÂõûÁ≠î**\n\n' +
                   '„ÅîË≥™Âïè„Å´„Å§„ÅÑ„Å¶„ÄÅÁßëÂ≠¶ÁöÑÊ†πÊã†„Å´Âü∫„Å•„ÅÑ„Å¶„ÅäÁ≠î„Åà„Åó„Åæ„Åô„ÄÇ„Éà„É©„Ç§„Ç¢„Çπ„É≠„É≥„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÅÆÂêë‰∏ä„Å´„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆÁîüÁêÜÂ≠¶ÁöÑË¶ÅÂõ†„ÅÆÁµ±ÂêàÁöÑ„Å™ÁêÜËß£„ÅåÈáçË¶Å„Åß„ÅôÔºö\n\n' +
                   '**1. „Ç®„Éç„É´„ÇÆ„Éº„Ç∑„Çπ„ÉÜ„É†Ôºö**\n' +
                   '‚Ä¢ ÊúâÈÖ∏Á¥†Á≥ªÔºà„Éü„Éà„Ç≥„É≥„Éâ„É™„Ç¢ÂëºÂê∏Ôºâ\n' +
                   '‚Ä¢ ÁÑ°ÈÖ∏Á¥†Á≥ªÔºàËß£Á≥ñÁ≥ª + „É™„É≥ÈÖ∏Á≥ªÔºâ\n' +
                   '‚Ä¢ ËÑÇË≥™„ÉªÁ≥ñË≥™‰ª£Ë¨ù„ÅÆÊúÄÈÅ©Âåñ\n\n' +
                   '**2. Á•ûÁµåÁ≠ãÁ≥ªÔºö**\n' +
                   '‚Ä¢ ÈÅãÂãïÂçò‰ΩçÂãïÂì°„Éë„Çø„Éº„É≥\n' +
                   '‚Ä¢ Á≠ãÁ∑öÁ∂≠ÂûãÂàÜÂ∏É„Å®ÈÅ©Âøú\n' +
                   '‚Ä¢ Á•ûÁµåÁ≠ãÂçîË™øÊÄß\n\n' +
                   '**3. ÂøÉË°ÄÁÆ°Á≥ªÔºö**\n' +
                   '‚Ä¢ ÂøÉÊãçÂá∫Èáè„Å®Êú´Ê¢¢Ë°ÄÊµÅ\n' +
                   '‚Ä¢ ÈÖ∏Á¥†ÈÅãÊê¨„ÉªÊäΩÂá∫ËÉΩÂäõ\n' +
                   '‚Ä¢ Ë°ÄÁÆ°Êñ∞Áîü„Å®ÊØõÁ¥∞Ë°ÄÁÆ°ÂØÜÂ∫¶\n\n' +
                   '„Çà„ÇäÂÖ∑‰ΩìÁöÑ„Å™Ë≥™Âïè„Çí„ÅÑ„Åü„Å†„Åë„Çå„Å∞„ÄÅË©≥Á¥∞„Å™ÁßëÂ≠¶ÁöÑËß£Êûê„Å®ÂÆüË∑µÁöÑ„Å™„Éà„É¨„Éº„Éã„É≥„Ç∞Âá¶Êñπ„ÇíÊèê‰æõ„Åß„Åç„Åæ„Åô„ÄÇ';
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø° - Vercel FunctionsÂØæÂøúÁâà
        function sendMessage() {
            if (!isAIConnected) {
                showMessage('ÂÖà„Å´AI„Ç≥„Éº„ÉÅ„ÇíÊúâÂäπÂåñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            var input = document.getElementById('chatInput');
            var message = input.value.trim();
            if (!message) return;
            
            addChatMessage('user', message);
            input.value = '';
            
            // ÂÆüÈöõ„ÅÆAIÂøúÁ≠î„ÇíÂèñÂæóÔºàVercel FunctionsÁµåÁî±Ôºâ
            generateExpertResponse(message)
                .then(function(response) {
                    addChatMessage('ai', response.replace(/\n/g, '<br>'));
                })
                .catch(function(error) {
                    console.error('AI Response Error:', error);
                    addChatMessage('ai', 'Áî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇAIÊé•Á∂ö„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ<br><br>' +
                                        '**ÂèØËÉΩ„Å™ÂéüÂõ†Ôºö**<br>' +
                                        '‚Ä¢ API„Ç≠„Éº„ÅåÁÑ°Âäπ„Åæ„Åü„ÅØÊúüÈôêÂàá„Çå<br>' +
                                        '‚Ä¢ Vercel Function„ÅÆ„Éá„Éó„É≠„Ç§„Ç®„É©„Éº<br>' +
                                        '‚Ä¢ „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÅÆÂïèÈ°å<br><br>' +
                                        '„Éá„Éó„É≠„Ç§Áä∂Ê≥Å„Å®API„Ç≠„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                });
        }
        
        // Enter„Ç≠„ÉºÂá¶ÁêÜ
        function handleEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        console.log('Triathlon AI Coach (Vercel Ready) loaded successfully!');
    </script>
</body>
</html>
            
