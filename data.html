// data.htmlã«è¿½åŠ ã™ã‚‹ã‚³ãƒ¼ãƒ‰

// ===== è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½ =====

// è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆHTMLï¼‰
/*
<button id="fetchDetailsBtn" class="btn btn-sync" style="display: none;">
    ğŸ“¥ è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
</button>
*/

// è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
async function fetchDetailedData() {
    if (!accessToken || activities.length === 0) {
        alert('å…ˆã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦ãã ã•ã„');
        return;
    }

    const fetchDetailsBtn = document.getElementById('fetchDetailsBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    if (!confirm(`${activities.length}ä»¶ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰`)) {
        return;
    }

    fetchDetailsBtn.disabled = true;
    fetchDetailsBtn.innerHTML = '<span class="loading-spinner"></span> è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...';
    progressContainer.style.display = 'block';

    try {
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£IDã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
        const activityIds = activities.map(a => a.id);
        
        // ãƒãƒƒãƒã‚µã‚¤ã‚ºï¼ˆä¸€åº¦ã«å–å¾—ã™ã‚‹ä»¶æ•°ï¼‰
        const BATCH_SIZE = 50;
        const detailedActivities = [];
        
        for (let i = 0; i < activityIds.length; i += BATCH_SIZE) {
            const batch = activityIds.slice(i, i + BATCH_SIZE);
            const progress = Math.round((i / activityIds.length) * 100);
            
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­... ${i}/${activityIds.length}ä»¶`;
            
            const response = await fetch('/.netlify/functions/strava-batch-details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: accessToken,
                    activityIds: batch
                })
            });
            
            if (!response.ok) {
                throw new Error('è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            
            const data = await response.json();
            detailedActivities.push(...data.activities);
            
            console.log(`ğŸ“¥ ${data.summary.success}/${data.summary.total}ä»¶å–å¾—å®Œäº†`);
        }
        
        progressBar.style.width = '100%';
        progressText.textContent = `${detailedActivities.length}ä»¶ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`;
        
        // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        localStorage.setItem('strava_activities_detailed', JSON.stringify(detailedActivities));
        
        // æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
        activities = activities.map(activity => {
            const detailed = detailedActivities.find(d => d.id === activity.id);
            return detailed || activity;
        });
        
        localStorage.setItem('strava_activities', JSON.stringify(activities));
        
        // è¡¨ç¤ºã‚’æ›´æ–°
        displayActivities();
        generateSummary();
        
        alert('è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        
    } catch (error) {
        console.error('âŒ è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        progressText.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        progressBar.style.background = '#dc3545';
        alert('è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    } finally {
        fetchDetailsBtn.disabled = false;
        fetchDetailsBtn.innerHTML = 'ğŸ“¥ è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—';
        
        setTimeout(() => {
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
            progressBar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
        }, 3000);
    }
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã«è¿½åŠ 
function setupEventListeners() {
    // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼...
    
    const fetchDetailsBtn = document.getElementById('fetchDetailsBtn');
    if (fetchDetailsBtn) {
        fetchDetailsBtn.addEventListener('click', fetchDetailedData);
    }
}

// ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†å¾Œã«è©³ç´°ãƒ‡ãƒ¼ã‚¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
function onConnected() {
    // æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰...
    
    const fetchDetailsBtn = document.getElementById('fetchDetailsBtn');
    if (fetchDetailsBtn && activities.length > 0) {
        fetchDetailsBtn.style.display = 'block';
    }
}

// ===== å¿ƒæ‹Zoneãƒ‡ãƒ¼ã‚¿ã®æ´»ç”¨ =====

// è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¿ƒæ‹Zoneã‚’æŠ½å‡º
function extractHeartRateZones(activity) {
    // Stravaã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å¿ƒæ‹Zoneæƒ…å ±ã‚’æŠ½å‡º
    // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¿œã˜ã¦èª¿æ•´ãŒå¿…è¦
    
    if (!activity.has_heartrate) {
        return null;
    }
    
    // StravaãŒæä¾›ã™ã‚‹å¿ƒæ‹Zoneãƒ‡ãƒ¼ã‚¿
    // æ³¨: å®Ÿéš›ã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã—ã¦èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
    const zones = {
        zone1: 0,
        zone2: 0,
        zone3: 0,
        zone4: 0,
        zone5: 0
    };
    
    // ã‚‚ã—Stravaã®Zoneãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
    if (activity.zones && activity.zones.heartrate) {
        // Stravaã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¿œã˜ã¦å‡¦ç†
        // ä¾‹: activity.zones.heartrate.custom_zones
    }
    
    return zones;
}

// home.htmlã§ã®åˆ©ç”¨ä¾‹
/*
function calculateWeeklyZones(activities) {
    const weeks = {};

    activities.forEach(activity => {
        const weekStart = getWeekStart(new Date(activity.start_date));
        const weekKey = weekStart.toISOString().split('T')[0];
        
        // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰Zoneæƒ…å ±ã‚’å–å¾—
        const zones = extractHeartRateZones(activity);
        
        if (!zones) return; // å¿ƒæ‹ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        
        if (!weeks[weekKey]) {
            weeks[weekKey] = { zone1: 0, zone2: 0, zone3: 0, zone4: 0, zone5: 0 };
        }
        
        // å®Ÿéš›ã®Zoneãƒ‡ãƒ¼ã‚¿ã‚’åŠ ç®—
        weeks[weekKey].zone1 += zones.zone1;
        weeks[weekKey].zone2 += zones.zone2;
        weeks[weekKey].zone3 += zones.zone3;
        weeks[weekKey].zone4 += zones.zone4;
        weeks[weekKey].zone5 += zones.zone5;
    });
    
    return weeks;
}
*/

console.log('âœ… è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        
