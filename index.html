// ãƒ¬ã‚¬ã‚·ãƒ¼é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        function enableDemoMode() {
            enableDemoModeFromWelcome();
        }<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ AIã‚³ãƒ¼ãƒ | é‹å‹•ç”Ÿç†å­¦ãƒ™ãƒ¼ã‚¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: calc(100vh - 40px);
        }
        
        .simulator-panel, .chat-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1em;
        }
        
        .form-section {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .results {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 12px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .results h3, .results h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .result-label {
            font-weight: 600;
            color: #555;
            font-size: 0.85em;
        }
        
        .result-value {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .current-value {
            color: #666;
            font-size: 0.75em;
        }
        
        .improved-value {
            color: #27ae60;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .improvement {
            color: #2980b9;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .info-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            margin-bottom: 20px;
            font-size: 0.85em;
        }
        
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            font-size: 0.85em;
        }
        
        .error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        
        .success {
            background: #e8f5e8;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        .api-setup {
            padding: 20px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 20px;
            border-radius: 8px;
        }
        
        .api-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.9em;
            position: relative;
        }
        
        .api-input-container {
            position: relative;
        }
        
        .api-key-status {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: bold;
        }
        
        .api-key-status.saved {
            color: #4CAF50;
        }
        
        .api-key-status.error {
            color: #f44336;
        }
        
        .api-button {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 10px;
            font-weight: 600;
        }
        
        .api-button:hover {
            background: #e0a800;
        }
        
        .deploy-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            width: 100%;
        }
        
        .deploy-button:hover {
            background: #218838;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            max-height: 500px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 12px;
            max-width: 90%;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        
        .ai-message {
            background: white;
            color: #333;
            border: 1px solid #dee2e6;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background: white;
        }
        
        .chat-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            outline: none;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            font-size: 0.9em;
        }
        
        .chat-input:focus {
            border-color: #007bff;
        }
        
        .chat-send-btn {
            position: absolute;
            right: 25px;
            bottom: 27px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .chat-send-btn:hover {
            background: #0056b3;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-loading { background: #ffc107; }
        
        .code-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            overflow-x: auto;
        }

        /* å³å´ãƒ‘ãƒãƒ«ç”¨ã®æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ« */
        .welcome-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .welcome-section h2 {
            font-size: 2.2em;
            margin-bottom: 20px;
            color: white;
        }

        .welcome-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .feature-list {
            list-style: none;
            margin: 30px 0;
            text-align: left;
        }

        .feature-list li {
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
        }

        .feature-list li:before {
            content: "ğŸŠâ€â™‚ï¸";
            margin-right: 15px;
            font-size: 1.5em;
        }

        .feature-list li:nth-child(2):before {
            content: "ğŸš´â€â™‚ï¸";
        }

        .feature-list li:nth-child(3):before {
            content: "ğŸƒâ€â™‚ï¸";
        }

        .feature-list li:nth-child(4):before {
            content: "ğŸ“Š";
        }

        .feature-list li:nth-child(5):before {
            content: "ğŸ¯";
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }

            .welcome-section h2 {
                font-size: 1.8em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="simulator-panel">
            <div class="header">
                <h1>ğŸŠâ€â™‚ï¸ğŸš´â€â™‚ï¸ğŸƒâ€â™‚ï¸ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
                <p>é‹å‹•ç”Ÿç†å­¦ã«åŸºã¥ãæ”¹å–„äºˆæ¸¬</p>
            </div>
            
            <div class="form-section">
                <div class="info-text">
                    <strong>ğŸ“Š æ¡ä»¶ï¼š</strong> 8-12é€±é–“ã®æŒä¹…ç³»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å¾Œã®æ”¹å–„äºˆæ¸¬
                </div>
                
                <div id="messages"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="age">å¹´é½¢</label>
                        <input type="number" id="age" min="18" max="80" value="30">
                    </div>
                    <div class="form-group">
                        <label for="gender">æ€§åˆ¥</label>
                        <select id="gender">
                            <option value="male" selected>ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vo2max">VO2max (ml/kg/min)</label>
                        <input type="number" id="vo2max" min="30" max="80" step="0.1" value="50">
                    </div>
                    <div class="form-group">
                        <label for="ltPercent">LT (%VO2max)</label>
                        <input type="number" id="ltPercent" min="60" max="95" step="1" value="85">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ltPace">LTãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒšãƒ¼ã‚¹ (åˆ†:ç§’/km)</label>
                    <input type="text" id="ltPace" placeholder="ä¾‹: 4:30" value="4:30">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="genetics">éºä¼å­å‹æ”¹å–„åŠ¹æœ</label>
                        <select id="genetics">
                            <option value="H">H (é«˜å¿œç­”æ€§)</option>
                            <option value="M" selected>M (ä¸­å¿œç­”æ€§)</option>
                            <option value="L">L (ä½å¿œç­”æ€§)</option>
                            <option value="unknown">ä¸æ˜</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="level">ç«¶æŠ€ãƒ¬ãƒ™ãƒ«</label>
                        <select id="level">
                            <option value="elite">ã‚¨ãƒªãƒ¼ãƒˆ</option>
                            <option value="trained" selected>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è€…</option>
                            <option value="untrained">éãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è€…</option>
                        </select>
                    </div>
                </div>
                
                <button type="button" onclick="runSimulation()" class="calculate-btn">ğŸ§® æ”¹å–„åŠ¹æœã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                
                <div id="results" class="results">
                    <h3>ğŸ“ˆ æ”¹å–„äºˆæ¸¬çµæœ</h3>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
        
        <div class="chat-panel">
            <div class="header chat-header">
                <h1>ğŸ¤– AIãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã‚³ãƒ¼ãƒ</h1>
                <p><span id="connectionStatus" class="status-indicator status-error"></span>é‹å‹•ç”Ÿç†å­¦åšå£«ã«ã‚ˆã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹</p>
            </div>
            
            <div id="apiSetup" class="api-setup" style="display: none;">
                <strong>ğŸš€ APIã‚­ãƒ¼è¨­å®šï¼ˆè‡ªå‹•ä¿å­˜å¯¾å¿œï¼‰</strong>
                <p>OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã™ã‚‹ã¨è‡ªå‹•ä¿å­˜ã•ã‚Œã€æ¬¡å›ã‹ã‚‰è‡ªå‹•å¾©å…ƒã•ã‚Œã¾ã™ã€‚</p>
                
                <div class="api-input-container">
                    <input type="password" id="apiKeyInput" class="api-input" placeholder="sk-proj-... ã¾ãŸã¯ sk-...">
                    <span id="apiKeyStatus" class="api-key-status"></span>
                </div>
                
                <div style="margin: 15px 0; padding: 15px; background: #e8f4fd; border-radius: 6px;">
                    <strong>ğŸ“‹ æº–å‚™çŠ¶æ³:</strong><br>
                    <span id="vercelStatus">âŒ Vercel Functionsæœªãƒ‡ãƒ—ãƒ­ã‚¤</span><br>
                    <strong>âœ… è§£æ±ºç­–:</strong> é«˜å“è³ªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ + å®Ÿè£…ã‚¬ã‚¤ãƒ‰æä¾›<br>
                </div>
                
                <button onclick="enableDemoMode()" class="api-button">
                    ğŸ¯ AIã‚³ãƒ¼ãƒã‚’èµ·å‹•ï¼ˆè‡ªå‹•ä¿å­˜APIã‚­ãƒ¼ä½¿ç”¨ï¼‰
                </button>
                <p style="font-size: 0.8em; margin-top: 10px; color: #6c757d;">
                    ç¾åœ¨ã¯é«˜å“è³ªãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã§é‹å‹•ç”Ÿç†å­¦ã®å°‚é–€çŸ¥è­˜ã‚’æä¾›ã—ã¾ã™
                </p>
            </div>
            
            <div id="welcomePanel" class="welcome-panel">
                <div class="welcome-content">
                    <div class="welcome-section">
                        <h2>ã‚ãªãŸå°‚ç”¨ã®<br>ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã‚³ãƒ¼ãƒ</h2>
                        <p style="font-size: 1.2em; margin-bottom: 30px; line-height: 1.6;">
                            AIãŒå€‹åˆ¥ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ©ãƒ³ã¨å°‚é–€çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚
                        </p>
                    </div>
                    
                    <ul class="feature-list">
                        <li>å€‹åˆ¥åŒ–ã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ©ãƒ³</li>
                        <li>æŠ€è¡“æ”¹å–„ã®ãŸã‚ã®ãƒ‰ãƒªãƒ«</li>
                        <li>ãƒ¬ãƒ¼ã‚¹æˆ¦ç•¥ã¨ãƒšãƒ¼ã‚·ãƒ³ã‚°</li>
                        <li>æ „é¤Šã¨ãƒªã‚«ãƒãƒªãƒ¼ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</li>
                        <li>ç›®æ¨™é”æˆã¾ã§ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—</li>
                    </ul>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">24/7</div>
                            <div class="stat-label">ã„ã¤ã§ã‚‚ã‚µãƒãƒ¼ãƒˆ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">âˆ</div>
                            <div class="stat-label">ç„¡åˆ¶é™ç›¸è«‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">ğŸ¯</div>
                            <div class="stat-label">ç›®æ¨™é”æˆé‡è¦–</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">ğŸ§ </div>
                            <div class="stat-label">AIæŠ€è¡“æ´»ç”¨</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: rgba(255, 255, 255, 0.2); border-radius: 15px;">
                        <h3 style="margin-bottom: 15px; font-size: 1.3em;">ğŸš€ AIã‚³ãƒ¼ãƒã‚’å§‹ã‚ã‚‹</h3>
                        <p style="margin-bottom: 15px; font-size: 0.95em; line-height: 1.5;">
                            OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦AIã‚³ãƒ¼ãƒã¨ã®å¯¾è©±ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ã€‚ã‚­ãƒ¼ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã€æ¬¡å›ã‹ã‚‰å¾©å…ƒã•ã‚Œã¾ã™ã€‚
                        </p>
                        <div class="api-input-container" style="margin-bottom: 15px;">
                            <input type="password" id="apiKeyInputMain" class="api-input" placeholder="sk-proj-... ã¾ãŸã¯ sk-..." 
                                   style="background: rgba(255,255,255,0.9); border: 2px solid rgba(255,255,255,0.5);">
                            <span id="apiKeyStatusMain" class="api-key-status"></span>
                        </div>
                        <button onclick="enableDemoModeFromWelcome()" class="api-button" 
                                style="width: 100%; background: rgba(255,255,255,0.9); color: #333; font-weight: bold; padding: 12px;">
                            âœ¨ AIã‚³ãƒ¼ãƒã¨å¯¾è©±ã‚’å§‹ã‚ã‚‹
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="chatMessages" class="chat-messages" style="display: none;">
                <div class="ai-message">
                    <strong>AIã‚³ãƒ¼ãƒ</strong><br>
                    ã“ã‚“ã«ã¡ã¯ï¼é‹å‹•ç”Ÿç†å­¦åšå£«ã®AIã‚³ãƒ¼ãƒã§ã™ã€‚ğŸŠâ€â™‚ï¸ğŸš´â€â™‚ï¸ğŸƒâ€â™‚ï¸<br>
                    ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®è©³ç´°è§£èª¬ã‚„ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«é–¢ã™ã‚‹å°‚é–€çš„ãªè³ªå•ã«ãŠç­”ãˆã—ã¾ã™ã€‚
                </div>
            </div>
            
            <div id="chatInputArea" class="chat-input-area" style="display: none;">
                <div style="position: relative;">
                    <textarea id="chatInput" class="chat-input" placeholder="è³ªå•ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." rows="1" onkeypress="handleEnter(event)"></textarea>
                    <button onclick="sendMessage()" class="chat-send-btn">â¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APIã‚­ãƒ¼è‡ªå‹•ä¿å­˜é–¢é€£ã®å®šæ•°
        const API_KEY_STORAGE_KEY = 'triathlon_coach_api_key';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        var isAIConnected = false;
        var lastResults = null;
        
        // APIã‚­ãƒ¼è‡ªå‹•ä¿å­˜ãƒ»å¾©å…ƒæ©Ÿèƒ½
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        const apiKeyInputMain = document.getElementById('apiKeyInputMain');
        const apiKeyStatusMain = document.getElementById('apiKeyStatusMain');
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«APIã‚­ãƒ¼ã‚’å¾©å…ƒ
        window.addEventListener('load', function() {
            const savedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (savedApiKey) {
                if (apiKeyInput) {
                    apiKeyInput.value = savedApiKey;
                    updateApiKeyStatus('saved', 'ä¿å­˜æ¸ˆã¿ âœ“');
                }
                if (apiKeyInputMain) {
                    apiKeyInputMain.value = savedApiKey;
                    updateApiKeyStatusMain('saved', 'ä¿å­˜æ¸ˆã¿ âœ“');
                }
                showMessage('APIã‚­ãƒ¼ãŒå¾©å…ƒã•ã‚Œã¾ã—ãŸ', 'success');
            } else {
                setTimeout(() => {
                    showMessage('OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã™ã‚‹ã¨è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™', 'info');
                }, 1000);
            }
        });
        
        // APIã‚­ãƒ¼å…¥åŠ›æ™‚ã®è‡ªå‹•ä¿å­˜ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
        if (apiKeyInputMain) {
            apiKeyInputMain.addEventListener('input', function() {
                const apiKey = this.value.trim();
                if (apiKey) {
                    if (isValidApiKey(apiKey)) {
                        localStorage.setItem(API_KEY_STORAGE_KEY, apiKey);
                        updateApiKeyStatusMain('saved', 'ä¿å­˜æ¸ˆã¿ âœ“');
                        // éš ã•ã‚ŒãŸAPIã‚­ãƒ¼å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚åŒæœŸ
                        if (apiKeyInput) apiKeyInput.value = apiKey;
                    } else {
                        updateApiKeyStatusMain('error', 'ç„¡åŠ¹ãªå½¢å¼');
                    }
                } else {
                    localStorage.removeItem(API_KEY_STORAGE_KEY);
                    updateApiKeyStatusMain('', '');
                }
            });
        }
        
        // APIã‚­ãƒ¼å…¥åŠ›æ™‚ã®è‡ªå‹•ä¿å­˜ï¼ˆéš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
        if (apiKeyInput) {
            apiKeyInput.addEventListener('input', function() {
                const apiKey = this.value.trim();
                if (apiKey) {
                    if (isValidApiKey(apiKey)) {
                        localStorage.setItem(API_KEY_STORAGE_KEY, apiKey);
                        updateApiKeyStatus('saved', 'ä¿å­˜æ¸ˆã¿ âœ“');
                        // ãƒ¡ã‚¤ãƒ³APIã‚­ãƒ¼å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚åŒæœŸ
                        if (apiKeyInputMain) apiKeyInputMain.value = apiKey;
                    } else {
                        updateApiKeyStatus('error', 'ç„¡åŠ¹ãªå½¢å¼');
                    }
                } else {
                    localStorage.removeItem(API_KEY_STORAGE_KEY);
                    updateApiKeyStatus('', '');
                }
            });
        }
        
        // APIã‚­ãƒ¼ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
        function isValidApiKey(apiKey) {
            return (apiKey.startsWith('sk-proj-') || apiKey.startsWith('sk-')) && apiKey.length > 20;
        }
        
        // APIã‚­ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
        function updateApiKeyStatus(className, text) {
            if (apiKeyStatus) {
                apiKeyStatus.className = `api-key-status ${className}`;
                apiKeyStatus.textContent = text;
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³APIã‚­ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
        function updateApiKeyStatusMain(className, text) {
            if (apiKeyStatusMain) {
                apiKeyStatusMain.className = `api-key-status ${className}`;
                apiKeyStatusMain.textContent = text;
            }
        }
        
        // APIã‚­ãƒ¼ä¿å­˜ãƒ»å–å¾—
        function getStoredAPIKey() {
            const mainInput = apiKeyInputMain ? apiKeyInputMain.value.trim() : '';
            const hiddenInput = apiKeyInput ? apiKeyInput.value.trim() : '';
            return mainInput || hiddenInput || localStorage.getItem(API_KEY_STORAGE_KEY) || '';
        }
        
        // æ­£ç¢ºãªé‹å‹•ç”Ÿç†å­¦è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        function calculateVO2maxImprovement(vo2max, genetics, age, gender) {
            var vo2maxStandardsMale = {
                '20-29': { '25th': 39, '75th': 48.5 },
                '30-39': { '25th': 37.8, '75th': 47 },
                '40-49': { '25th': 35.9, '75th': 44.9 },
                '50-59': { '25th': 32.8, '75th': 41.8 },
                '60-69': { '25th': 29.5, '75th': 38.3 },
                '70-79': { '25th': 26.9, '75th': 35.2 }
            };
            
            var vo2maxStandardsFemale = {
                '20-29': { '25th': 33, '75th': 42.4 },
                '30-39': { '25th': 32, '75th': 41 },
                '40-49': { '25th': 30.2, '75th': 38.6 },
                '50-59': { '25th': 28, '75th': 35.2 },
                '60-69': { '25th': 25.1, '75th': 32.3 },
                '70-79': { '25th': 24.2, '75th': 29.8 }
            };
            
            var upsideMatrix = {
                'H-g': { 'H-v': 3, 'M-v': 4, 'L-v': 5 },
                'M-g': { 'H-v': 2, 'M-v': 3, 'L-v': 4 },
                'L-g': { 'H-v': 1, 'M-v': 2, 'L-v': 3 }
            };
            
            var vo2maxImprovementRates = { 1: 5, 2: 7, 3: 10, 4: 12, 5: 14 };
            
            function getAgeGroup(age) {
                if (age >= 20 && age <= 29) return '20-29';
                if (age >= 30 && age <= 39) return '30-39';
                if (age >= 40 && age <= 49) return '40-49';
                if (age >= 50 && age <= 59) return '50-59';
                if (age >= 60 && age <= 69) return '60-69';
                return '70-79';
            }
            
            function classifyVO2maxLevel(currentVO2max, age, gender) {
                var ageGroup = getAgeGroup(age);
                var standards = gender === 'male' ? vo2maxStandardsMale : vo2maxStandardsFemale;
                var ageStandards = standards[ageGroup];
                
                if (currentVO2max >= ageStandards['75th']) return 'H-v';
                if (currentVO2max < ageStandards['25th']) return 'L-v';
                return 'M-v';
            }
            
            var vo2maxLevel = classifyVO2maxLevel(vo2max, age, gender);
            var geneticsKey = (genetics === 'unknown' ? 'M' : genetics) + '-g';
            var upsideScore = upsideMatrix[geneticsKey][vo2maxLevel];
            var improvementRate = vo2maxImprovementRates[upsideScore];
            
            return vo2max + (vo2max * improvementRate / 100);
        }
        
        function calculateLTImprovement(currentLT, genetics, level, age, gender) {
            var ltStandardsMale = {
                '20-29': { lower: 65, upper: 72 },
                '30-39': { lower: 68, upper: 75 },
                '40-49': { lower: 72, upper: 78 },
                '50-59': { lower: 75, upper: 80 },
                '60-69': { lower: 78, upper: 82 },
                '70-79': { lower: 80, upper: 85 }
            };
            
            var ltStandardsFemale = {
                '20-29': { lower: 67.5, upper: 74.5 },
                '30-39': { lower: 70.5, upper: 77.5 },
                '40-49': { lower: 74.5, upper: 80.5 },
                '50-59': { lower: 77.5, upper: 82.5 },
                '60-69': { lower: 80.5, upper: 84.5 },
                '70-79': { lower: 82.5, upper: 87.5 }
            };
            
            var ltImprovementRates = { 'H-l': 1, 'M-l': 3, 'L-l': 5 };
            
            function getAgeGroup(age) {
                if (age >= 20 && age <= 29) return '20-29';
                if (age >= 30 && age <= 39) return '30-39';
                if (age >= 40 && age <= 49) return '40-49';
                if (age >= 50 && age <= 59) return '50-59';
                if (age >= 60 && age <= 69) return '60-69';
                return '70-79';
            }
            
            var ageGroup = getAgeGroup(age);
            var standards = gender === 'male' ? ltStandardsMale : ltStandardsFemale;
            var ageStandards = standards[ageGroup];
            
            var ltLevel;
            if (currentLT >= ageStandards.upper) ltLevel = 'H-l';
            else if (currentLT < ageStandards.lower) ltLevel = 'L-l';
            else ltLevel = 'M-l';
            
            return Math.min(90, currentLT + ltImprovementRates[ltLevel]);
        }
        
        function calculateRunningEconomyImprovement(currentVO2max, currentLT, ltPace, level, improvedVO2max, improvedLT) {
            var reImprovementRates = { 'H-r': 0.02, 'M-r': 0.04, 'L-r': 0.06 };
            
            var currentVO2AtLT = currentVO2max * (currentLT / 100);
            var ltPaceMinutes = paceToMinutes(ltPace);
            var currentRE = currentVO2AtLT * ltPaceMinutes;
            
            var reLevel = level === 'elite' ? 'H-r' : level === 'trained' ? 'M-r' : 'L-r';
            var improvementRate = reImprovementRates[reLevel];
            var improvedRE = currentRE * (1 - improvementRate);
            var improvedVO2AtLT = improvedVO2max * (improvedLT / 100);
            var improvedLTPaceMinutes = improvedRE / improvedVO2AtLT;
            
            return {
                improvedPace: minutesToPace(improvedLTPaceMinutes),
                improvementSeconds: (ltPaceMinutes - improvedLTPaceMinutes) * 60,
                improvedLTPaceMinutes: improvedLTPaceMinutes,
                // ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼å€¤ã‚’è¿½åŠ 
                currentRE: currentRE,
                improvedRE: improvedRE,
                reImprovementRate: improvementRate * 100 // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã§è¡¨ç¤º
            };
        }
        
        function predictRaceTimesAccurate(ltPaceMinutes, age, gender, level) {
            if (!ltPaceMinutes || isNaN(ltPaceMinutes) || ltPaceMinutes <= 0) {
                return { '5K': 'ã‚¨ãƒ©ãƒ¼', '10K': 'ã‚¨ãƒ©ãƒ¼', 'Half': 'ã‚¨ãƒ©ãƒ¼', 'Marathon': 'ã‚¨ãƒ©ãƒ¼' };
            }
            
            var ltPaceSeconds = ltPaceMinutes * 60;
            var baseTimes = {
                '5K': ltPaceSeconds - 15,
                '10K': ltPaceSeconds - 7,
                'Half': ltPaceSeconds + 12,
                'Marathon': ltPaceSeconds + 30
            };
            
            function personalizedAdjustment(basePaceSeconds, age, gender, level, distance) {
                var adjustment = 1.0;
                
                if (age > 40) {
                    var ageBonus = { '5K': 1.005, '10K': 1.000, 'Half': 0.995, 'Marathon': 0.990 };
                    adjustment *= ageBonus[distance];
                }
                
                if (gender === 'female') {
                    var genderBonus = { '5K': 1.010, '10K': 1.005, 'Half': 0.998, 'Marathon': 0.995 };
                    adjustment *= genderBonus[distance];
                }
                
                if (level === 'elite') adjustment *= 0.98;
                else if (level === 'untrained') adjustment *= 1.02;
                
                return basePaceSeconds * adjustment;
            }
            
            var adjustedTimes = {};
            for (var distance in baseTimes) {
                adjustedTimes[distance] = personalizedAdjustment(baseTimes[distance], age, gender, level, distance);
            }
            
            var distances = { '5K': 5, '10K': 10, 'Half': 21.0975, 'Marathon': 42.195 };
            var raceTimes = {};
            for (var distance in distances) {
                var totalSeconds = adjustedTimes[distance] * distances[distance];
                raceTimes[distance] = formatRaceTime(totalSeconds);
            }
            
            return raceTimes;
        }
        
        function formatRaceTime(totalSeconds) {
            if (isNaN(totalSeconds)) return 'ã‚¨ãƒ©ãƒ¼';
            var hours = Math.floor(totalSeconds / 3600);
            var minutes = Math.floor((totalSeconds % 3600) / 60);
            var seconds = Math.round(totalSeconds % 60);
            
            if (hours > 0) {
                return hours + ':' + (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            } else {
                return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            }
        }
        
        function paceToMinutes(paceStr) {
            var parts = paceStr.split(':');
            return parseInt(parts[0]) + parseInt(parts[1]) / 60;
        }
        
        function minutesToPace(minutes) {
            var min = Math.floor(minutes);
            var sec = Math.round((minutes - min) * 60);
            return min + ':' + (sec < 10 ? '0' : '') + sec;
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showMessage(message, type) {
            var container = document.getElementById('messages');
            var div = document.createElement('div');
            div.className = 'message ' + type;
            div.textContent = message;
            container.appendChild(div);
            
            setTimeout(function() {
                if (div.parentNode) {
                    div.parentNode.removeChild(div);
                }
            }, 5000);
        }
        
        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        function runSimulation() {
            console.log('Running simulation...');
            
            var age = parseInt(document.getElementById('age').value);
            var gender = document.getElementById('gender').value;
            var vo2max = parseFloat(document.getElementById('vo2max').value);
            var ltPercent = parseInt(document.getElementById('ltPercent').value);
            var ltPace = document.getElementById('ltPace').value;
            var genetics = document.getElementById('genetics').value;
            var level = document.getElementById('level').value;
            
            if (!age || !gender || !vo2max || !ltPercent || !ltPace || !genetics || !level) {
                showMessage('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (ltPace.indexOf(':') === -1) {
                showMessage('LTãƒšãƒ¼ã‚¹ã¯ã€Œåˆ†:ç§’ã€ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            try {
                var improvedVO2max = calculateVO2maxImprovement(vo2max, genetics, age, gender);
                var improvedLT = calculateLTImprovement(ltPercent, genetics, level, age, gender);
                var runningEconomyResult = calculateRunningEconomyImprovement(
                    vo2max, ltPercent, ltPace, level, improvedVO2max, improvedLT
                );
                
                var currentRaceTimes = predictRaceTimesAccurate(paceToMinutes(ltPace), age, gender, level);
                var improvedRaceTimes = predictRaceTimesAccurate(
                    runningEconomyResult.improvedLTPaceMinutes, age, gender, level
                );
                
                var results = {
                    current: {
                        vo2max: vo2max,
                        ltPercent: ltPercent,
                        ltPace: ltPace,
                        raceTimes: currentRaceTimes,
                        runningEconomy: runningEconomyResult.currentRE
                    },
                    improved: {
                        vo2max: improvedVO2max,
                        ltPercent: improvedLT,
                        ltPace: runningEconomyResult.improvedPace,
                        raceTimes: improvedRaceTimes,
                        runningEconomy: runningEconomyResult.improvedRE
                    },
                    improvements: {
                        vo2max: improvedVO2max - vo2max,
                        ltPercent: improvedLT - ltPercent,
                        ltPaceSeconds: runningEconomyResult.improvementSeconds,
                        runningEconomyRate: runningEconomyResult.reImprovementRate,
                        runningEconomyAbsolute: runningEconomyResult.currentRE - runningEconomyResult.improvedRE
                    }
                };
                
                displayResults(results);
                lastResults = results;
                
                if (isAIConnected) {
                    setTimeout(function() {
                        analyzeResults(results);
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Simulation error:', error);
                showMessage('è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }
        
        // çµæœè¡¨ç¤º
        function displayResults(results) {
            var container = document.getElementById('resultsContent');
            
            container.innerHTML = 
                '<div class="result-item">' +
                    '<span class="result-label">ğŸ« VO2max</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.vo2max + ' ml/kg/min</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.vo2max.toFixed(1) + ' ml/kg/min</span>' +
                        '<span class="improvement">+' + results.improvements.vo2max.toFixed(1) + ' ml/kg/min</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">âš¡ ä¹³é…¸é–¾å€¤(LT)</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.ltPercent + '% VO2max</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.ltPercent + '% VO2max</span>' +
                        '<span class="improvement">+' + results.improvements.ltPercent + '%</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">ğŸƒâ€â™‚ï¸ LTãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒšãƒ¼ã‚¹</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.ltPace + '/km</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.ltPace + '/km</span>' +
                        '<span class="improvement">-' + Math.abs(results.improvements.ltPaceSeconds).toFixed(0) + 'ç§’/km</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">âš™ï¸ ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.runningEconomy.toFixed(1) + ' ml/kg/min</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.runningEconomy.toFixed(1) + ' ml/kg/min</span>' +
                        '<span class="improvement">-' + results.improvements.runningEconomyAbsolute.toFixed(1) + ' (' + results.improvements.runningEconomyRate.toFixed(1) + '%æ”¹å–„)</span>' +
                    '</div>' +
                '</div>' +
                
                '<h4>ğŸ ãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ äºˆæ¸¬</h4>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">5K</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.raceTimes['5K'] + '</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.raceTimes['5K'] + '</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">10K</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.raceTimes['10K'] + '</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.raceTimes['10K'] + '</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">ãƒãƒ¼ãƒ•ãƒãƒ©ã‚½ãƒ³</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.raceTimes['Half'] + '</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.raceTimes['Half'] + '</span>' +
                    '</div>' +
                '</div>' +
                
                '<div class="result-item">' +
                    '<span class="result-label">ãƒ•ãƒ«ãƒãƒ©ã‚½ãƒ³</span>' +
                    '<div class="result-value">' +
                        '<span class="current-value">ç¾åœ¨: ' + results.current.raceTimes['Marathon'] + '</span>' +
                        '<span class="improved-value">æ”¹å–„å¾Œ: ' + results.improved.raceTimes['Marathon'] + '</span>' +
                    '</div>' +
                '</div>';
            
            document.getElementById('results').style.display = 'block';
            showMessage('ğŸ‰ è¨ˆç®—å®Œäº†ï¼AIã‚³ãƒ¼ãƒã®è©³ç´°åˆ†æã‚’ãŠå¾…ã¡ãã ã•ã„', 'success');
        }
        
        // ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †è¡¨ç¤º
        function showDeployInstructions() {
            var modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;';
            
            var content = document.createElement('div');
            content.style.cssText = 'background:white;padding:30px;border-radius:10px;max-width:90%;max-height:80%;overflow-y:auto;';
            
            content.innerHTML = `
                <h2>ğŸš€ Vercel Functionså®Ÿè£…æ‰‹é †</h2>
                
                <h3>1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæº–å‚™</h3>
                <div class="code-box">
mkdir triathlon-ai-coach
cd triathlon-ai-coach
npm init -y
                </div>
                
                <h3>2. package.json</h3>
                <div class="code-box">
{
  "name": "triathlon-ai-coach",
  "version": "1.0.0",
  "scripts": {
    "dev": "vercel dev",
    "build": "vercel build"
  },
  "devDependencies": {
    "vercel": "^32.0.0"
  }
}
                </div>
                
                <h3>3. api/openai.jsï¼ˆå®Œå…¨ç‰ˆï¼‰</h3>
                <div class="code-box">
export default async function handler(req, res) {
  // CORSè¨­å®š
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }
  
  const { message, apiKey, systemPrompt } = req.body;
  
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': \`Bearer \${apiKey}\`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: message }
        ],
        max_tokens: 1500,
        temperature: 0.7
      })
    });
    
    const data = await response.json();
    res.json(data);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}
                </div>
                
                <h3>4. ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆNetlifyã®å ´åˆï¼‰</h3>
                <div class="code-box">
# GitHubã«ãƒ—ãƒƒã‚·ãƒ¥å¾Œ
1. Netlify â†’ New site from Git
2. Connect to GitHub
3. Deploy settings:
   - Build command: (ç©ºæ¬„)
   - Publish directory: .
4. Environment variables:
   - å¿…è¦ã«å¿œã˜ã¦APIã‚­ãƒ¼ãªã©ã‚’è¨­å®š
                </div>
                
                <h3>5. ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆVercelã®å ´åˆï¼‰</h3>
                <div class="code-box">
npx vercel
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¾“ã£ã¦è¨­å®š
# ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã®URLã‚’ãƒ¡ãƒ¢
                </div>
                
                <button onclick="document.body.removeChild(this.parentElement.parentElement)" 
                        style="margin-top:20px;padding:10px 20px;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;">
                    é–‰ã˜ã‚‹
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–ï¼ˆã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ‘ãƒãƒ«ã‹ã‚‰ï¼‰
        function enableDemoModeFromWelcome() {
            var apiKey = getStoredAPIKey();
            
            if (!apiKey || !isValidApiKey(apiKey)) {
                showMessage('æœ‰åŠ¹ãªOpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            isAIConnected = true;
            document.getElementById('welcomePanel').style.display = 'none';
            document.getElementById('chatMessages').style.display = 'block';
            document.getElementById('chatInputArea').style.display = 'block';
            document.getElementById('connectionStatus').className = 'status-indicator status-connected';
            
            // APIã‚­ãƒ¼ã‚’ç¢ºå®Ÿã«ä¿å­˜
            localStorage.setItem(API_KEY_STORAGE_KEY, apiKey);
            updateApiKeyStatus('saved', 'ä¿å­˜æ¸ˆã¿ âœ“');
            updateApiKeyStatusMain('saved', 'ä¿å­˜æ¸ˆã¿ âœ“');
            
            showMessage('âœ… AIã‚³ãƒ¼ãƒãŒèµ·å‹•ã—ã¾ã—ãŸï¼', 'success');
            
            setTimeout(() => {
                addChatMessage('ai', 'ğŸŒŸ <strong>AIãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã‚³ãƒ¼ãƒã¸ã‚ˆã†ã“ãï¼</strong><br><br>' +
                              'ã“ã‚“ã«ã¡ã¯ï¼é‹å‹•ç”Ÿç†å­¦ã‚’å°‚é–€ã¨ã™ã‚‹AIã‚³ãƒ¼ãƒã§ã™ã€‚ğŸŠâ€â™‚ï¸ğŸš´â€â™‚ï¸ğŸƒâ€â™‚ï¸<br><br>' +
                              'APIã‚­ãƒ¼ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã“ã‚Œã§æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã‚‚è‡ªå‹•ã§å¾©å…ƒã•ã‚Œã¾ã™ã®ã§ã€ã™ãã«ã”ç›¸è«‡ã„ãŸã ã‘ã¾ã™ã‚ˆã€‚<br><br>' +
                              'ç§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªåˆ†é‡ã§ãŠæ‰‹ä¼ã„ã§ãã¾ã™ï¼š<br>' +
                              'â€¢ VO2maxã‚„ä¹³é…¸é–¾å€¤ãªã©ã®ä½“åŠ›æŒ‡æ¨™ã«ã¤ã„ã¦ã€åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬<br>' +
                              'â€¢ ã‚ãªãŸã«åˆã£ãŸåŠ¹æœçš„ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ–¹æ³•ã®ææ¡ˆ<br>' +
                              'â€¢ æ „é¤Šè£œçµ¦ã‚„ãƒªã‚«ãƒãƒªãƒ¼ã«ã¤ã„ã¦ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹<br>' +
                              'â€¢ ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„ã®ã‚³ãƒ„ã‚„æŠ€è¡“çš„ãªãƒã‚¤ãƒ³ãƒˆ<br>' +
                              'â€¢ ç–²åŠ´ç®¡ç†ã‚„ãƒ¬ãƒ¼ã‚¹æˆ¦ç•¥ã®ç›¸è«‡<br><br>' +
                              'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚ŠãŸã„ã“ã¨ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ãŠèã‹ã›ãã ã•ã„ã€‚ã¾ãŸã€æ—¥é ƒã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§æ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€ä½•ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã­ã€‚ä¸€ç·’ã«ç›®æ¨™é”æˆã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼');
            }, 500);
        }
        
        // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addChatMessage(sender, content) {
            var container = document.getElementById('chatMessages');
            var div = document.createElement('div');
            div.className = 'chat-message ' + sender + '-message';
            
            if (sender === 'ai') {
                div.innerHTML = '<strong>AIã‚³ãƒ¼ãƒ</strong><br>' + content;
            } else {
                div.innerHTML = content;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        // çµæœåˆ†æ
        function analyzeResults(results) {
            var analysis = 'ğŸ‰ <strong>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‹ã‚‰ã€ã‚ãªãŸã®å¯èƒ½æ€§ã‚’èª­ã¿è§£ã„ã¦ã¿ã¾ã—ã‚‡ã†ï¼</strong><br><br>';
            
            analysis += '**âœ¨ ã‚ãªãŸã®VO2maxæ”¹å–„äºˆæ¸¬ã«ã¤ã„ã¦**<br>';
            analysis += 'ä»Šå›ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€' + results.improvements.vo2max.toFixed(1) + 'ml/kg/minã®æ”¹å–„ï¼ˆç´„' + 
                       ((results.improvements.vo2max / results.current.vo2max) * 100).toFixed(1) + '%å‘ä¸Šï¼‰ãŒäºˆæ¸¬ã•ã‚Œã¾ã—ãŸã€‚';
            
            if (results.improvements.vo2max > 5) {
                analysis += 'ã“ã‚Œã¯ç´ æ™´ã‚‰ã—ã„æ”¹å–„å¹…ã§ã™ï¼ã‚ãªãŸã®éºä¼çš„ç‰¹æ€§ã¨ç¾åœ¨ã®ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ãƒ¬ãƒ™ãƒ«ãŒã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°åŠ¹æœã‚’æœ€å¤§é™ã«æ´»ã‹ã›ã‚‹çŠ¶æ³ã«ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚<br><br>';
            } else if (results.improvements.vo2max > 2) {
                analysis += 'ã“ã‚Œã¯å¥åº·çš„ã§ç€å®Ÿãªæ”¹å–„ã§ã™ã€‚ç¶™ç¶šçš„ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã‚ˆã£ã¦ã€ç¢ºå®Ÿã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã‚ˆã€‚<br><br>';
            } else {
                analysis += 'ã“ã®æ•°å€¤ã¯ã€ã™ã§ã«é«˜ã„ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ãƒ¬ãƒ™ãƒ«ã«ã‚ã‚‹ã“ã¨ã‚’è¡¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°ã•ãªæ”¹å–„ã§ã‚‚ã€ç«¶æŠ€ãƒ¬ãƒ™ãƒ«ã§ã¯å¤§ããªå·®ã«ãªã‚Šã¾ã™ã‹ã‚‰ã­ã€‚<br><br>';
            }
            
            analysis += '**âš¡ ä¹³é…¸é–¾å€¤ã®å‘ä¸Šã«ã¤ã„ã¦**<br>';
            analysis += 'ä¹³é…¸é–¾å€¤ãŒ' + results.improvements.ltPercent + '%æ”¹å–„ã•ã‚Œã‚‹äºˆæ¸¬ã§ã™ã€‚ã“ã‚Œã¯ã€Œæ¥½ã«æ„Ÿã˜ã‚‰ã‚Œã‚‹é‹å‹•å¼·åº¦ã®ä¸Šé™ã€ãŒé«˜ããªã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€ä»Šã¾ã§ã€Œãã¤ã„ã€ã¨æ„Ÿã˜ã¦ã„ãŸãƒšãƒ¼ã‚¹ãŒã€ã‚ˆã‚Šæ¥½ã«æ„Ÿã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã„ã†ã“ã¨ãªã‚“ã§ã™ã€‚<br><br>';
            
            analysis += '**âš™ï¸ ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼ã®æ”¹å–„ã«ã¤ã„ã¦**<br>';
            analysis += 'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼ã¨ã¯ã€ŒåŒã˜ãƒšãƒ¼ã‚¹ã§èµ°ã‚‹æ™‚ã«å¿…è¦ãªé…¸ç´ é‡ã€ã®ã“ã¨ã§ã€è»Šã§ã„ã†ã€Œç‡ƒè²»ã€ã®ã‚ˆã†ãªæ¦‚å¿µã§ã™ã€‚ç¾åœ¨' + results.current.runningEconomy.toFixed(1) + 'ml/kg/minã‹ã‚‰' + results.improved.runningEconomy.toFixed(1) + 'ml/kg/minã¸ã¨' + results.improvements.runningEconomyRate.toFixed(1) + '%æ”¹å–„ã•ã‚Œã‚‹äºˆæ¸¬ã§ã™ã€‚';
            analysis += 'ã“ã‚Œã¯ã€åŒã˜ãƒšãƒ¼ã‚¹ã§èµ°ã£ã¦ã‚‚ç–²ã‚Œã«ãããªã‚‹ã€ã¤ã¾ã‚Šã€ŒåŠ¹ç‡çš„ãªèµ°ã‚Šã€ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„ã€ç­‹åŠ›å¼·åŒ–ã€ç¥çµŒç³»ã®é©å¿œã«ã‚ˆã£ã¦å®Ÿç¾ã•ã‚Œã¾ã™ã‚ˆã€‚<br><br>';
            
            analysis += '**ğŸƒâ€â™‚ï¸ ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒšãƒ¼ã‚¹ã®æ”¹å–„åŠ¹æœ**<br>';
            analysis += 'LTãƒšãƒ¼ã‚¹ãŒ1kmã‚ãŸã‚Š' + Math.abs(results.improvements.ltPaceSeconds).toFixed(0) + 'ç§’çŸ­ç¸®ã•ã‚Œã‚‹äºˆæ¸¬ã§ã™ã€‚ãŸã£ãŸæ•°ç§’ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€42.195kmã®ãƒãƒ©ã‚½ãƒ³ã§ã¯ç´„' + Math.round(Math.abs(results.improvements.ltPaceSeconds) * 42.195 / 60) + 'åˆ†ã‚‚ã®çŸ­ç¸®ã«ã¤ãªãŒã‚Šã¾ã™ï¼<br><br>';
            
            analysis += '**ğŸ ã‚ãªãŸã®ç›®æ¨™ã‚¿ã‚¤ãƒ é”æˆã¸ã®é“ã®ã‚Š**<br>';
            analysis += 'â€¢ 5K: ' + results.current.raceTimes['5K'] + ' â†’ ' + results.improved.raceTimes['5K'] + '<br>';
            analysis += 'â€¢ 10K: ' + results.current.raceTimes['10K'] + ' â†’ ' + results.improved.raceTimes['10K'] + '<br>';
            analysis += 'â€¢ ãƒãƒ¼ãƒ•ãƒãƒ©ã‚½ãƒ³: ' + results.current.raceTimes['Half'] + ' â†’ ' + results.improved.raceTimes['Half'] + '<br>';
            analysis += 'â€¢ ãƒ•ãƒ«ãƒãƒ©ã‚½ãƒ³: ' + results.current.raceTimes['Marathon'] + ' â†’ ' + results.improved.raceTimes['Marathon'] + '<br><br>';
            
            analysis += '**ğŸ’ª ãŠã™ã™ã‚ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**<br>';
            if (results.improvements.vo2max > 4) {
                analysis += 'ã‚ãªãŸã«ã¯é«˜å¼·åº¦ç·´ç¿’ãŒç‰¹ã«åŠ¹æœçš„ã§ã™ã€‚é€±2-3å›ã€ã€Œä¼šè©±ãŒå›°é›£ã«ãªã‚‹ã€ç¨‹åº¦ã®å¼·åº¦ã§4-8åˆ†é–“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ç·´ç¿’ã‚’å–ã‚Šå…¥ã‚Œã¦ã¿ã¦ãã ã•ã„ã€‚ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼æ”¹å–„ã®ãŸã‚ã®ãƒ‰ãƒªãƒ«ç·´ç¿’ã‚„ç­‹åŠ›ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚‚ä½µã›ã¦è¡Œã†ã¨ã€ã•ã‚‰ã«åŠ¹æœçš„ã§ã™ã‚ˆã€‚';
            } else {
                analysis += 'ã¾ãšã¯ã€Œä¼šè©±ãŒã§ãã‚‹ç¨‹åº¦ã€ã®æ¥½ãªãƒšãƒ¼ã‚¹ã§ã®ç·´ç¿’ã‚’ä¸­å¿ƒã«ã€é€±1-2å›ã€Œå°‘ã—æ¯ãŒä¸ŠãŒã‚‹ã€ç¨‹åº¦ã®ä¸­å¼·åº¦ç·´ç¿’ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã®è¦‹ç›´ã—ã‚„ã€ã‚³ã‚¢å¼·åŒ–ã‚‚ä¸¦è¡Œã—ã¦è¡Œã†ã“ã¨ã§ã€ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼ã®æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™ã€‚';
            }
            analysis += '<br><br>ã“ã‚Œã‚‰ã®æ”¹å–„ã¯ã€8-12é€±é–“ã®è¨ˆç”»çš„ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ååˆ†å®Ÿç¾å¯èƒ½ã§ã™ã€‚ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼ ğŸŒŸ';
            
            addChatMessage('ai', analysis);
        }
        
        // å°‚é–€çš„AIå¿œç­”ç”Ÿæˆ - Vercel Functionsç‰ˆ
        function generateExpertResponse(message) {
            return new Promise(function(resolve, reject) {
                var systemPrompt = `ã‚ãªãŸã¯é‹å‹•ç”Ÿç†å­¦ã®åšå£«å·ã‚’æŒã¤ã€è¦ªã—ã¿ã‚„ã™ã„ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã‚³ãƒ¼ãƒã§ã™ã€‚ä¸€èˆ¬ã®æ–¹ã«ã‚‚åˆ†ã‹ã‚Šã‚„ã™ãã€ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ã€ã‚ãªãŸã®äººæ ¼ãƒ»è©±ã—æ–¹ã€‘
- è¦ªã—ã¿ã‚„ã™ãã€åŠ±ã¾ã—ãªãŒã‚‰è©±ã™
- å°‚é–€ç”¨èªã¯å¿…ãšåˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã™ã‚‹
- ä½“è¨€æ­¢ã‚ã¯é¿ã‘ã€è‡ªç„¶ã§èª­ã¿ã‚„ã™ã„æ–‡ç« ã«ã™ã‚‹
- ç›¸æ‰‹ã®ãƒ¬ãƒ™ãƒ«ã«åˆã‚ã›ã¦èª¬æ˜ã®æ·±ã•ã‚’èª¿æ•´ã™ã‚‹
- 400å­—ç¨‹åº¦ã§ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹

ã€å°‚é–€çŸ¥è­˜ã€‘
- é‹å‹•ç”Ÿç†å­¦ï¼ˆVO2maxã€ä¹³é…¸é–¾å€¤ã€ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼ï¼‰
- ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç†è«–
- ã‚¹ãƒãƒ¼ãƒ„æ „é¤Šå­¦ã¨ãƒªã‚«ãƒãƒªãƒ¼
- ãƒ•ã‚©ãƒ¼ãƒ æ”¹å–„ã¨ãƒã‚¤ã‚ªãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹
- ç–²åŠ´ç®¡ç†ã¨ãƒ”ãƒ¼ã‚­ãƒ³ã‚°æˆ¦ç•¥

ã€å›ç­”ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
1. ã¾ãšå…±æ„Ÿã‚„åŠ±ã¾ã—ã®è¨€è‘‰ã‹ã‚‰å§‹ã‚ã‚‹
2. ç§‘å­¦çš„æ ¹æ‹ ã‚’ã€Œã€œã¨ã„ã†ç ”ç©¶ã§åˆ†ã‹ã£ã¦ã„ã¾ã™ã€ã®ã‚ˆã†ã«è‡ªç„¶ã«çµ„ã¿è¾¼ã‚€
3. å°‚é–€ç”¨èªã¯ã€Œâ—‹â—‹ï¼ˆâ–³â–³ã®ã“ã¨ï¼‰ã€ã®ã‚ˆã†ã«ä½µè¨˜ã—ã¦èª¬æ˜
4. å…·ä½“çš„ã§å®Ÿè·µã—ã‚„ã™ã„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ææ¡ˆ
5. å€‹äººå·®ã‚„å®‰å…¨æ€§ã¸ã®é…æ…®ã‚’å«ã‚ã‚‹
6. å‰å‘ãã§å¿œæ´ã™ã‚‹ã‚ˆã†ãªçµ‚ã‚ã‚Šæ–¹ã«ã™ã‚‹

ã€æ–‡ä½“ä¾‹ã€‘
âŒ æ‚ªã„ä¾‹ï¼šã€ŒVO2maxå‘ä¸Šã«ã¯é«˜å¼·åº¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å®Ÿæ–½ãŒåŠ¹æœçš„ã€
âœ… è‰¯ã„ä¾‹ï¼šã€ŒVO2maxï¼ˆæœ€å¤§é…¸ç´ æ‘‚å–é‡ï¼‰ã‚’å‘ä¸Šã•ã›ã‚‹ã«ã¯ã€é«˜å¼·åº¦ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ç·´ç¿’ãŒåŠ¹æœçš„ã§ã™ã€‚ç ”ç©¶ã«ã‚ˆã‚‹ã¨ã€é€±2-3å›ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ç·´ç¿’ã§ç´„10-15%ã®æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™ã‚ˆã€‚ã€

ç¾åœ¨ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ: ${lastResults ? JSON.stringify(lastResults) : 'æœªå®Ÿè¡Œ'}`;

                // Netlify Functionsã‚’ä½¿ç”¨ã—ã¦APIå‘¼ã³å‡ºã—
                var apiEndpoint = '/.netlify/functions/openai';
                
                console.log('Calling Netlify Function:', apiEndpoint);
                
                fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        apiKey: getStoredAPIKey(),
                        systemPrompt: systemPrompt,
                        simulationResults: lastResults
                    })
                })
                .then(function(response) {
                    console.log('Netlify Function response status:', response.status);
                    
                    if (!response.ok) {
                        return response.json().then(function(errorData) {
                            throw new Error(errorData.error || 'API Error: ' + response.status);
                        });
                    }
                    
                    return response.json();
                })
                .then(function(data) {
                    console.log('OpenAI response received via Netlify Functions:', data);
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        resolve('ğŸ¤– **OpenAI APIã‹ã‚‰ã®å°‚é–€çš„å›ç­”:**\n\n' + data.choices[0].message.content);
                    } else {
                        throw new Error('Invalid API response format');
                    }
                })
                .catch(function(error) {
                    console.error('AI Response Error:', error);
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                    var errorMessage = '';
                    if (error.message.includes('401')) {
                        errorMessage = 'APIã‚­ãƒ¼ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚';
                    } else if (error.message.includes('429')) {
                        errorMessage = 'APIåˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                    } else if (error.message.includes('404')) {
                        errorMessage = 'Netlify Function ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    } else {
                        errorMessage = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                    }
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
                    var fallbackResponse = generateStaticExpertResponse(message);
                    resolve(fallbackResponse + '\n\n---\n**ğŸ”§ æ¥ç¶šçŠ¶æ³:** ' + errorMessage);
                });
            });
        }
        
        // é™çš„ãªå°‚é–€çš„å¿œç­”ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        function generateStaticExpertResponse(message) {
            var msg = message.toLowerCase();
            
            if (msg.indexOf('vo2max') !== -1 || msg.indexOf('æœ€å¤§é…¸ç´ æ‘‚å–é‡') !== -1) {
                return '**VO2maxã«ã¤ã„ã¦ã€åˆ†ã‹ã‚Šã‚„ã™ãã”èª¬æ˜ã—ã¾ã™ã­ï¼**\n\n' +
                       'VO2maxï¼ˆæœ€å¤§é…¸ç´ æ‘‚å–é‡ï¼‰ã¯ã€ã‚ãªãŸã®å¿ƒè‚ºæ©Ÿèƒ½ã®ã€Œã‚¨ãƒ³ã‚¸ãƒ³ã®å¤§ãã•ã€ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚ç°¡å˜ã«è¨€ã†ã¨ã€1åˆ†é–“ã«ã©ã‚Œã ã‘å¤šãã®é…¸ç´ ã‚’ä½“ã«å–ã‚Šè¾¼ã‚“ã§ä½¿ãˆã‚‹ã‹ã‚’è¡¨ã™æ•°å€¤ãªã‚“ã§ã™ã€‚\n\n' +
                       'ä¸€èˆ¬çš„ãªæˆäººç”·æ€§ã§45-55ml/kg/minç¨‹åº¦ã§ã™ãŒã€ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³é¸æ‰‹ã ã¨60-70ml/kg/minã«ã‚‚ãªã‚Šã¾ã™ã€‚ã“ã‚ŒãŒé«˜ã„ã»ã©ã€é•·æ™‚é–“ã®é‹å‹•ã‚’æ¥½ã«ç¶šã‘ã‚‰ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã­ã€‚\n\n' +
                       'æ”¹å–„ã™ã‚‹ã«ã¯ã€é€±2-3å›ã®ã€Œã¡ã‚‡ã£ã¨ãã¤ã„ã€ã¨æ„Ÿã˜ã‚‹ãƒšãƒ¼ã‚¹ã§ã®ç·´ç¿’ãŒåŠ¹æœçš„ã§ã™ã€‚ç ”ç©¶ã§ã¯8-12é€±é–“ã®ç¶™ç¶šã§10-15%ã®å‘ä¸ŠãŒæœŸå¾…ã§ãã‚‹ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ç„¡ç†ã‚’ã›ãšã€æ®µéšçš„ã«å¼·åº¦ã‚’ä¸Šã’ã¦ã„ãã®ãŒã‚³ãƒ„ã§ã™ã‚ˆï¼';
            }
            
            if (msg.indexOf('ä¹³é…¸é–¾å€¤') !== -1 || msg.indexOf('lt') !== -1 || msg.indexOf('é–¾å€¤') !== -1) {
                return '**ä¹³é…¸é–¾å€¤ã«ã¤ã„ã¦ã€èº«è¿‘ãªä¾‹ã§ã”èª¬æ˜ã—ã¾ã™ã­ï¼**\n\n' +
                       'ä¹³é…¸é–¾å€¤ï¼ˆLTï¼‰ã¯ã€é‹å‹•ä¸­ã«ã€Œã‚ã€ã¡ã‚‡ã£ã¨ãã¤ããªã£ã¦ããŸã€ã¨æ„Ÿã˜å§‹ã‚ã‚‹ãƒã‚¤ãƒ³ãƒˆã®ã“ã¨ã§ã™ã€‚ã“ã®ãƒšãƒ¼ã‚¹ã‚’å¢ƒã«ã€ä½“ã®ä¸­ã§ä¹³é…¸ã¨ã„ã†ç‰©è³ªãŒæ€¥æ¿€ã«æºœã¾ã‚Šå§‹ã‚ã¾ã™ã€‚\n\n' +
                       'ä¾‹ãˆã°ã€éšæ®µã‚’é§†ã‘ä¸ŠãŒã‚‹æ™‚ã‚’æƒ³åƒã—ã¦ãã ã•ã„ã€‚æœ€åˆã¯æ¥½ã§ã‚‚ã€é€”ä¸­ã‹ã‚‰æ€¥ã«æ¯ãŒä¸ŠãŒã‚Šã€è„šãŒé‡ããªã‚Šã¾ã™ã‚ˆã­ã€‚ãã‚ŒãŒã¾ã•ã«ä¹³é…¸é–¾å€¤ã‚’è¶…ãˆãŸçŠ¶æ…‹ãªã‚“ã§ã™ã€‚\n\n' +
                       'ã“ã®é–¾å€¤ã‚’æ”¹å–„ã™ã‚‹ã¨ã€åŒã˜ãƒšãƒ¼ã‚¹ã§ã‚‚ã‚ˆã‚Šæ¥½ã«æ„Ÿã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ç·´ç¿’ã§ã¯ã€Œå°‘ã—æ¯ãŒä¸ŠãŒã‚‹ã‘ã©ã€ä¼šè©±ã¯ã§ãã‚‹ã€ç¨‹åº¦ã®å¼·åº¦ã§20-30åˆ†ç¶šã‘ã‚‹ç·´ç¿’ãŒåŠ¹æœçš„ã§ã™ã‚ˆã€‚ç¶™ç¶šã™ã‚‹ã“ã¨ã§ã€å¿…ãšå‘ä¸Šã—ã¦ã„ãã¾ã™ï¼';
            }
            
            if (msg.indexOf('ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼') !== -1 || msg.indexOf('running economy') !== -1 || msg.indexOf('ã‚¨ã‚³ãƒãƒŸãƒ¼') !== -1) {
                return '**ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼ã«ã¤ã„ã¦ã€åˆ†ã‹ã‚Šã‚„ã™ãã”èª¬æ˜ã—ã¾ã™ã­ï¼**\n\n' +
                       'ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼ã¨ã¯ã€ä¸€å®šã®ãƒšãƒ¼ã‚¹ã§èµ°ã‚‹éš›ã«å¿…è¦ãªé…¸ç´ é‡ã®ã“ã¨ã§ã€è»Šã§ã„ã†ã€Œç‡ƒè²»ã€ã®ã‚ˆã†ãªæ¦‚å¿µã§ã™ã€‚åŒã˜ã‚¹ãƒ”ãƒ¼ãƒ‰ã§èµ°ã£ã¦ã‚‚ã€é…¸ç´ ã‚’ã‚ã¾ã‚Šä½¿ã‚ãªã„äººã»ã©ã€Œç‡ƒè²»ãŒè‰¯ã„ã€ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚\n\n' +
                       'ä¾‹ãˆã°ã€åŒã˜4åˆ†30ç§’/kmãƒšãƒ¼ã‚¹ã§èµ°ã‚‹å ´åˆã€ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ã‚³ãƒãƒŸãƒ¼ã®è‰¯ã„äººã¯é…¸ç´ æ¶ˆè²»é‡ãŒå°‘ãªãã€é•·æ™‚é–“ãã®ãƒšãƒ¼ã‚¹ã‚’ç¶­æŒã§ãã¾ã™ã€‚é€†ã«æ‚ªã„äººã¯ã€åŒã˜ãƒšãƒ¼ã‚¹ã§ã‚‚ã™ãã«ç–²ã‚Œã¦ã—ã¾ã†ã‚“ã§ã™ã€‚\n\n' +
                       'æ”¹å–„æ–¹æ³•ã¨ã—ã¦ã¯ã€â‘ æ­£ã—ã„ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã®ç¿’å¾—ã€â‘¡ã‚³ã‚¢ã‚„ä¸‹è‚¢ã®ç­‹åŠ›å¼·åŒ–ã€â‘¢ç¥çµŒç³»ã®å”èª¿æ€§å‘ä¸ŠãŒåŠ¹æœçš„ã§ã™ã€‚ç ”ç©¶ã§ã¯ã€é©åˆ‡ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§2-6%ã®æ”¹å–„ãŒæœŸå¾…ã§ãã€ã“ã‚Œã¯ãƒãƒ©ã‚½ãƒ³ã‚¿ã‚¤ãƒ ã§æ•°åˆ†ã®çŸ­ç¸®ã«ç›¸å½“ã—ã¾ã™ã€‚åŠ¹ç‡çš„ãªèµ°ã‚Šã‚’èº«ã«ã¤ã‘ã¦ã€æ¥½ã«é€Ÿãèµ°ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ã‚‡ã†ï¼';
            }
            
            if (msg.indexOf('ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°') !== -1 || msg.indexOf('ç·´ç¿’') !== -1) {
                return '**åŠ¹æœçš„ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¤ã„ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã•ã›ã¦ã„ãŸã ãã¾ã™ã­ï¼**\n\n' +
                       'ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§å¤§åˆ‡ãªã®ã¯ã€Œ80:20ã®æ³•å‰‡ã€ã§ã™ã€‚å…¨ä½“ã®80%ã¯æ¥½ã«æ„Ÿã˜ã‚‹ãƒšãƒ¼ã‚¹ã§ã€æ®‹ã‚Š20%ã‚’ã—ã£ã‹ã‚Šã¨ã—ãŸå¼·åº¦ã§è¡Œã†ã®ãŒç†æƒ³çš„ãªã‚“ã§ã™ã€‚\n\n' +
                       'æ¥½ãªãƒšãƒ¼ã‚¹ã¨ã„ã†ã®ã¯ã€Œéš£ã®äººã¨ä¼šè©±ã§ãã‚‹ã€ç¨‹åº¦ã®å¼·åº¦ã§ã™ã€‚ã“ã‚Œã§æŒä¹…åŠ›ã®åŸºç¤ã¨ãªã‚‹æ¯›ç´°è¡€ç®¡ã‚„å¿ƒè‡“æ©Ÿèƒ½ãŒç€å®Ÿã«å‘ä¸Šã—ã¾ã™ã€‚ãã—ã¦é€±ã«1-2å›ã€ã€Œå°‘ã—ãã¤ã„ã€ã¨æ„Ÿã˜ã‚‹ç·´ç¿’ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€ã•ã‚‰ãªã‚‹æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™ã€‚\n\n' +
                       'ç„¡ç†ã¯ç¦ç‰©ã§ã™ã€‚ä½“èª¿ã‚„ç–²åŠ´åº¦ã«åˆã‚ã›ã¦èª¿æ•´ã—ã€æ¥½ã—ã¿ãªãŒã‚‰ç¶šã‘ã‚‹ã“ã¨ãŒä¸€ç•ªå¤§åˆ‡ã§ã™ã‚ˆã€‚ç¶™ç¶šã“ããŒæœ€å¤§ã®æˆæœã«ã¤ãªãŒã‚Šã¾ã™ï¼';
            }
            
            return '**ã”è³ªå•ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼**\n\n' +
                   'ãƒˆãƒ©ã‚¤ã‚¢ã‚¹ãƒ­ãƒ³ã¯æŒä¹…åŠ›ã€æŠ€è¡“ã€ãã—ã¦æˆ¦ç•¥ã®3ã¤ãŒçµ„ã¿åˆã‚ã•ã£ãŸç´ æ™´ã‚‰ã—ã„ã‚¹ãƒãƒ¼ãƒ„ã§ã™ã­ã€‚ç§‘å­¦çš„ãªçŸ¥è­˜ã‚‚å¤§åˆ‡ã§ã™ãŒã€ä½•ã‚ˆã‚Šæ¥½ã—ã¿ãªãŒã‚‰ç¶šã‘ã‚‹ã“ã¨ãŒä¸€ç•ªé‡è¦ã ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚\n\n' +
                   'ã‚ãªãŸã®ä½“ã¯å¿…ãšé©å¿œã—ã€å‘ä¸Šã—ã¦ã„ãã¾ã™ã€‚ç ”ç©¶ã§ã‚‚ã€é©åˆ‡ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç¶šã‘ã‚‹ã“ã¨ã§å¹´é½¢ã«é–¢ä¿‚ãªãä½“åŠ›å‘ä¸ŠãŒå¯èƒ½ã ã¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã€‚\n\n' +
                   'ã‚ˆã‚Šå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã™ã‚‹ãŸã‚ã«ã€ã©ã®ã‚ˆã†ãªç‚¹ã§ãŠå›°ã‚Šã‹è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã‚¹ã‚¤ãƒ ã€ãƒã‚¤ã‚¯ã€ãƒ©ãƒ³ã€ãã‚Œã¨ã‚‚æ „é¤Šé¢ãªã©ã€ã©ã‚“ãªã“ã¨ã§ã‚‚ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚ä¸€ç·’ã«ç›®æ¨™é”æˆã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼';
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ - Vercel Functionså¯¾å¿œç‰ˆ
        function sendMessage() {
            if (!isAIConnected) {
                showMessage('å…ˆã«AIã‚³ãƒ¼ãƒã‚’èµ·å‹•ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            var input = document.getElementById('chatInput');
            var message = input.value.trim();
            if (!message) return;
            
            addChatMessage('user', message);
            input.value = '';
            
            // å®Ÿéš›ã®AIå¿œç­”ã‚’å–å¾—ï¼ˆVercel FunctionsçµŒç”±ï¼‰
            generateExpertResponse(message)
                .then(function(response) {
                    addChatMessage('ai', response.replace(/\n/g, '<br>'));
                })
                .catch(function(error) {
                    console.error('AI Response Error:', error);
                    addChatMessage('ai', 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚AIæ¥ç¶šã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br><br>' +
                                        '**å¯èƒ½ãªåŸå› ï¼š**<br>' +
                                        'â€¢ APIã‚­ãƒ¼ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ<br>' +
                                        'â€¢ Netlify Functionã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼<br>' +
                                        'â€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å•é¡Œ<br><br>' +
                                        'ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã¨APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                });
        }
        
        // Enterã‚­ãƒ¼å‡¦ç†
        function handleEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        console.log('Triathlon AI Coach (Enhanced with Auto-Save) loaded successfully!');
    </script>
</body>
</html>
