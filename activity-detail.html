<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£Ë©≥Á¥∞ | AI Triathlon Coach</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #dbeafe 0%, #ffffff 50%, #cffafe 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
        }
        
        /* „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .flow-navbar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 240px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 24px 0;
            overflow-y: auto;
        }

        .flow-nav-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .flow-nav-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            text-align: center;
            padding: 0 20px 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .flow-nav-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 0 16px;
            flex: 1;
        }

        .flow-nav-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
        }

        .flow-nav-step .nav-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .flow-nav-step.current {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .flow-nav-step.available:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .content-wrapper {
            margin-left: 240px;
            flex: 1;
            padding: 24px;
            width: calc(100% - 240px);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 16px;
            transition: background 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-button:hover {
            background: #5a6268;
        }
        
        /* Ê¶ÇË¶Å„Éò„ÉÉ„ÉÄ„Éº */
        .activity-header {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .activity-title-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .activity-icon {
            font-size: 2.5rem;
        }
        
        .activity-info h1 {
            font-size: 1.8rem;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .activity-date {
            color: #6b7280;
            font-size: 0.95rem;
        }
        
        .activity-sport-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: auto;
        }
        
        .activity-sport-badge.swim { background: #dbeafe; color: #1d4ed8; }
        .activity-sport-badge.bike { background: #f3e8ff; color: #7c3aed; }
        .activity-sport-badge.run { background: #dcfce7; color: #16a34a; }
        .activity-sport-badge.other { background: #fef3c7; color: #b45309; }
        
        /* Ê¶ÇË¶Å„É°„Éà„É™„ÇØ„Çπ */
        .summary-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }
        
        .summary-metric {
            text-align: center;
            padding: 16px 12px;
            background: #f9fafb;
            border-radius: 12px;
        }
        
        .summary-metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.2;
        }
        
        .summary-metric-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        
        /* „Ç∞„É™„ÉÉ„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .detail-grid.full-width {
            grid-template-columns: 1fr;
        }
        
        .panel {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .panel-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-content {
            padding: 20px;
        }
        
        /* Âú∞Âõ≥ */
        #routeMap {
            height: 350px;
            border-radius: 8px;
        }
        
        .no-map-message {
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 0.95rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        /* „Ç∞„É©„Éï */
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        .chart-container.small {
            height: 180px;
        }
        
        /* ZoneÂàÜÂ∏É */
        .zone-summary {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .zone-item {
            text-align: center;
            padding: 12px 8px;
            border-radius: 8px;
            color: white;
            font-size: 0.8rem;
        }
        
        .zone-item.z1 { background: #9ca3af; }
        .zone-item.z2 { background: #3b82f6; }
        .zone-item.z3 { background: #22c55e; }
        .zone-item.z4 { background: #f97316; }
        .zone-item.z5 { background: #ef4444; }
        
        .zone-time {
            font-size: 1.1rem;
            font-weight: 700;
            display: block;
        }
        
        .zone-percent {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        /* Lap„ÉÜ„Éº„Éñ„É´ */
        .lap-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .lap-table th {
            background: #f3f4f6;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: #4b5563;
        }
        
        .lap-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .lap-table tbody tr:hover {
            background: #f9fafb;
        }
        
        /* AI„Ç≥„Éº„ÉÅ„Çª„ÇØ„Ç∑„Éß„É≥ */
        .ai-coach-panel {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .ai-coach-header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .ai-coach-header h2 {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .ai-coach-content {
            padding: 24px;
        }
        
        .ai-comment {
            font-size: 1rem;
            line-height: 1.8;
            color: #374151;
            white-space: pre-wrap;
        }
        
        .ai-loading {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #6b7280;
            padding: 20px 0;
        }
        
        .ai-loading .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Ë≥™ÂïèÂÖ•Âäõ */
        .question-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .question-section h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }
        
        .question-input-row {
            display: flex;
            gap: 12px;
        }
        
        .question-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        
        .question-input:focus {
            outline: none;
            border-color: #f97316;
        }
        
        .question-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .question-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        }
        
        .question-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* ‰ºöË©±Â±•Ê≠¥ */
        .chat-history {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .chat-message {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        
        .chat-message.user {
            background: #f3f4f6;
            margin-left: 40px;
        }
        
        .chat-message.coach {
            background: #fff7ed;
            margin-right: 40px;
        }
        
        .chat-message-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .chat-message.coach .chat-message-label {
            color: #ea580c;
        }
        
        .chat-message-content {
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        /* „Ç®„É©„Éº */
        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        /* Á®ÆÁõÆÂà•„É°„Éà„É™„ÇØ„Çπ */
        .sport-specific-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .sport-metric-card {
            background: #f9fafb;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .sport-metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .sport-metric-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 4px;
        }
        
        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 1024px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .flow-navbar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: auto;
                width: 100%;
                height: auto;
                padding: 12px 0;
            }

            .flow-nav-logo {
                padding: 0 20px 15px;
                margin-bottom: 10px;
                font-size: 1.1rem;
            }

            .flow-nav-steps {
                flex-direction: row;
                overflow-x: auto;
                gap: 5px;
                padding: 0 10px;
            }

            .flow-nav-step {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .flow-nav-step span:not(.nav-icon) {
                display: none;
            }

            .content-wrapper {
                margin-left: 0;
                padding: 16px;
                padding-top: 140px;
                width: 100%;
            }
            
            .activity-title-row {
                flex-wrap: wrap;
            }
            
            .activity-sport-badge {
                margin-left: 0;
                margin-top: 8px;
            }
            
            .summary-metrics {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .zone-summary {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .question-input-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
    <nav class="flow-navbar">
        <div class="flow-nav-container">
            <div class="flow-nav-logo">AI Triathlon Coach</div>
            <div class="flow-nav-steps">
                <a href="home.html" class="flow-nav-step available">
                    <span class="nav-icon">üè†</span>
                    <span>„Éõ„Éº„É†</span>
                </a>
                <a href="index.html" class="flow-nav-step available">
                    <span class="nav-icon">ü§ñ</span>
                    <span>AI„Ç≥„Éº„ÉÅ</span>
                </a>
                <a href="news.html" class="flow-nav-step available">
                    <span class="nav-icon">üì∞</span>
                    <span>„Éã„É•„Éº„Çπ</span>
                </a>
                <a href="race-selection.html" class="flow-nav-step available">
                    <span class="nav-icon">üéØ</span>
                    <span>„É¨„Éº„ÇπÈÅ∏Êäû</span>
                </a>
                <a href="goal-setting.html" class="flow-nav-step available">
                    <span class="nav-icon">üèÜ</span>
                    <span>ÁõÆÊ®ôË®≠ÂÆö</span>
                </a>
                <a href="training-plan.html" class="flow-nav-step available">
                    <span class="nav-icon">üìã</span>
                    <span>Ë®àÁîª</span>
                </a>
                <a href="simulator.html" class="flow-nav-step available">
                    <span class="nav-icon">üî¨</span>
                    <span>„Ç∑„Éü„É•„É¨„Éº„Çø„Éº</span>
                </a>
                <a href="data.html" class="flow-nav-step current">
                    <span class="nav-icon">üìä</span>
                    <span>ÈÄ≤Êçó</span>
                </a>
                <a href="settings.html" class="flow-nav-step available">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Ë®≠ÂÆö</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <div class="container">
            <button class="back-button" onclick="goBackToData()">‚Üê ÈÄ≤Êçó„Éö„Éº„Ç∏„Å´Êàª„Çã</button>
            
            <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
            <div id="loadingSection" class="loading-container">
                <div class="loading-spinner"></div>
                <p>„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
            </div>
            
            <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div id="mainContent" style="display: none;">
                <!-- Ê¶ÇË¶Å„Éò„ÉÉ„ÉÄ„Éº -->
                <div class="activity-header">
                    <div class="activity-title-row">
                        <span class="activity-icon" id="activityIcon">üèÉ‚Äç‚ôÇÔ∏è</span>
                        <div class="activity-info">
                            <h1 id="activityName">„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£Âêç</h1>
                            <div class="activity-date" id="activityDate">Êó•ÊôÇ</div>
                        </div>
                        <span class="activity-sport-badge run" id="sportBadge">„É©„É≥</span>
                    </div>
                    <div class="summary-metrics" id="summaryMetrics">
                        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                    </div>
                </div>
                
                <!-- Âú∞Âõ≥„Å®„Çæ„Éº„É≥ÂàÜÊûê -->
                <div class="detail-grid">
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title">üó∫Ô∏è „É´„Éº„Éà„Éû„ÉÉ„Éó</h2>
                        </div>
                        <div class="panel-content">
                            <div id="mapContainer">
                                <div id="routeMap"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title">üíì ÂøÉÊãç„Çæ„Éº„É≥ÂàÜÂ∏É</h2>
                        </div>
                        <div class="panel-content">
                            <div class="zone-summary" id="zoneSummary">
                                <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                            </div>
                            <div class="chart-container small">
                                <canvas id="zoneChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÂøÉÊãçÊï∞„Éª„Éö„Éº„ÇπÊôÇÁ≥ªÂàó„Ç∞„É©„Éï -->
                <div class="detail-grid">
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title">üíì ÂøÉÊãçÊï∞Êé®Áßª</h2>
                        </div>
                        <div class="panel-content">
                            <div class="chart-container">
                                <canvas id="hrChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title" id="paceChartTitle">‚è±Ô∏è „Éö„Éº„ÇπÊé®Áßª</h2>
                        </div>
                        <div class="panel-content">
                            <div class="chart-container">
                                <canvas id="paceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Á®ÆÁõÆÂà•„É°„Éà„É™„ÇØ„ÇπÔºà„Éê„Ç§„ÇØ:„Éë„ÉØ„Éº/„Ç±„Ç§„Éá„É≥„Çπ„ÄÅ„É©„É≥:„Éî„ÉÉ„ÉÅ/„Çπ„Éà„É©„Ç§„ÉâÔºâ -->
                <div class="detail-grid" id="sportSpecificSection" style="display: none;">
                    <div class="panel" id="powerPanel" style="display: none;">
                        <div class="panel-header">
                            <h2 class="panel-title">‚ö° „Éë„ÉØ„ÉºÊé®Áßª</h2>
                        </div>
                        <div class="panel-content">
                            <div class="sport-specific-row" id="powerMetrics">
                                <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                            </div>
                            <div class="chart-container" style="margin-top: 16px;">
                                <canvas id="powerChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel" id="cadencePanel" style="display: none;">
                        <div class="panel-header">
                            <h2 class="panel-title" id="cadenceTitle">üîÑ „Ç±„Ç§„Éá„É≥„ÇπÊé®Áßª</h2>
                        </div>
                        <div class="panel-content">
                            <div class="sport-specific-row" id="cadenceMetrics">
                                <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                            </div>
                            <div class="chart-container" style="margin-top: 16px;">
                                <canvas id="cadenceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lap„Éá„Éº„Çø -->
                <div class="detail-grid full-width" id="lapSection" style="display: none;">
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title">üìã LapË©≥Á¥∞</h2>
                        </div>
                        <div class="panel-content">
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="lap-table" id="lapTable">
                                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI„Ç≥„Éº„ÉÅ„Ç≥„É°„É≥„Éà -->
                <div class="ai-coach-panel">
                    <div class="ai-coach-header">
                        <span style="font-size: 1.5rem;">ü§ñ</span>
                        <h2>AI„Ç≥„Éº„ÉÅ„Åã„Çâ„ÅÆ„Ç≥„É°„É≥„Éà</h2>
                    </div>
                    <div class="ai-coach-content">
                        <div id="aiCommentLoading" class="ai-loading">
                            <div class="spinner"></div>
                            <span>AI„Ç≥„Éº„ÉÅ„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„ÇíÂàÜÊûê‰∏≠...</span>
                        </div>
                        <div id="aiComment" class="ai-comment" style="display: none;"></div>
                        
                        <!-- Ë≥™Âïè„Çª„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="question-section">
                            <h3>üí¨ „Ç≥„Éº„ÉÅ„Å´Ë≥™Âïè„Åô„Çã</h3>
                            <div class="question-input-row">
                                <input type="text" class="question-input" id="questionInput" 
                                    placeholder="‰æã: Ê¨°Âõû„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞„Åß„ÅØ„Å©„Åì„ÇíÊÑèË≠ò„Åô„Åπ„ÅçÔºü">
                                <button class="question-btn" id="askBtn" onclick="askQuestion()">Ë≥™Âïè„Åô„Çã</button>
                            </div>
                            <div class="chat-history" id="chatHistory" style="display: none;">
                                <!-- ‰ºöË©±Â±•Ê≠¥ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- „Ç®„É©„Éº -->
            <div id="errorSection" style="display: none;">
                <div class="error-message">
                    <h3>‚ùå „Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</h3>
                    <p id="errorMessage">„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // ===== „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ =====
        let currentActivity = null;
        let streamData = null;
        let trainingStatus = null;
        let map = null;
        let charts = {};
        
        // ===== ÂàùÊúüÂåñ =====
        document.addEventListener('DOMContentLoaded', async () => {
            const activityId = getActivityId();
            
            if (!activityId) {
                showError('„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£ID„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            try {
                await loadActivityData(activityId);
            } catch (error) {
                console.error('Error loading activity:', error);
                showError(error.message);
            }
        });
        
        function getActivityId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // ===== „Éá„Éº„ÇøË™≠„ÅøËæº„Åø =====
        async function loadActivityData(activityId) {
            // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„ÇíÂèñÂæó
            const cachedActivities = localStorage.getItem('strava_activities');
            if (!cachedActivities) {
                throw new Error('„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÈÄ≤Êçó„Éö„Éº„Ç∏„Åß„Éá„Éº„Çø„ÇíÂêåÊúü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
            
            const activities = JSON.parse(cachedActivities);
            currentActivity = activities.find(a => a.id.toString() === activityId.toString());
            
            if (!currentActivity) {
                throw new Error('ÊåáÂÆö„Åï„Çå„Åü„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
            
            // „Éà„É¨„Éº„Éã„É≥„Ç∞„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®àÁÆó
            trainingStatus = calculateTrainingStatus(activities);
            
            // Âü∫Êú¨ÊÉÖÂ†±„ÇíË°®Á§∫
            renderActivityHeader();
            renderSummaryMetrics();
            
            // Streams API„Åß„Éá„Éº„Çø„ÇíÂèñÂæó
            await loadStreamData(activityId);
            
            // UI„ÇíË°®Á§∫
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // „Ç∞„É©„Éï„ÇíÊèèÁîª
            renderCharts();
            
            // AI„Ç≥„É°„É≥„Éà„ÇíÂèñÂæó
            fetchAIComment();
        }
        
        async function loadStreamData(activityId) {
            const authData = localStorage.getItem('strava_auth');
            if (!authData) {
                console.log('No auth data, skipping streams');
                return;
            }
            
            try {
                const auth = JSON.parse(authData);
                const response = await fetch('/.netlify/functions/strava-streams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: auth.access_token,
                        activityId: activityId
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.hasStreams) {
                        streamData = data.streams;
                        console.log('Stream data loaded:', Object.keys(streamData));
                    }
                }
            } catch (error) {
                console.error('Failed to load streams:', error);
            }
        }
        
        // ===== „Éà„É¨„Éº„Éã„É≥„Ç∞„Çπ„ÉÜ„Éº„Çø„ÇπË®àÁÆó =====
        function calculateTrainingStatus(activities) {
            if (activities.length === 0) return null;
            
            const dailyTss = {};
            activities.forEach(activity => {
                const date = activity.start_date.split('T')[0];
                if (!dailyTss[date]) dailyTss[date] = 0;
                dailyTss[date] += activity.tss || 0;
            });
            
            const today = new Date();
            const days = [];
            for (let i = 89; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                days.push({ date: dateStr, tss: dailyTss[dateStr] || 0 });
            }
            
            const ctlFactor = 1 - Math.exp(-1 / 42);
            const atlFactor = 1 - Math.exp(-1 / 7);
            
            let ctl = 0, atl = 0, prevCtl = 0;
            
            days.forEach((day, i) => {
                ctl = ctl + (day.tss - ctl) * ctlFactor;
                atl = atl + (day.tss - atl) * atlFactor;
                if (i === days.length - 8) prevCtl = ctl;
            });
            
            return {
                ctl: Math.round(ctl * 10) / 10,
                atl: Math.round(atl * 10) / 10,
                tsb: Math.round((ctl - atl) * 10) / 10,
                ctlTrend: Math.round((ctl - prevCtl) * 10) / 10
            };
        }
        
        // ===== „Éò„ÉÉ„ÉÄ„ÉºÊèèÁîª =====
        function renderActivityHeader() {
            const sportType = currentActivity.sport_type || currentActivity.type;
            const sportCategory = getSportCategory(sportType);
            
            document.getElementById('activityIcon').textContent = getActivityIcon(sportType);
            document.getElementById('activityName').textContent = currentActivity.name || 'ÁÑ°È°å„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£';
            document.getElementById('activityDate').textContent = new Date(currentActivity.start_date).toLocaleString('ja-JP', {
                year: 'numeric', month: 'long', day: 'numeric',
                weekday: 'short', hour: '2-digit', minute: '2-digit'
            });
            
            const badge = document.getElementById('sportBadge');
            badge.textContent = getSportLabel(sportType);
            badge.className = `activity-sport-badge ${sportCategory}`;
        }
        
        function renderSummaryMetrics() {
            const sportType = currentActivity.sport_type || currentActivity.type;
            const sportCategory = getSportCategory(sportType);
            
            let html = '';
            
            // Ë∑ùÈõ¢
            if (currentActivity.distance) {
                html += createMetricCard((currentActivity.distance / 1000).toFixed(2), 'km', 'Ë∑ùÈõ¢');
            }
            
            // ÊôÇÈñì
            html += createMetricCard(formatDuration(currentActivity.moving_time), '', 'ÊôÇÈñì');
            
            // „Éö„Éº„Çπ/ÈÄüÂ∫¶
            if (currentActivity.average_speed) {
                if (sportCategory === 'swim') {
                    html += createMetricCard(formatSwimPace(currentActivity.average_speed), '/100m', '„Éö„Éº„Çπ');
                } else if (sportCategory === 'bike') {
                    html += createMetricCard((currentActivity.average_speed * 3.6).toFixed(1), 'km/h', 'Âπ≥ÂùáÈÄüÂ∫¶');
                } else {
                    html += createMetricCard(formatRunPace(currentActivity.average_speed), '/km', '„Éö„Éº„Çπ');
                }
            }
            
            // ÂøÉÊãç
            if (currentActivity.average_heartrate) {
                html += createMetricCard(Math.round(currentActivity.average_heartrate), 'bpm', 'Âπ≥ÂùáÂøÉÊãç');
            }
            
            // TSS
            if (currentActivity.tss) {
                html += createMetricCard(currentActivity.tss, '', 'TSS');
            }
            
            // Ê®ôÈ´ò
            if (currentActivity.total_elevation_gain && currentActivity.total_elevation_gain > 10) {
                html += createMetricCard(Math.round(currentActivity.total_elevation_gain), 'm', 'Áç≤ÂæóÊ®ôÈ´ò');
            }
            
            document.getElementById('summaryMetrics').innerHTML = html;
        }
        
        function createMetricCard(value, unit, label) {
            return `
                <div class="summary-metric">
                    <div class="summary-metric-value">${value}<small style="font-size: 0.6em; font-weight: 400;">${unit}</small></div>
                    <div class="summary-metric-label">${label}</div>
                </div>
            `;
        }
        
        // ===== „Ç∞„É©„ÉïÊèèÁîª =====
        function renderCharts() {
            renderMap();
            renderZoneChart();
            renderHeartRateChart();
            renderPaceChart();
            renderSportSpecificCharts();
            renderLapTable();
        }
        
        function renderMap() {
            const mapContainer = document.getElementById('mapContainer');
            
            if (!streamData || !streamData.latlng || !streamData.latlng.data || streamData.latlng.data.length === 0) {
                mapContainer.innerHTML = '<div class="no-map-message">üó∫Ô∏è GPS„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºà„Ç§„É≥„Éâ„Ç¢„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„ÅÆÂèØËÉΩÊÄßÔºâ</div>';
                return;
            }
            
            const coords = streamData.latlng.data;
            
            map = L.map('routeMap');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            
            const polyline = L.polyline(coords, { color: '#667eea', weight: 4, opacity: 0.8 }).addTo(map);
            map.fitBounds(polyline.getBounds(), { padding: [20, 20] });
            
            // „Çπ„Çø„Éº„Éà„Éª„Ç¥„Éº„É´„Éû„Éº„Ç´„Éº
            const startIcon = L.divIcon({ className: 'start-marker', html: 'üü¢', iconSize: [24, 24] });
            const endIcon = L.divIcon({ className: 'end-marker', html: 'üèÅ', iconSize: [24, 24] });
            
            L.marker(coords[0], { icon: startIcon }).addTo(map);
            L.marker(coords[coords.length - 1], { icon: endIcon }).addTo(map);
        }
        
        function renderZoneChart() {
            const zones = calculateHeartRateZones();
            
            // Zone „Çµ„Éû„É™„Éº
            const zoneSummaryHtml = zones.map((z, i) => `
                <div class="zone-item z${i + 1}">
                    <span class="zone-time">${formatDurationShort(z.time)}</span>
                    <span class="zone-percent">${z.percent.toFixed(0)}%</span>
                </div>
            `).join('');
            document.getElementById('zoneSummary').innerHTML = zoneSummaryHtml;
            
            // Zone „ÉÅ„É£„Éº„Éà
            const ctx = document.getElementById('zoneChart').getContext('2d');
            if (charts.zone) charts.zone.destroy();
            
            charts.zone = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Z1', 'Z2', 'Z3', 'Z4', 'Z5'],
                    datasets: [{
                        data: zones.map(z => z.percent),
                        backgroundColor: ['#9ca3af', '#3b82f6', '#22c55e', '#f97316', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, title: { display: true, text: '%' } }
                    }
                }
            });
        }
        
        function calculateHeartRateZones() {
            const thresholds = getUserThresholds();
            const maxHr = thresholds.maxHr || 190;
            const totalTime = currentActivity.moving_time || 0;
            
            // Stream„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË©≥Á¥∞Ë®àÁÆó
            if (streamData && streamData.heartrate && streamData.heartrate.data && streamData.time) {
                const hrData = streamData.heartrate.data;
                const timeData = streamData.time.data;
                
                const zoneTimes = [0, 0, 0, 0, 0];
                
                for (let i = 1; i < hrData.length; i++) {
                    const hr = hrData[i];
                    const duration = timeData[i] - timeData[i - 1];
                    const hrPercent = (hr / maxHr) * 100;
                    
                    if (hrPercent < 60) zoneTimes[0] += duration;
                    else if (hrPercent < 70) zoneTimes[1] += duration;
                    else if (hrPercent < 80) zoneTimes[2] += duration;
                    else if (hrPercent < 90) zoneTimes[3] += duration;
                    else zoneTimes[4] += duration;
                }
                
                const total = zoneTimes.reduce((a, b) => a + b, 0) || 1;
                return zoneTimes.map(t => ({ time: t, percent: (t / total) * 100 }));
            }
            
            // Âπ≥ÂùáÂøÉÊãç„Åã„ÇâÊé®ÂÆö
            const avgHr = currentActivity.average_heartrate;
            if (!avgHr) return [0, 1, 2, 3, 4].map(() => ({ time: 0, percent: 0 }));
            
            const hrPercent = (avgHr / maxHr) * 100;
            const zones = [0, 0, 0, 0, 0];
            
            if (hrPercent < 60) zones[0] = 100;
            else if (hrPercent < 70) zones[1] = 100;
            else if (hrPercent < 80) zones[2] = 100;
            else if (hrPercent < 90) zones[3] = 100;
            else zones[4] = 100;
            
            return zones.map((p, i) => ({ time: p > 0 ? totalTime : 0, percent: p }));
        }
        
        function renderHeartRateChart() {
            const ctx = document.getElementById('hrChart').getContext('2d');
            if (charts.hr) charts.hr.destroy();
            
            if (!streamData || !streamData.heartrate || !streamData.heartrate.data) {
                ctx.canvas.parentElement.innerHTML = '<div class="no-map-message">ÂøÉÊãç„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            const hrData = streamData.heartrate.data;
            const timeData = streamData.time?.data || hrData.map((_, i) => i);
            const distanceData = streamData.distance?.data;
            
            // „Éá„Éº„Çø„Çí„Çµ„É≥„Éó„É™„É≥„Ç∞ÔºàÂ§ö„Åô„Åé„ÇãÂ†¥ÂêàÔºâ
            const maxPoints = 500;
            const step = Math.max(1, Math.floor(hrData.length / maxPoints));
            
            const labels = [];
            const data = [];
            
            for (let i = 0; i < hrData.length; i += step) {
                if (distanceData) {
                    labels.push((distanceData[i] / 1000).toFixed(1));
                } else {
                    labels.push(formatDurationShort(timeData[i]));
                }
                data.push(hrData[i]);
            }
            
            charts.hr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ÂøÉÊãçÊï∞',
                        data: data,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: distanceData ? 'Ë∑ùÈõ¢ (km)' : 'ÊôÇÈñì' } },
                        y: { title: { display: true, text: 'bpm' } }
                    }
                }
            });
        }
        
        function renderPaceChart() {
            const ctx = document.getElementById('paceChart').getContext('2d');
            if (charts.pace) charts.pace.destroy();
            
            const sportCategory = getSportCategory(currentActivity.sport_type || currentActivity.type);
            
            if (sportCategory === 'bike') {
                document.getElementById('paceChartTitle').textContent = 'üö¥ ÈÄüÂ∫¶Êé®Áßª';
            }
            
            if (!streamData || !streamData.velocity_smooth || !streamData.velocity_smooth.data) {
                ctx.canvas.parentElement.innerHTML = '<div class="no-map-message">„Éö„Éº„Çπ/ÈÄüÂ∫¶„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            const velData = streamData.velocity_smooth.data;
            const distanceData = streamData.distance?.data;
            const timeData = streamData.time?.data || velData.map((_, i) => i);
            
            const maxPoints = 500;
            const step = Math.max(1, Math.floor(velData.length / maxPoints));
            
            const labels = [];
            const data = [];
            
            for (let i = 0; i < velData.length; i += step) {
                if (distanceData) {
                    labels.push((distanceData[i] / 1000).toFixed(1));
                } else {
                    labels.push(formatDurationShort(timeData[i]));
                }
                
                if (sportCategory === 'bike') {
                    data.push(velData[i] * 3.6); // km/h
                } else if (sportCategory === 'swim') {
                    data.push(velData[i] > 0 ? 100 / velData[i] : 0); // sec/100m
                } else {
                    data.push(velData[i] > 0 ? 1000 / velData[i] / 60 : 0); // min/km
                }
            }
            
            const yLabel = sportCategory === 'bike' ? 'km/h' : sportCategory === 'swim' ? 'sec/100m' : 'min/km';
            
            charts.pace = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: sportCategory === 'bike' ? 'ÈÄüÂ∫¶' : '„Éö„Éº„Çπ',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: distanceData ? 'Ë∑ùÈõ¢ (km)' : 'ÊôÇÈñì' } },
                        y: { 
                            title: { display: true, text: yLabel },
                            reverse: sportCategory !== 'bike' // „Éö„Éº„Çπ„ÅØÈÄÜÈ†Ü
                        }
                    }
                }
            });
        }
        
        function renderSportSpecificCharts() {
            const sportCategory = getSportCategory(currentActivity.sport_type || currentActivity.type);
            
            if (sportCategory === 'bike') {
                renderBikeCharts();
            } else if (sportCategory === 'run') {
                renderRunCharts();
            }
        }
        
        function renderBikeCharts() {
            document.getElementById('sportSpecificSection').style.display = 'grid';
            
            // „Éë„ÉØ„Éº„ÉÅ„É£„Éº„Éà
            if (streamData && streamData.watts && streamData.watts.data) {
                document.getElementById('powerPanel').style.display = 'block';
                
                // „Éë„ÉØ„Éº„É°„Éà„É™„ÇØ„Çπ
                const avgPower = currentActivity.average_watts || 0;
                const np = currentActivity.weighted_average_watts || 0;
                document.getElementById('powerMetrics').innerHTML = `
                    <div class="sport-metric-card">
                        <div class="sport-metric-value">${Math.round(avgPower)}</div>
                        <div class="sport-metric-label">Âπ≥Âùá„Éë„ÉØ„Éº (W)</div>
                    </div>
                    <div class="sport-metric-card">
                        <div class="sport-metric-value">${Math.round(np)}</div>
                        <div class="sport-metric-label">NP (W)</div>
                    </div>
                `;
                
                renderTimeSeriesChart('powerChart', streamData.watts.data, '„Éë„ÉØ„Éº', '#8b5cf6', 'W');
            }
            
            // „Ç±„Ç§„Éá„É≥„Çπ„ÉÅ„É£„Éº„Éà
            if (streamData && streamData.cadence && streamData.cadence.data) {
                document.getElementById('cadencePanel').style.display = 'block';
                document.getElementById('cadenceTitle').textContent = 'üîÑ „Ç±„Ç§„Éá„É≥„ÇπÊé®Áßª';
                
                const avgCadence = currentActivity.average_cadence || 0;
                document.getElementById('cadenceMetrics').innerHTML = `
                    <div class="sport-metric-card">
                        <div class="sport-metric-value">${Math.round(avgCadence)}</div>
                        <div class="sport-metric-label">Âπ≥Âùá„Ç±„Ç§„Éá„É≥„Çπ (rpm)</div>
                    </div>
                `;
                
                renderTimeSeriesChart('cadenceChart', streamData.cadence.data, '„Ç±„Ç§„Éá„É≥„Çπ', '#22c55e', 'rpm');
            }
        }
        
        function renderRunCharts() {
            document.getElementById('sportSpecificSection').style.display = 'grid';
            
            // „Éî„ÉÉ„ÉÅ/„Ç±„Ç§„Éá„É≥„Çπ„ÉÅ„É£„Éº„Éà
            if (streamData && streamData.cadence && streamData.cadence.data) {
                document.getElementById('cadencePanel').style.display = 'block';
                document.getElementById('cadenceTitle').textContent = 'üëü „Éî„ÉÉ„ÉÅÊé®Áßª';
                
                const avgCadence = currentActivity.average_cadence || 0;
                document.getElementById('cadenceMetrics').innerHTML = `
                    <div class="sport-metric-card">
                        <div class="sport-metric-value">${Math.round(avgCadence * 2)}</div>
                        <div class="sport-metric-label">Âπ≥Âùá„Éî„ÉÉ„ÉÅ (spm)</div>
                    </div>
                `;
                
                // „É©„É≥„ÅÆÂ†¥Âêà„ÅØ„Ç±„Ç§„Éá„É≥„Çπ„Çí2ÂÄçÔºàÂ∑¶Âè≥ÂêàË®àÔºâ
                const pitchData = streamData.cadence.data.map(c => c * 2);
                renderTimeSeriesChart('cadenceChart', pitchData, '„Éî„ÉÉ„ÉÅ', '#22c55e', 'spm');
            }
        }
        
        function renderTimeSeriesChart(canvasId, data, label, color, unit) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[canvasId]) charts[canvasId].destroy();
            
            const distanceData = streamData?.distance?.data;
            const timeData = streamData?.time?.data || data.map((_, i) => i);
            
            const maxPoints = 500;
            const step = Math.max(1, Math.floor(data.length / maxPoints));
            
            const labels = [];
            const chartData = [];
            
            for (let i = 0; i < data.length; i += step) {
                if (distanceData) {
                    labels.push((distanceData[i] / 1000).toFixed(1));
                } else {
                    labels.push(formatDurationShort(timeData[i]));
                }
                chartData.push(data[i]);
            }
            
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: chartData,
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: distanceData ? 'Ë∑ùÈõ¢ (km)' : 'ÊôÇÈñì' } },
                        y: { title: { display: true, text: unit } }
                    }
                }
            });
        }
        
        function renderLapTable() {
            if (!currentActivity.laps || currentActivity.laps.length === 0) {
                return;
            }
            
            document.getElementById('lapSection').style.display = 'block';
            const sportCategory = getSportCategory(currentActivity.sport_type || currentActivity.type);
            
            let html = `
                <thead>
                    <tr>
                        <th>Lap</th>
                        <th>Ë∑ùÈõ¢</th>
                        <th>ÊôÇÈñì</th>
                        <th>${sportCategory === 'bike' ? 'ÈÄüÂ∫¶' : '„Éö„Éº„Çπ'}</th>
                        <th>ÂøÉÊãç</th>
                        ${sportCategory === 'bike' ? '<th>„Éë„ÉØ„Éº</th>' : ''}
                    </tr>
                </thead>
                <tbody>
            `;
            
            currentActivity.laps.forEach((lap, index) => {
                const pace = sportCategory === 'bike' 
                    ? `${(lap.average_speed * 3.6).toFixed(1)} km/h`
                    : formatRunPace(lap.average_speed);
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${(lap.distance / 1000).toFixed(2)} km</td>
                        <td>${formatDuration(lap.moving_time || lap.elapsed_time)}</td>
                        <td>${pace}</td>
                        <td>${lap.average_heartrate ? Math.round(lap.average_heartrate) : '-'}</td>
                        ${sportCategory === 'bike' ? `<td>${lap.average_watts ? Math.round(lap.average_watts) : '-'} W</td>` : ''}
                    </tr>
                `;
            });
            
            html += '</tbody>';
            document.getElementById('lapTable').innerHTML = html;
        }
        
        // ===== AI„Ç≥„É°„É≥„Éà =====
        async function fetchAIComment(userQuestion = null) {
            const loadingEl = document.getElementById('aiCommentLoading');
            const commentEl = document.getElementById('aiComment');
            
            if (!userQuestion) {
                loadingEl.style.display = 'flex';
                commentEl.style.display = 'none';
            }
            
            try {
                const response = await fetch('/.netlify/functions/ai-coach-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        activity: currentActivity,
                        trainingStatus: trainingStatus,
                        userQuestion: userQuestion
                    })
                });
                
                if (!response.ok) {
                    throw new Error('AI„Ç≥„É°„É≥„Éà„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
                const data = await response.json();
                
                if (userQuestion) {
                    // Ë≥™Âïè„Å∏„ÅÆÂõûÁ≠î„ÇíÂ±•Ê≠¥„Å´ËøΩÂä†
                    addChatMessage('coach', data.comment);
                } else {
                    // ÂàùÊúü„Ç≥„É°„É≥„Éà
                    commentEl.textContent = data.comment;
                    loadingEl.style.display = 'none';
                    commentEl.style.display = 'block';
                }
                
            } catch (error) {
                console.error('AI comment error:', error);
                
                if (!userQuestion) {
                    commentEl.textContent = generateFallbackComment();
                    loadingEl.style.display = 'none';
                    commentEl.style.display = 'block';
                } else {
                    addChatMessage('coach', 'Áî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÅÂõûÁ≠î„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„Çâ„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            }
        }
        
        function generateFallbackComment() {
            const sportType = currentActivity.sport_type || currentActivity.type;
            const distance = currentActivity.distance ? (currentActivity.distance / 1000).toFixed(1) : '0';
            const tss = currentActivity.tss || 0;
            
            let comment = `„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ${distance}km„ÅÆ${getSportLabel(sportType)}„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„Å≠„ÄÇ`;
            
            if (tss > 150) {
                comment += `\n\nTSS ${tss}„ÅØ„Åã„Å™„Çä„Éè„Éº„Éâ„Å™„Çª„ÉÉ„Ç∑„Éß„É≥„Åß„Åô„ÄÇ‰ªäÊó•„ÉªÊòéÊó•„ÅØ„Åó„Å£„Åã„ÇäÂõûÂæ©„Å´ÂÖÖ„Å¶„Çã„Åì„Å®„Çí„ÅäÂãß„ÇÅ„Åó„Åæ„Åô„ÄÇ`;
            } else if (tss > 80) {
                comment += `\n\nTSS ${tss}„ÅØÈÅ©Â∫¶„Å™Ë≤†Ëç∑„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞„Åß„Åó„Åü„ÄÇÊòéÊó•„ÅØËªΩ„ÇÅ„ÅÆ„É™„Ç´„Éê„É™„Éº„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåËâØ„ÅÑ„Åß„Åó„Çá„ÅÜ„ÄÇ`;
            } else {
                comment += `\n\nTSS ${tss}„ÅØ‰ΩéÂº∑Â∫¶„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„Åß„Åó„Åü„ÄÇÂõûÂæ©„Åó„Å™„Åå„Çâ„Éï„Ç£„ÉÉ„Éà„Éç„Çπ„ÇíÁ∂≠ÊåÅ„Åß„Åç„ÇãËâØ„ÅÑ„Éà„É¨„Éº„Éã„É≥„Ç∞„Åß„Åô„ÄÇ`;
            }
            
            if (trainingStatus) {
                comment += `\n\nÁèæÂú®„ÅÆFormÔºàTSBÔºâ„ÅØ${trainingStatus.tsb}„Åß„Åô„ÄÇ`;
                if (trainingStatus.tsb < -20) {
                    comment += 'Áñ≤Âä¥„ÅåËìÑÁ©ç„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ‰ºëÊÅØÊó•„ÇíÂÖ•„Çå„Çã„Åì„Å®„ÇíÊ§úË®é„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                } else if (trainingStatus.tsb > 15) {
                    comment += '„Éï„É¨„ÉÉ„Ç∑„É•„Å™Áä∂ÊÖã„Åß„Åô„ÄÇË≥™„ÅÆÈ´ò„ÅÑ„Éà„É¨„Éº„Éã„É≥„Ç∞„Å´ÊåëÊà¶„Åß„Åç„Çã„Çø„Ç§„Éü„É≥„Ç∞„Åß„Åô„ÄÇ';
                }
            }
            
            return comment;
        }
        
        async function askQuestion() {
            const input = document.getElementById('questionInput');
            const btn = document.getElementById('askBtn');
            const question = input.value.trim();
            
            if (!question) return;
            
            // Ë≥™Âïè„ÇíÂ±•Ê≠¥„Å´ËøΩÂä†
            addChatMessage('user', question);
            input.value = '';
            btn.disabled = true;
            btn.textContent = 'ÈÄÅ‰ø°‰∏≠...';
            
            // Â±•Ê≠¥„ÇíË°®Á§∫
            document.getElementById('chatHistory').style.display = 'block';
            
            await fetchAIComment(question);
            
            btn.disabled = false;
            btn.textContent = 'Ë≥™Âïè„Åô„Çã';
        }
        
        function addChatMessage(type, content) {
            const historyEl = document.getElementById('chatHistory');
            const label = type === 'user' ? 'üë§ „ÅÇ„Å™„Åü' : 'ü§ñ AI„Ç≥„Éº„ÉÅ';
            
            const messageHtml = `
                <div class="chat-message ${type}">
                    <div class="chat-message-label">${label}</div>
                    <div class="chat-message-content">${content}</div>
                </div>
            `;
            
            historyEl.insertAdjacentHTML('beforeend', messageHtml);
            historyEl.scrollTop = historyEl.scrollHeight;
        }
        
        // Enter„Ç≠„Éº„ÅßÈÄÅ‰ø°
        document.getElementById('questionInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askQuestion();
        });
        
        // ===== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ =====
        function getUserThresholds() {
            const saved = localStorage.getItem('user_thresholds');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {}
            }
            return { ftp: 200, rFtpPacePerKm: 300, sFtpPacePer100m: 100, maxHr: 190, thresholdHr: 170 };
        }
        
        function getSportCategory(sportType) {
            const swim = ['Swim'];
            const bike = ['Ride', 'VirtualRide', 'EBikeRide'];
            const run = ['Run', 'TrailRun', 'VirtualRun'];
            
            if (swim.includes(sportType)) return 'swim';
            if (bike.includes(sportType)) return 'bike';
            if (run.includes(sportType)) return 'run';
            return 'other';
        }
        
        function getSportLabel(sportType) {
            const labels = {
                'Run': '„É©„É≥', 'TrailRun': '„Éà„É¨„Ç§„É´', 'VirtualRun': '„Éê„Éº„ÉÅ„É£„É´„É©„É≥',
                'Ride': '„Éê„Ç§„ÇØ', 'VirtualRide': '„Éê„Éº„ÉÅ„É£„É´„É©„Ç§„Éâ', 'EBikeRide': 'E-Bike',
                'Swim': '„Çπ„Ç§„É†', 'WeightTraining': '„Ç¶„Çß„Ç§„Éà', 'Yoga': '„É®„Ç¨'
            };
            return labels[sportType] || sportType;
        }
        
        function getActivityIcon(sportType) {
            const icons = {
                'Run': 'üèÉ‚Äç‚ôÇÔ∏è', 'TrailRun': 'üèîÔ∏è', 'VirtualRun': 'üèÉ‚Äç‚ôÇÔ∏è',
                'Ride': 'üö¥‚Äç‚ôÇÔ∏è', 'VirtualRide': 'üö¥‚Äç‚ôÇÔ∏è', 'EBikeRide': 'üö¥‚Äç‚ôÇÔ∏è',
                'Swim': 'üèä‚Äç‚ôÇÔ∏è', 'WeightTraining': 'üèãÔ∏è‚Äç‚ôÇÔ∏è', 'Yoga': 'üßò‚Äç‚ôÇÔ∏è'
            };
            return icons[sportType] || 'üèÉ‚Äç‚ôÇÔ∏è';
        }
        
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            
            if (h > 0) {
                return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }
            return `${m}:${String(s).padStart(2, '0')}`;
        }
        
        function formatDurationShort(seconds) {
            if (!seconds) return '0:00';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${String(s).padStart(2, '0')}`;
        }
        
        function formatRunPace(avgSpeed) {
            if (!avgSpeed || avgSpeed <= 0) return '-';
            const pace = 1000 / avgSpeed;
            const min = Math.floor(pace / 60);
            const sec = Math.round(pace % 60);
            return `${min}:${String(sec).padStart(2, '0')}`;
        }
        
        function formatSwimPace(avgSpeed) {
            if (!avgSpeed || avgSpeed <= 0) return '-';
            const pace = 100 / avgSpeed;
            const min = Math.floor(pace / 60);
            const sec = Math.round(pace % 60);
            return `${min}:${String(sec).padStart(2, '0')}`;
        }
        
        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        function goBackToData() {
            window.location.href = 'data.html';
        }
    </script>
</body>
</html>
