<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£è©³ç´° | AI Triathlon Coach</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #dbeafe 0%, #ffffff 50%, #cffafe 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
        }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .flow-navbar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 240px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 24px 0;
            overflow-y: auto;
        }

        .flow-nav-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .flow-nav-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            text-align: center;
            padding: 0 20px 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .flow-nav-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 0 16px;
            flex: 1;
        }

        .flow-nav-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
        }

        .flow-nav-step .nav-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .flow-nav-step.current {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .flow-nav-step.available:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .content-wrapper {
            margin-left: 240px;
            flex: 1;
            padding: 24px;
            width: calc(100% - 240px);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 16px;
            transition: background 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-button:hover {
            background: #5a6268;
        }
        
        /* æ¦‚è¦ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .activity-header {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .activity-title-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .activity-icon {
            font-size: 2.5rem;
        }
        
        .activity-info h1 {
            font-size: 1.8rem;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .activity-date {
            color: #6b7280;
            font-size: 0.95rem;
        }
        
        .activity-sport-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: auto;
        }
        
        .activity-sport-badge.swim { background: #dbeafe; color: #1d4ed8; }
        .activity-sport-badge.bike { background: #f3e8ff; color: #7c3aed; }
        .activity-sport-badge.run { background: #dcfce7; color: #16a34a; }
        .activity-sport-badge.other { background: #fef3c7; color: #b45309; }
        
        /* æ¦‚è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ */
        .summary-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }
        
        .summary-metric {
            text-align: center;
            padding: 16px 12px;
            background: #f9fafb;
            border-radius: 12px;
        }
        
        .summary-metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.2;
        }
        
        .summary-metric-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        
        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .detail-grid.full-width {
            grid-template-columns: 1fr;
        }
        
        .panel {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .panel-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-content {
            padding: 20px;
        }
        
        /* åœ°å›³ */
        #routeMap {
            height: 350px;
            border-radius: 8px;
        }
        
        .no-map-message {
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 0.95rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        /* ã‚°ãƒ©ãƒ• */
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        .chart-container.small {
            height: 180px;
        }
        
        /* Zoneåˆ†å¸ƒ */
        .zone-summary {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .zone-item {
            text-align: center;
            padding: 12px 8px;
            border-radius: 8px;
            color: white;
            font-size: 0.8rem;
        }
        
        .zone-item.z1 { background: #9ca3af; }
        .zone-item.z2 { background: #3b82f6; }
        .zone-item.z3 { background: #22c55e; }
        .zone-item.z4 { background: #f97316; }
        .zone-item.z5 { background: #ef4444; }
        
        .zone-time {
            font-size: 1.1rem;
            font-weight: 700;
            display: block;
        }
        
        .zone-percent {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        /* Lapãƒ†ãƒ¼ãƒ–ãƒ« */
        .lap-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .lap-table th {
            background: #f3f4f6;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: #4b5563;
        }
        
        .lap-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .lap-table tbody tr:hover {
            background: #f9fafb;
        }
        
        /* AIã‚³ãƒ¼ãƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .ai-coach-panel {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .ai-coach-header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .ai-coach-header h2 {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .ai-coach-content {
            padding: 24px;
        }
        
        .ai-comment {
            font-size: 1rem;
            line-height: 1.8;
            color: #374151;
            white-space: pre-wrap;
        }
        
        .ai-loading {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #6b7280;
            padding: 20px 0;
        }
        
        .ai-loading .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* è³ªå•å…¥åŠ› */
        .question-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .question-section h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }
        
        .question-input-row {
            display: flex;
            gap: 12px;
        }
        
        .question-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        
        .question-input:focus {
            outline: none;
            border-color: #f97316;
        }
        
        .question-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .question-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        }
        
        .question-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* ä¼šè©±å±¥æ­´ */
        .chat-history {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .chat-message {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        
        .chat-message.user {
            background: #f3f4f6;
            margin-left: 40px;
        }
        
        .chat-message.coach {
            background: #fff7ed;
            margin-right: 40px;
        }
        
        .chat-message-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .chat-message.coach .chat-message-label {
            color: #ea580c;
        }
        
        .chat-message-content {
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        /* ã‚¨ãƒ©ãƒ¼ */
        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        /* ç¨®ç›®åˆ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹ */
        .sport-specific-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .sport-metric-card {
            background: #f9fafb;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .sport-metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .sport-metric-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 4px;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 1024px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .flow-navbar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: auto;
                width: 100%;
                height: auto;
                padding: 12px 0;
            }

            .flow-nav-logo {
                padding: 0 20px 15px;
                margin-bottom: 10px;
                font-size: 1.1rem;
            }

            .flow-nav-steps {
                flex-direction: row;
                overflow-x: auto;
                gap: 5px;
                padding: 0 10px;
            }

            .flow-nav-step {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .flow-nav-step span:not(.nav-icon) {
                display: none;
            }

            .content-wrapper {
                margin-left: 0;
                padding: 16px;
                padding-top: 140px;
                width: 100%;
            }
            
            .activity-title-row {
                flex-wrap: wrap;
            }
            
            .activity-sport-badge {
                margin-left: 0;
                margin-top: 8px;
            }
            
            .summary-metrics {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .zone-summary {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .question-input-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="flow-navbar">
        <div class="flow-nav-container">
            <div class="flow-nav-logo">AI Triathlon Coach</div>
            <div class="flow-nav-steps">
                <a href="home.html" class="flow-nav-step available">
                    <span class="nav-icon">ğŸ </span>
                    <span>ãƒ›ãƒ¼ãƒ </span>
                </a>
                <a href="index.html" class="flow-nav-step available">
                    <span class="nav-icon">ğŸ¤–</span>
                    <span>AIã‚³ãƒ¼ãƒ</span>
                </a>
                <a href="news.html" class="flow-nav-step available">
                    <span class="nav-icon">ğŸ“°</span>
                    <span>ãƒ‹ãƒ¥ãƒ¼ã‚¹</span>
                </a>
                <a href="race-selection.html" class="flow-nav-step available">
                    <span class="nav-icon">ğŸ¯</span>
                    <span>ãƒ¬ãƒ¼ã‚¹é¸æŠ</span>
                </a>
                <a href="goal-setting.html" class="flow-nav-step available">
                    <span class="nav-icon">ğŸ†</span>
                    <span>ç›®æ¨™è¨­å®š</span>
                </a>
                <a href="training-plan.html" class="flow-nav-step available">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span>è¨ˆç”»</span>
                </a>
                <a href="simulator.html" class="flow-nav-step available">
                    <span class="nav-icon">ğŸ”¬</span>
                    <span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</span>
                </a>
                <a href="data.html" class="flow-nav-step current">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>é€²æ—</span>
                </a>
                <a href="settings.html" class="flow-nav-step available">
                    <span class="nav-icon">âš™ï¸</span>
                    <span>è¨­å®š</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <div class="container">
            <button class="back-button" onclick="goBackToData()">â† é€²æ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</button>
            
            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
            <div id="loadingSection" class="loading-container">
                <div class="loading-spinner"></div>
                <p>ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
            
            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="mainContent" style="display: none;">
                <!-- æ¦‚è¦ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="activity-header">
                    <div class="activity-title-row">
                        <span class="activity-icon" id="activityIcon">ğŸƒâ€â™‚ï¸</span>
                        <div class="activity-info">
                            <h1 id="activityName">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å</h1>
                            <div class="activity-date" id="activityDate">æ—¥æ™‚</div>
                        </div>
                        <span class="activity-sport-badge run" id="sportBadge">ãƒ©ãƒ³</span>
                    </div>
                    <div class="summary-metrics" id="summaryMetrics">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- åœ°å›³ã¨ã‚¾ãƒ¼ãƒ³åˆ†æ -->
                <div class="detail-grid">
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title">ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆãƒãƒƒãƒ—</h2>
                        </div>
                        <div class="panel-content">
                            <div id="mapContainer">
                                <div id="routeMap"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title">ğŸ’“ å¿ƒæ‹ã‚¾ãƒ¼ãƒ³åˆ†å¸ƒ</h2>
                        </div>
                        <div class="panel-content">
                            <div class="zone-summary" id="zoneSummary">
                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                            <div class="chart-container small">
                                <canvas id="zoneChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å¿ƒæ‹æ•°ãƒ»ãƒšãƒ¼ã‚¹æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ• -->
                <div class="detail-grid">
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title">ğŸ’“ å¿ƒæ‹æ•°æ¨ç§»</h2>
                        </div>
                        <div class="panel-content">
                            <div class="chart-container">
                                <canvas id="hrChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title" id="paceChartTitle">â±ï¸ ãƒšãƒ¼ã‚¹æ¨ç§»</h2>
                        </div>
                        <div class="panel-content">
                            <div class="chart-container">
                                <canvas id="paceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç¨®ç›®åˆ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆãƒã‚¤ã‚¯:ãƒ‘ãƒ¯ãƒ¼/ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ã€ãƒ©ãƒ³:ãƒ”ãƒƒãƒ/ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ï¼‰ -->
                <div class="detail-grid" id="sportSpecificSection" style="display: none;">
                    <div class="panel" id="powerPanel" style="display: none;">
                        <div class="panel-header">
                            <h2 class="panel-title">âš¡ ãƒ‘ãƒ¯ãƒ¼æ¨ç§»</h2>
                        </div>
                        <div class="panel-content">
                            <div class="sport-specific-row" id="powerMetrics">
                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                            <div class="chart-container" style="margin-top: 16px;">
                                <canvas id="powerChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel" id="cadencePanel" style="display: none;">
                        <div class="panel-header">
                            <h2 class="panel-title" id="cadenceTitle">ğŸ”„ ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹æ¨ç§»</h2>
                        </div>
                        <div class="panel-content">
                            <div class="sport-specific-row" id="cadenceMetrics">
                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                            <div class="chart-container" style="margin-top: 16px;">
                                <canvas id="cadenceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lapãƒ‡ãƒ¼ã‚¿ -->
                <div class="detail-grid full-width" id="lapSection" style="display: none;">
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title">ğŸ“‹ Lapè©³ç´°</h2>
                        </div>
                        <div class="panel-content">
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="lap-table" id="lapTable">
                                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AIã‚³ãƒ¼ãƒã‚³ãƒ¡ãƒ³ãƒˆ -->
                <div class="ai-coach-panel">
                    <div class="ai-coach-header">
                        <span style="font-size: 1.5rem;">ğŸ¤–</span>
                        <h2>AIã‚³ãƒ¼ãƒã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ</h2>
                    </div>
                    <div class="ai-coach-content">
                        <div id="aiCommentLoading" class="ai-loading">
                            <div class="spinner"></div>
                            <span>AIã‚³ãƒ¼ãƒãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’åˆ†æä¸­...</span>
                        </div>
                        <div id="aiComment" class="ai-comment" style="display: none;"></div>
                        
                        <!-- è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="question-section">
                            <h3>ğŸ’¬ ã‚³ãƒ¼ãƒã«è³ªå•ã™ã‚‹</h3>
                            <div class="question-input-row">
                                <input type="text" class="question-input" id="questionInput" 
                                    placeholder="ä¾‹: æ¬¡å›ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã¯ã©ã“ã‚’æ„è­˜ã™ã¹ãï¼Ÿ">
                                <button class="question-btn" id="askBtn" onclick="askQuestion()">è³ªå•ã™ã‚‹</button>
                            </div>
                            <div class="chat-history" id="chatHistory" style="display: none;">
                                <!-- ä¼šè©±å±¥æ­´ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ã‚¨ãƒ©ãƒ¼ -->
            <div id="errorSection" style="display: none;">
                <div class="error-message">
                    <h3>âŒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                    <p id="errorMessage">ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
        let currentActivity = null;
        let streamData = null;
        let trainingStatus = null;
        let map = null;
        let charts = {};
        
        // ===== åˆæœŸåŒ– =====
        document.addEventListener('DOMContentLoaded', async () => {
            const activityId = getActivityId();
            
            if (!activityId) {
                showError('ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                await loadActivityData(activityId);
            } catch (error) {
                console.error('Error loading activity:', error);
                showError(error.message);
            }
        });
        
        function getActivityId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ =====
        async function loadActivityData(activityId) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å–å¾—
            const cachedActivities = localStorage.getItem('strava_activities');
            if (!cachedActivities) {
                throw new Error('ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚é€²æ—ãƒšãƒ¼ã‚¸ã§ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦ãã ã•ã„ã€‚');
            }
            
            const activities = JSON.parse(cachedActivities);
            currentActivity = activities.find(a => a.id.toString() === activityId.toString());
            
            if (!currentActivity) {
                throw new Error('æŒ‡å®šã•ã‚ŒãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨ˆç®—
            trainingStatus = calculateTrainingStatus(activities);
            
            // åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º
            renderActivityHeader();
            renderSummaryMetrics();
            
            // Streams APIã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            await loadStreamData(activityId);
            
            // UIã‚’è¡¨ç¤º
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // ã‚°ãƒ©ãƒ•ã‚’æç”»
            renderCharts();
            
            // AIã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
            fetchAIComment();
        }
        
        async function loadStreamData(activityId) {
            const authData = localStorage.getItem('strava_auth');
            if (!authData) {
                console.log('No auth data, skipping streams');
                return;
            }
            
            try {
                const auth = JSON.parse(authData);
                const response = await fetch('/.netlify/functions/strava-streams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: auth.access_token,
                        activityId: activityId
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.hasStreams) {
                        streamData = data.streams;
                        console.log('Stream data loaded:', Object.keys(streamData));
                    }
                }
            } catch (error) {
                console.error('Failed to load streams:', error);
            }
        }
        
        // ===== ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®— =====
        function calculateTrainingStatus(activities) {
            if (activities.length === 0) return null;
            
            const dailyTss = {};
            activities.forEach(activity => {
                const date = activity.start_date.split('T')[0];
                if (!dailyTss[date]) dailyTss[date] = 0;
                dailyTss[date] += activity.tss || 0;
            });
            
            const today = new Date();
            const days = [];
            for (let i = 89; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                days.push({ date: dateStr, tss: dailyTss[dateStr] || 0 });
            }
            
            const ctlFactor = 1 - Math.exp(-1 / 42);
            const atlFactor = 1 - Math.exp(-1 / 7);
            
            let ctl = 0, atl = 0, prevCtl = 0;
            
            days.forEach((day, i) => {
                ctl = ctl + (day.tss - ctl) * ctlFactor;
                atl = atl + (day.tss - atl) * atlFactor;
                if (i === days.length - 8) prevCtl = ctl;
            });
            
            return {
                ctl: Math.round(ctl * 10) / 10,
                atl: Math.round(atl * 10) / 10,
                tsb: Math.round((ctl - atl) * 10) / 10,
                ctlTrend: Math.round((ctl - prevCtl) * 10) / 10
            };
        }
        
        // ===== ãƒ˜ãƒƒãƒ€ãƒ¼æç”» =====
        function renderActivityHeader() {
            const sportType = currentActivity.sport_type || currentActivity.type;
            const sportCategory = getSportCategory(sportType);
            
            document.getElementById('activityIcon').textContent = getActivityIcon(sportType);
            document.getElementById('activityName').textContent = currentActivity.name || 'ç„¡é¡Œã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£';
            document.getElementById('activityDate').textContent = new Date(currentActivity.start_date).toLocaleString('ja-JP', {
                year: 'numeric', month: 'long', day: 'numeric',
                weekday: 'short', hour: '2-digit', minute: '2-digit'
            });
            
            const badge = document.getElementById('sportBadge');
            badge.textContent = getSportLabel(sportType);
            badge.className = `activity-sport-badge ${sportCategory}`;
        }
        
        function renderSummaryMetrics() {
            const sportType = currentActivity.sport_type || currentActivity.type;
            const sportCategory = getSportCategory(sportType);
            
            let html = '';
            
            // è·é›¢
            if (currentActivity.distance) {
                html += createMetricCard((currentActivity.distance / 1000).toFixed(2), 'km', 'è·é›¢');
            }
            
            // æ™‚é–“
            html += createMetricCard(formatDuration(currentActivity.moving_time), '', 'æ™‚é–“');
            
            // ãƒšãƒ¼ã‚¹/é€Ÿåº¦
            if (currentActivity.average_speed) {
                if (sportCategory === 'swim') {
                    html += createMetricCard(formatSwimPace(currentActivity.average_speed), '/100m', 'ãƒšãƒ¼ã‚¹');
                } else if (sportCategory === 'bike') {
                    html += createMetricCard((currentActivity.average_speed * 3.6).toFixed(1), 'km/h', 'å¹³å‡é€Ÿåº¦');
                } else {
                    html += createMetricCard(formatRunPace(currentActivity.average_speed), '/km', 'ãƒšãƒ¼ã‚¹');
                }
            }
            
            // å¿ƒæ‹
            if (currentActivity.average_heartrate) {
                html += createMetricCard(Math.round(currentActivity.average_heartrate), 'bpm', 'å¹³å‡å¿ƒæ‹');
            }
            
            // TSS
            if (currentActivity.tss) {
                html += createMetricCard(currentActivity.tss, '', 'TSS');
            }
            
            // æ¨™é«˜
            if (currentActivity.total_elevation_gain && currentActivity.total_elevation_gain > 10) {
                html += createMetricCard(Math.round(currentActivity.total_elevation_gain), 'm', 'ç²å¾—æ¨™é«˜');
            }
            
            document.getElementById('summaryMetrics').innerHTML = html;
        }
        
        function createMetricCard(value, unit, label) {
            return `
                <div class="summary-metric">
                    <div class="summary-metric-value">${value}<small style="font-size: 0.6em; font-weight: 400;">${unit}</small></div>
                    <div class="summary-metric-label">${label}</div>
                </div>
            `;
        }
        
        // ===== ã‚°ãƒ©ãƒ•æç”» =====
        function renderCharts() {
            renderMap();
            renderZoneChart();
            renderHeartRateChart();
            renderPaceChart();
            renderSportSpecificCharts();
            renderLapTable();
        }
        
        function renderMap() {
            const mapContainer = document.getElementById('mapContainer');
            
            if (!streamData || !streamData.latlng || !streamData.latlng.data || streamData.latlng.data.length === 0) {
                mapContainer.innerHTML = '<div class="no-map-message">ğŸ—ºï¸ GPSãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚¤ãƒ³ãƒ‰ã‚¢ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®å¯èƒ½æ€§ï¼‰</div>';
                return;
            }
            
            const coords = streamData.latlng.data;
            
            map = L.map('routeMap');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            
            const polyline = L.polyline(coords, { color: '#667eea', weight: 4, opacity: 0.8 }).addTo(map);
            map.fitBounds(polyline.getBounds(), { padding: [20, 20] });
            
            // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»ã‚´ãƒ¼ãƒ«ãƒãƒ¼ã‚«ãƒ¼
            const startIcon = L.divIcon({ className: 'start-marker', html: 'ğŸŸ¢', iconSize: [24, 24] });
            const endIcon = L.divIcon({ className: 'end-marker', html: 'ğŸ', iconSize: [24, 24] });
            
            L.marker(coords[0], { icon: startIcon }).addTo(map);
            L.marker(coords[coords.length - 1], { icon: endIcon }).addTo(map);
        }
        
        function renderZoneChart() {
            const zones = calculateHeartRateZones();
            
            // Zone ã‚µãƒãƒªãƒ¼
            const zoneSummaryHtml = zones.map((z, i) => `
                <div class="zone-item z${i + 1}">
                    <span class="zone-time">${formatDurationShort(z.time)}</span>
                    <span class="zone-percent">${z.percent.toFixed(0)}%</span>
                </div>
            `).join('');
            document.getElementById('zoneSummary').innerHTML = zoneSummaryHtml;
            
            // Zone ãƒãƒ£ãƒ¼ãƒˆ
            const ctx = document.getElementById('zoneChart').getContext('2d');
            if (charts.zone) charts.zone.destroy();
            
            charts.zone = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Z1', 'Z2', 'Z3', 'Z4', 'Z5'],
                    datasets: [{
                        data: zones.map(z => z.percent),
                        backgroundColor: ['#9ca3af', '#3b82f6', '#22c55e', '#f97316', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, title: { display: true, text: '%' } }
                    }
                }
            });
        }
        
        function calculateHeartRateZones() {
            const thresholds = getUserThresholds();
            const maxHr = thresholds.maxHr || 190;
            const totalTime = currentActivity.moving_time || 0;
            
            // Streamãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è©³ç´°è¨ˆç®—
            if (streamData && streamData.heartrate && streamData.heartrate.data && streamData.time) {
                const hrData = streamData.heartrate.data;
                const timeData = streamData.time.data;
                
                const zoneTimes = [0, 0, 0, 0, 0];
                
                for (let i = 1; i < hrData.length; i++) {
                    const hr = hrData[i];
                    const duration = timeData[i] - timeData[i - 1];
                    const hrPercent = (hr / maxHr) * 100;
                    
                    if (hrPercent < 60) zoneTimes[0] += duration;
                    else if (hrPercent < 70) zoneTimes[1] += duration;
                    else if (hrPercent < 80) zoneTimes[2] += duration;
                    else if (hrPercent < 90) zoneTimes[3] += duration;
                    else zoneTimes[4] += duration;
                }
                
                const total = zoneTimes.reduce((a, b) => a + b, 0) || 1;
                return zoneTimes.map(t => ({ time: t, percent: (t / total) * 100 }));
            }
            
            // å¹³å‡å¿ƒæ‹ã‹ã‚‰æ¨å®š
            const avgHr = currentActivity.average_heartrate;
            if (!avgHr) return [0, 1, 2, 3, 4].map(() => ({ time: 0, percent: 0 }));
            
            const hrPercent = (avgHr / maxHr) * 100;
            const zones = [0, 0, 0, 0, 0];
            
            if (hrPercent < 60) zones[0] = 100;
            else if (hrPercent < 70) zones[1] = 100;
            else if (hrPercent < 80) zones[2] = 100;
            else if (hrPercent < 90) zones[3] = 100;
            else zones[4] = 100;
            
            return zones.map((p, i) => ({ time: p > 0 ? totalTime : 0, percent: p }));
        }
        
        function renderHeartRateChart() {
            const ctx = document.getElementById('hrChart').getContext('2d');
            if (charts.hr) charts.hr.destroy();
            
            if (!streamData || !streamData.heartrate || !streamData.heartrate.data) {
                ctx.canvas.parentElement.innerHTML = '<div class="no-map-message">å¿ƒæ‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            const hrData = streamData.heartrate.data;
            const timeData = streamData.time?.data || hrData.map((_, i) => i);
            const distanceData = streamData.distance?.data;
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆå¤šã™ãã‚‹å ´åˆï¼‰
            const maxPoints = 500;
            const step = Math.max(1, Math.floor(hrData.length / maxPoints));
            
            const labels = [];
            const data = [];
            
            for (let i = 0; i < hrData.length; i += step) {
                if (distanceData) {
                    labels.push((distanceData[i] / 1000).toFixed(1));
                } else {
                    labels.push(formatDurationShort(timeData[i]));
                }
                data.push(hrData[i]);
            }
            
            charts.hr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å¿ƒæ‹æ•°',
                        data: data,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: distanceData ? 'è·é›¢ (km)' : 'æ™‚é–“' } },
                        y: { title: { display: true, text: 'bpm' } }
                    }
                }
            });
        }
        
        function renderPaceChart() {
            const ctx = document.getElementById('paceChart').getContext('2d');
            if (charts.pace) charts.pace.destroy();
            
            const sportCategory = getSportCategory(currentActivity.sport_type || currentActivity.type);
            
            if (sportCategory === 'bike') {
                document.getElementById('paceChartTitle').textContent = 'ğŸš´ é€Ÿåº¦æ¨ç§»';
            }
            
            if (!streamData || !streamData.velocity_smooth || !streamData.velocity_smooth.data) {
                ctx.canvas.parentElement.innerHTML = '<div class="no-map-message">ãƒšãƒ¼ã‚¹/é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            const velData = streamData.velocity_smooth.data;
            const distanceData = streamData.distance?.data;
            const timeData = streamData.time?.data || velData.map((_, i) => i);
            
            // é€Ÿåº¦ã®é–¾å€¤ã‚’è¨­å®šï¼ˆåœæ­¢ã‚„æ­©è¡Œã‚’é™¤å¤–ï¼‰
            const minVelocity = getMinVelocityThreshold(sportCategory);
            
            const maxPoints = 500;
            const step = Math.max(1, Math.floor(velData.length / maxPoints));
            
            const labels = [];
            const data = [];
            const rawPaceValues = []; // Yè»¸ç¯„å›²è¨ˆç®—ç”¨
            
            for (let i = 0; i < velData.length; i += step) {
                if (distanceData) {
                    labels.push((distanceData[i] / 1000).toFixed(1));
                } else {
                    labels.push(formatDurationShort(timeData[i]));
                }
                
                const vel = velData[i];
                
                if (sportCategory === 'bike') {
                    const speed = vel * 3.6; // km/h
                    data.push(speed);
                    if (vel >= minVelocity) rawPaceValues.push(speed);
                } else if (sportCategory === 'swim') {
                    const pace = vel > 0 ? 100 / vel : null; // sec/100m
                    data.push(pace);
                    if (vel >= minVelocity && pace) rawPaceValues.push(pace);
                } else {
                    // ãƒ©ãƒ³: min/km
                    const pace = vel > 0 ? 1000 / vel / 60 : null;
                    data.push(pace);
                    if (vel >= minVelocity && pace) rawPaceValues.push(pace);
                }
            }
            
            // Yè»¸ã®ç¯„å›²ã‚’è¨ˆç®—ï¼ˆå¤–ã‚Œå€¤ã‚’é™¤å¤–ï¼‰
            const yAxisRange = calculateYAxisRange(rawPaceValues, sportCategory);
            
            const yLabel = sportCategory === 'bike' ? 'km/h' : sportCategory === 'swim' ? 'sec/100m' : 'min/km';
            
            charts.pace = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: sportCategory === 'bike' ? 'é€Ÿåº¦' : 'ãƒšãƒ¼ã‚¹',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        spanGaps: true // nullå€¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç·šã‚’ç¹‹ã
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: distanceData ? 'è·é›¢ (km)' : 'æ™‚é–“' } },
                        y: { 
                            title: { display: true, text: yLabel },
                            reverse: sportCategory !== 'bike', // ãƒšãƒ¼ã‚¹ã¯é€†é †ï¼ˆé€Ÿã„ã»ã©ä¸Šï¼‰
                            min: yAxisRange.min,
                            max: yAxisRange.max,
                            ticks: {
                                callback: function(value) {
                                    if (sportCategory === 'bike') {
                                        return value.toFixed(0);
                                    } else {
                                        // ãƒšãƒ¼ã‚¹ã‚’mm:sså½¢å¼ã§è¡¨ç¤º
                                        const min = Math.floor(value);
                                        const sec = Math.round((value - min) * 60);
                                        return `${min}:${String(sec).padStart(2, '0')}`;
                                    }
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    if (value === null) return 'åœæ­¢ä¸­';
                                    if (sportCategory === 'bike') {
                                        return `é€Ÿåº¦: ${value.toFixed(1)} km/h`;
                                    } else {
                                        const min = Math.floor(value);
                                        const sec = Math.round((value - min) * 60);
                                        return `ãƒšãƒ¼ã‚¹: ${min}:${String(sec).padStart(2, '0')} ${sportCategory === 'swim' ? '/100m' : '/km'}`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ç¨®ç›®åˆ¥ã®æœ€å°é€Ÿåº¦é–¾å€¤ï¼ˆã“ã‚Œä»¥ä¸‹ã¯åœæ­¢/æ­©è¡Œã¨ã¿ãªã™ï¼‰
        function getMinVelocityThreshold(sportCategory) {
            switch (sportCategory) {
                case 'bike':
                    return 3.0; // 10.8 km/h ä»¥ä¸‹ã¯é™¤å¤–
                case 'run':
                    return 1.5; // 5.4 km/h (ç´„11:00/km) ä»¥ä¸‹ã¯é™¤å¤–
                case 'swim':
                    return 0.3; // 3:20/100m ã‚ˆã‚Šé…ã„ã‚‚ã®ã¯é™¤å¤–
                default:
                    return 1.0;
            }
        }
        
        // Yè»¸ã®ç¯„å›²ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã§è¨ˆç®—
        function calculateYAxisRange(values, sportCategory) {
            if (values.length === 0) {
                return { min: undefined, max: undefined };
            }
            
            // ã‚½ãƒ¼ãƒˆã—ã¦ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ã‚’è¨ˆç®—
            const sorted = [...values].sort((a, b) => a - b);
            const p5 = sorted[Math.floor(sorted.length * 0.05)];
            const p95 = sorted[Math.floor(sorted.length * 0.95)];
            const median = sorted[Math.floor(sorted.length * 0.5)];
            
            // ç¯„å›²ã‚’è¨ˆç®—ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ã‚’åŸºæº–ã«å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ï¼‰
            const range = p95 - p5;
            const padding = range * 0.15; // 15%ã®ä½™ç™½
            
            if (sportCategory === 'bike') {
                // é€Ÿåº¦ã®å ´åˆï¼šé€Ÿã„ã»ã©ä¸Šãªã®ã§é€šå¸¸ã®min/max
                return {
                    min: Math.max(0, Math.floor(p5 - padding)),
                    max: Math.ceil(p95 + padding)
                };
            } else {
                // ãƒšãƒ¼ã‚¹ã®å ´åˆï¼šé…ã„ã»ã©æ•°å€¤ãŒå¤§ãã„ï¼ˆã‚°ãƒ©ãƒ•ã¯åè»¢ã™ã‚‹ã®ã§minãŒé€Ÿã„ã€maxãŒé…ã„ï¼‰
                // ã‚ˆã‚Šç´°ã‹ã„ãƒšãƒ¼ã‚¹å¤‰å‹•ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ç¯„å›²ã‚’ç‹­ã‚ã‚‹
                const minPace = Math.max(0, p5 - padding * 0.5); // é€Ÿã„å´ï¼ˆæ•°å€¤å°ã•ã„ï¼‰
                const maxPace = p95 + padding * 0.5; // é…ã„å´ï¼ˆæ•°å€¤å¤§ãã„ï¼‰
                
                // ãƒ©ãƒ³ã®å ´åˆã€è¡¨ç¤ºç¯„å›²ã‚’é©åˆ‡ã«åˆ¶é™ï¼ˆä¾‹ï¼š3:00ã€œ8:00/kmç¨‹åº¦ã«åã‚ã‚‹ï¼‰
                if (sportCategory === 'run') {
                    return {
                        min: Math.max(2.5, minPace), // æœ€é€Ÿã§ã‚‚2:30/km
                        max: Math.min(10, maxPace)   // æœ€é…ã§ã‚‚10:00/km
                    };
                } else if (sportCategory === 'swim') {
                    return {
                        min: Math.max(60, minPace),  // æœ€é€Ÿã§ã‚‚1:00/100m
                        max: Math.min(180, maxPace)  // æœ€é…ã§ã‚‚3:00/100m
                    };
                }
                
                return { min: minPace, max: maxPace };
            }
        }
        
        function renderSportSpecificCharts() {
            const sportCategory = getSportCategory(currentActivity.sport_type || currentActivity.type);
            
            if (sportCategory === 'bike') {
                renderBikeCharts();
            } else if (sportCategory === 'run') {
                renderRunCharts();
            }
        }
        
        function renderBikeCharts() {
            document.getElementById('sportSpecificSection').style.display = 'grid';
            
            // ãƒ‘ãƒ¯ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
            if (streamData && streamData.watts && streamData.watts.data) {
                document.getElementById('powerPanel').style.display = 'block';
                
                // ãƒ‘ãƒ¯ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹
                const avgPower = currentActivity.average_watts || 0;
                const np = currentActivity.weighted_average_watts || 0;
                document.getElementById('powerMetrics').innerHTML = `
                    <div class="sport-metric-card">
                        <div class="sport-metric-value">${Math.round(avgPower)}</div>
                        <div class="sport-metric-label">å¹³å‡ãƒ‘ãƒ¯ãƒ¼ (W)</div>
                    </div>
                    <div class="sport-metric-card">
                        <div class="sport-metric-value">${Math.round(np)}</div>
                        <div class="sport-metric-label">NP (W)</div>
                    </div>
                `;
                
                renderTimeSeriesChart('powerChart', streamData.watts.data, 'ãƒ‘ãƒ¯ãƒ¼', '#8b5cf6', 'W');
            }
            
            // ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆ
            if (streamData && streamData.cadence && streamData.cadence.data) {
                document.getElementById('cadencePanel').style.display = 'block';
                document.getElementById('cadenceTitle').textContent = 'ğŸ”„ ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹æ¨ç§»';
                
                const avgCadence = currentActivity.average_cadence || 0;
                document.getElementById('cadenceMetrics').innerHTML = `
                    <div class="sport-metric-card">
                        <div class="sport-metric-value">${Math.round(avgCadence)}</div>
                        <div class="sport-metric-label">å¹³å‡ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ (rpm)</div>
                    </div>
                `;
                
                renderTimeSeriesChart('cadenceChart', streamData.cadence.data, 'ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹', '#22c55e', 'rpm');
            }
        }
        
        function renderRunCharts() {
            document.getElementById('sportSpecificSection').style.display = 'grid';
            
            // ãƒ”ãƒƒãƒ/ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆ
            if (streamData && streamData.cadence && streamData.cadence.data) {
                document.getElementById('cadencePanel').style.display = 'block';
                document.getElementById('cadenceTitle').textContent = 'ğŸ‘Ÿ ãƒ”ãƒƒãƒæ¨ç§»';
                
                const avgCadence = currentActivity.average_cadence || 0;
                document.getElementById('cadenceMetrics').innerHTML = `
                    <div class="sport-metric-card">
                        <div class="sport-metric-value">${Math.round(avgCadence * 2)}</div>
                        <div class="sport-metric-label">å¹³å‡ãƒ”ãƒƒãƒ (spm)</div>
                    </div>
                `;
                
                // ãƒ©ãƒ³ã®å ´åˆã¯ã‚±ã‚¤ãƒ‡ãƒ³ã‚¹ã‚’2å€ï¼ˆå·¦å³åˆè¨ˆï¼‰
                const pitchData = streamData.cadence.data.map(c => c * 2);
                renderTimeSeriesChart('cadenceChart', pitchData, 'ãƒ”ãƒƒãƒ', '#22c55e', 'spm');
            }
        }
        
        function renderTimeSeriesChart(canvasId, data, label, color, unit) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[canvasId]) charts[canvasId].destroy();
            
            const distanceData = streamData?.distance?.data;
            const timeData = streamData?.time?.data || data.map((_, i) => i);
            
            const maxPoints = 500;
            const step = Math.max(1, Math.floor(data.length / maxPoints));
            
            const labels = [];
            const chartData = [];
            
            for (let i = 0; i < data.length; i += step) {
                if (distanceData) {
                    labels.push((distanceData[i] / 1000).toFixed(1));
                } else {
                    labels.push(formatDurationShort(timeData[i]));
                }
                chartData.push(data[i]);
            }
            
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: chartData,
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: distanceData ? 'è·é›¢ (km)' : 'æ™‚é–“' } },
                        y: { title: { display: true, text: unit } }
                    }
                }
            });
        }
        
        function renderLapTable() {
            if (!currentActivity.laps || currentActivity.laps.length === 0) {
                return;
            }
            
            document.getElementById('lapSection').style.display = 'block';
            const sportCategory = getSportCategory(currentActivity.sport_type || currentActivity.type);
            
            let html = `
                <thead>
                    <tr>
                        <th>Lap</th>
                        <th>è·é›¢</th>
                        <th>æ™‚é–“</th>
                        <th>${sportCategory === 'bike' ? 'é€Ÿåº¦' : 'ãƒšãƒ¼ã‚¹'}</th>
                        <th>å¿ƒæ‹</th>
                        ${sportCategory === 'bike' ? '<th>ãƒ‘ãƒ¯ãƒ¼</th>' : ''}
                    </tr>
                </thead>
                <tbody>
            `;
            
            currentActivity.laps.forEach((lap, index) => {
                const pace = sportCategory === 'bike' 
                    ? `${(lap.average_speed * 3.6).toFixed(1)} km/h`
                    : formatRunPace(lap.average_speed);
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${(lap.distance / 1000).toFixed(2)} km</td>
                        <td>${formatDuration(lap.moving_time || lap.elapsed_time)}</td>
                        <td>${pace}</td>
                        <td>${lap.average_heartrate ? Math.round(lap.average_heartrate) : '-'}</td>
                        ${sportCategory === 'bike' ? `<td>${lap.average_watts ? Math.round(lap.average_watts) : '-'} W</td>` : ''}
                    </tr>
                `;
            });
            
            html += '</tbody>';
            document.getElementById('lapTable').innerHTML = html;
        }
        
        // ===== AIã‚³ãƒ¡ãƒ³ãƒˆ =====
        async function fetchAIComment(userQuestion = null) {
            const loadingEl = document.getElementById('aiCommentLoading');
            const commentEl = document.getElementById('aiComment');
            
            if (!userQuestion) {
                loadingEl.style.display = 'flex';
                commentEl.style.display = 'none';
            }
            
            try {
                const response = await fetch('/.netlify/functions/ai-coach-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        activity: currentActivity,
                        trainingStatus: trainingStatus,
                        userQuestion: userQuestion
                    })
                });
                
                if (!response.ok) {
                    throw new Error('AIã‚³ãƒ¡ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const data = await response.json();
                
                if (userQuestion) {
                    // è³ªå•ã¸ã®å›ç­”ã‚’å±¥æ­´ã«è¿½åŠ 
                    addChatMessage('coach', data.comment);
                } else {
                    // åˆæœŸã‚³ãƒ¡ãƒ³ãƒˆ
                    commentEl.textContent = data.comment;
                    loadingEl.style.display = 'none';
                    commentEl.style.display = 'block';
                }
                
            } catch (error) {
                console.error('AI comment error:', error);
                
                if (!userQuestion) {
                    commentEl.textContent = generateFallbackComment();
                    loadingEl.style.display = 'none';
                    commentEl.style.display = 'block';
                } else {
                    addChatMessage('coach', 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€å›ç­”ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
            }
        }
        
        function generateFallbackComment() {
            const sportType = currentActivity.sport_type || currentActivity.type;
            const sportCategory = getSportCategory(sportType);
            const distance = currentActivity.distance ? (currentActivity.distance / 1000).toFixed(1) : '0';
            const tss = currentActivity.tss || 0;
            const avgHr = currentActivity.average_heartrate;
            const duration = (currentActivity.moving_time || 0) / 60;
            
            let comment = `ğŸƒ **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç·è©•**\n`;
            comment += `${distance}kmã®${getSportLabel(sportType)}ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼`;
            
            // æ™‚é–“ã«åŸºã¥ãã‚³ãƒ¡ãƒ³ãƒˆ
            if (duration > 120) {
                comment += `${Math.round(duration)}åˆ†ã¨ã„ã†é•·æ™‚é–“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚„ã‚Šé‚ã’ãŸã“ã¨ã¯ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚`;
            } else if (duration > 60) {
                comment += `1æ™‚é–“ä»¥ä¸Šã®ã—ã£ã‹ã‚Šã¨ã—ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã—ãŸã­ã€‚`;
            }
            
            // TSSåŸºã¥ãå¼·åº¦è©•ä¾¡
            comment += `\n\nğŸ’ª **å¼·åº¦ã¨åŠ¹æœ**\n`;
            if (tss > 150) {
                comment += `TSS ${tss}ã¯é«˜å¼·åº¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã™ã€‚å¿ƒè‚ºæ©Ÿèƒ½ã¨ä¹³é…¸é–¾å€¤ã®å‘ä¸Šã«å¤§ããè²¢çŒ®ã™ã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã—ãŸã€‚`;
            } else if (tss > 80) {
                comment += `TSS ${tss}ã¯é©åº¦ãªè² è·ã§ã€æœ‰é…¸ç´ ãƒ™ãƒ¼ã‚¹ã®æ§‹ç¯‰ã«åŠ¹æœçš„ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã—ãŸã€‚`;
            } else {
                comment += `TSS ${tss}ã¯ä½ã€œä¸­å¼·åº¦ã§ã€å›å¾©ã‚’ä¿ƒã—ãªãŒã‚‰ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚’ç¶­æŒã™ã‚‹è‰¯ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã—ãŸã€‚`;
            }
            
            // å¿ƒæ‹æ•°ã«åŸºã¥ãã‚³ãƒ¡ãƒ³ãƒˆ
            if (avgHr) {
                const hr = Math.round(avgHr);
                comment += `\n\nğŸ’“ **å¿ƒæ‹åˆ†æ**\n`;
                if (hr < 140) {
                    comment += `å¹³å‡å¿ƒæ‹${hr}bpmã¯æœ‰é…¸ç´ ã‚¾ãƒ¼ãƒ³ï¼ˆZone 1-2ï¼‰ã§ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã™ã€‚ãƒŸãƒˆã‚³ãƒ³ãƒ‰ãƒªã‚¢ã®å¢—åŠ ã¨è„‚è‚ªç‡ƒç„¼åŠ¹ç‡ã®å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚`;
                } else if (hr < 160) {
                    comment += `å¹³å‡å¿ƒæ‹${hr}bpmã¯ä¸­å¼·åº¦ã‚¾ãƒ¼ãƒ³ï¼ˆZone 3ï¼‰ä»˜è¿‘ã§ã™ã€‚æŒä¹…åŠ›ã®åŸºç›¤æ§‹ç¯‰ã¨ä¹³é…¸å‡¦ç†èƒ½åŠ›ã®å‘ä¸Šã«åŠ¹æœçš„ã§ã™ã€‚`;
                } else {
                    comment += `å¹³å‡å¿ƒæ‹${hr}bpmã¯é«˜å¼·åº¦ã‚¾ãƒ¼ãƒ³ï¼ˆZone 4-5ï¼‰ã§ã™ã€‚VO2maxã®å‘ä¸Šã¨é«˜å¼·åº¦ã¸ã®è€æ€§æ§‹ç¯‰ã«è²¢çŒ®ã—ã¾ã™ã€‚`;
                }
            }
            
            // ç¨®ç›®åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆ
            comment += `\n\nğŸ¯ **ç¨®ç›®åˆ¥ãƒã‚¤ãƒ³ãƒˆ**\n`;
            if (sportCategory === 'swim') {
                comment += `ã‚¹ã‚¤ãƒ ã¯å…¨èº«ã®ç­‹ç¾¤ã‚’ä½¿ç”¨ã—ã€é–¢ç¯€ã¸ã®è² æ‹…ãŒå°‘ãªã„çŠ¶æ…‹ã§å¿ƒè‚ºæ©Ÿèƒ½ã‚’å‘ä¸Šã•ã›ã‚‹å„ªã‚ŒãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã™ã€‚`;
            } else if (sportCategory === 'bike') {
                comment += `ãƒã‚¤ã‚¯ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¯ä¸‹è‚¢ã®ç­‹æŒä¹…åŠ›ã¨å¿ƒè¡€ç®¡ç³»ã®å¼·åŒ–ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚ãƒšãƒ€ãƒªãƒ³ã‚°åŠ¹ç‡ã‚’æ„è­˜ã™ã‚‹ã“ã¨ã§ã€ã•ã‚‰ã«åŠ¹æœãŒé«˜ã¾ã‚Šã¾ã™ã€‚`;
            } else if (sportCategory === 'run') {
                comment += `ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã¯éª¨å¯†åº¦ã®å‘ä¸Šã¨ä¸‹è‚¢ç­‹åŠ›ã®å¼·åŒ–ã«åŠ¹æœçš„ã§ã™ã€‚ç€åœ°è¡æ’ƒã«ã‚ˆã‚‹é©å¿œã¯ã€éª¨æ ¼ç³»ã®å¼·åŒ–ã«ã‚‚ã¤ãªãŒã‚Šã¾ã™ã€‚`;
            }
            
            // å›å¾©ã‚¢ãƒ‰ãƒã‚¤ã‚¹
            comment += `\n\nğŸ”„ **ãƒªã‚«ãƒãƒªãƒ¼ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**\n`;
            if (tss > 150) {
                comment += `ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾Œã¯24-48æ™‚é–“ã®å›å¾©ã‚’æ¨å¥¨ã—ã¾ã™ã€‚æ˜æ—¥ã¯å®Œå…¨ä¼‘é¤Šã‹ã€è»½ã„ãƒªã‚«ãƒãƒªãƒ¼ã‚¹ã‚¤ãƒ /ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ã«ã¨ã©ã‚ã¾ã—ã‚‡ã†ã€‚`;
            } else if (tss > 80) {
                comment += `æ˜æ—¥ã¯è»½ã‚ã®ãƒªã‚«ãƒãƒªãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚Zone 1-2ã§ã®30-45åˆ†ç¨‹åº¦ã®è»½ã„é‹å‹•ã§è¡€æµã‚’ä¿ƒé€²ã—ã¾ã—ã‚‡ã†ã€‚`;
            } else {
                comment += `æ˜æ—¥ã‚‚é€šå¸¸é€šã‚Šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç¶™ç¶šã§ãã¾ã™ã€‚è³ªã®é«˜ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æŒ‘æˆ¦ã™ã‚‹ã®ã‚‚è‰¯ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚`;
            }
            
            // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åŸºã¥ãã‚³ãƒ¡ãƒ³ãƒˆ
            if (trainingStatus) {
                comment += `\n\nğŸ“ˆ **ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³çŠ¶æ³**\n`;
                comment += `ç¾åœ¨ã®Fitnessï¼ˆCTLï¼‰ã¯${trainingStatus.ctl}ã€Formï¼ˆTSBï¼‰ã¯${trainingStatus.tsb}ã§ã™ã€‚`;
                
                if (trainingStatus.tsb < -20) {
                    comment += `ç–²åŠ´ãŒè“„ç©ã—ã¦ã„ã¾ã™ã€‚1-2æ—¥ã®ä¼‘æ¯ã‚’å…¥ã‚Œã¦ã€ã‚ªãƒ¼ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é˜²ãã¾ã—ã‚‡ã†ã€‚`;
                } else if (trainingStatus.tsb < -10) {
                    comment += `é©åº¦ãªè² è·çŠ¶æ…‹ã§ã™ã€‚ã“ã®ã¾ã¾ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç¶™ç¶šã—ã¤ã¤ã€å›å¾©ã«ã‚‚æ°—ã‚’é…ã‚Šã¾ã—ã‚‡ã†ã€‚`;
                } else if (trainingStatus.tsb > 15) {
                    comment += `ãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãªçŠ¶æ…‹ã§ã™ï¼è³ªã®é«˜ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã«æŒ‘æˆ¦ã™ã‚‹çµ¶å¥½ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚`;
                } else {
                    comment += `ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸçŠ¶æ…‹ã§ã™ã€‚è¨ˆç”»é€šã‚Šã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚`;
                }
            }
            
            return comment;
        }
        
        async function askQuestion() {
            const input = document.getElementById('questionInput');
            const btn = document.getElementById('askBtn');
            const question = input.value.trim();
            
            if (!question) return;
            
            // è³ªå•ã‚’å±¥æ­´ã«è¿½åŠ 
            addChatMessage('user', question);
            input.value = '';
            btn.disabled = true;
            btn.textContent = 'é€ä¿¡ä¸­...';
            
            // å±¥æ­´ã‚’è¡¨ç¤º
            document.getElementById('chatHistory').style.display = 'block';
            
            await fetchAIComment(question);
            
            btn.disabled = false;
            btn.textContent = 'è³ªå•ã™ã‚‹';
        }
        
        function addChatMessage(type, content) {
            const historyEl = document.getElementById('chatHistory');
            const label = type === 'user' ? 'ğŸ‘¤ ã‚ãªãŸ' : 'ğŸ¤– AIã‚³ãƒ¼ãƒ';
            
            const messageHtml = `
                <div class="chat-message ${type}">
                    <div class="chat-message-label">${label}</div>
                    <div class="chat-message-content">${content}</div>
                </div>
            `;
            
            historyEl.insertAdjacentHTML('beforeend', messageHtml);
            historyEl.scrollTop = historyEl.scrollHeight;
        }
        
        // Enterã‚­ãƒ¼ã§é€ä¿¡
        document.getElementById('questionInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askQuestion();
        });
        
        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
        function getUserThresholds() {
            const saved = localStorage.getItem('user_thresholds');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {}
            }
            return { ftp: 200, rFtpPacePerKm: 300, sFtpPacePer100m: 100, maxHr: 190, thresholdHr: 170 };
        }
        
        function getSportCategory(sportType) {
            const swim = ['Swim'];
            const bike = ['Ride', 'VirtualRide', 'EBikeRide'];
            const run = ['Run', 'TrailRun', 'VirtualRun'];
            
            if (swim.includes(sportType)) return 'swim';
            if (bike.includes(sportType)) return 'bike';
            if (run.includes(sportType)) return 'run';
            return 'other';
        }
        
        function getSportLabel(sportType) {
            const labels = {
                'Run': 'ãƒ©ãƒ³', 'TrailRun': 'ãƒˆãƒ¬ã‚¤ãƒ«', 'VirtualRun': 'ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ©ãƒ³',
                'Ride': 'ãƒã‚¤ã‚¯', 'VirtualRide': 'ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ©ã‚¤ãƒ‰', 'EBikeRide': 'E-Bike',
                'Swim': 'ã‚¹ã‚¤ãƒ ', 'WeightTraining': 'ã‚¦ã‚§ã‚¤ãƒˆ', 'Yoga': 'ãƒ¨ã‚¬'
            };
            return labels[sportType] || sportType;
        }
        
        function getActivityIcon(sportType) {
            const icons = {
                'Run': 'ğŸƒâ€â™‚ï¸', 'TrailRun': 'ğŸ”ï¸', 'VirtualRun': 'ğŸƒâ€â™‚ï¸',
                'Ride': 'ğŸš´â€â™‚ï¸', 'VirtualRide': 'ğŸš´â€â™‚ï¸', 'EBikeRide': 'ğŸš´â€â™‚ï¸',
                'Swim': 'ğŸŠâ€â™‚ï¸', 'WeightTraining': 'ğŸ‹ï¸â€â™‚ï¸', 'Yoga': 'ğŸ§˜â€â™‚ï¸'
            };
            return icons[sportType] || 'ğŸƒâ€â™‚ï¸';
        }
        
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            
            if (h > 0) {
                return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }
            return `${m}:${String(s).padStart(2, '0')}`;
        }
        
        function formatDurationShort(seconds) {
            if (!seconds) return '0:00';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${String(s).padStart(2, '0')}`;
        }
        
        function formatRunPace(avgSpeed) {
            if (!avgSpeed || avgSpeed <= 0) return '-';
            const pace = 1000 / avgSpeed;
            const min = Math.floor(pace / 60);
            const sec = Math.round(pace % 60);
            return `${min}:${String(sec).padStart(2, '0')}`;
        }
        
        function formatSwimPace(avgSpeed) {
            if (!avgSpeed || avgSpeed <= 0) return '-';
            const pace = 100 / avgSpeed;
            const min = Math.floor(pace / 60);
            const sec = Math.round(pace % 60);
            return `${min}:${String(sec).padStart(2, '0')}`;
        }
        
        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        function goBackToData() {
            window.location.href = 'data.html';
        }
    </script>
</body>
</html>
