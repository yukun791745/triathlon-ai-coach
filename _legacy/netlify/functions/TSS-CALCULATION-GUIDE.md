# TSS (Training Stress Score) 計算ガイド

## 概要

TSS（Training Stress Score）は、トレーニングの「量×強度」を一つの数値で表す指標です。
異なる種目間でトレーニング負荷を比較できるため、トライアスロンのような複合競技に非常に有用です。

---

## 📊 計算式一覧

### 1. TSS（バイク用 - パワーベース）

```
TSS = IF² × Duration(時間) × 100
```

| 要素 | 説明 | 計算方法 |
|------|------|---------|
| **NP** (Normalized Power) | 正規化パワー | 下記参照 |
| **IF** (Intensity Factor) | 強度係数 | `NP ÷ FTP` |
| **FTP** | 機能的閾値パワー | 1時間維持できる最大パワー |
| **Duration** | 運動時間 | 時間単位 |

#### Normalized Power (NP) の計算手順

```
1. パワーデータの30秒移動平均を計算
2. 各値を4乗する
3. 4乗した値の平均を計算
4. その平均の4乗根を取る
```

```javascript
// 数式
NP = ⁴√(Σ(30秒移動平均パワー)⁴ / n)

// 例: FTP=250W, NP=225W, 2時間のライド
IF = 225 / 250 = 0.9
TSS = 0.9² × 2 × 100 = 162
```

#### TSS目安（バイク）

| TSS | 回復時間 | セッション例 |
|-----|---------|-------------|
| < 150 | 翌日には回復 | 通常のトレーニング |
| 150-300 | 翌々日まで疲労 | ハードな練習 |
| 300-450 | 2-3日疲労 | 非常にハード |
| > 450 | 4-5日以上疲労 | エピックライド |

---

### 2. rTSS（ラン用 - ペースベース）

```
rTSS = rIF² × Duration(時間) × 100
```

| 要素 | 説明 | 計算方法 |
|------|------|---------|
| **NGP** (Normalized Graded Pace) | 勾配調整済み正規化ペース | 下記参照 |
| **rIF** (Intensity Factor) | 強度係数 | `rFTPペース ÷ NGP` |
| **rFTP** | ラン閾値ペース | 1時間維持できる最速ペース |

#### NGP (Normalized Graded Pace) の計算

勾配による負荷調整を適用したペース：

```
1. 勾配調整係数を計算: adjustment = 1 + (grade% × 0.03)
   （上り1%につき約3%の追加負荷）
2. 調整済み速度 = 実際の速度 × adjustment
3. 30秒移動平均を計算
4. 4乗 → 平均 → 4乗根
```

```javascript
// 例: rFTP=5:00/km (300秒/km), NGP=5:30/km (330秒/km), 1時間のラン
rIF = 300 / 330 = 0.91
rTSS = 0.91² × 1 × 100 = 83
```

#### rTSS目安（ラン）

| rTSS | 回復時間 | セッション例 |
|------|---------|-------------|
| < 100 | 翌日には回復 | イージーラン |
| 100-150 | 1-2日疲労 | テンポラン |
| 150-200 | 2-3日疲労 | 長距離または高強度 |
| > 200 | 3日以上疲労 | レースまたはハードセッション |

---

### 3. sTSS（スイム用 - ペースベース）

```
sTSS = sIF² × Duration(時間) × 100
```

| 要素 | 説明 | 計算方法 |
|------|------|---------|
| **NP** (Normalized Pace) | 正規化ペース | 30秒移動平均 → 4乗処理 |
| **sIF** (Intensity Factor) | 強度係数 | `sFTPペース ÷ 実際のペース` |
| **sFTP** | スイム閾値ペース | 1000m-1500mのTTペース |

```javascript
// 例: sFTP=1:40/100m (100秒/100m), 実際=1:50/100m (110秒/100m), 45分
sIF = 100 / 110 = 0.91
sTSS = 0.91² × 0.75 × 100 = 62
```

#### sTSS目安（スイム）

| sTSS | セッション例 |
|------|-------------|
| 30-50 | リカバリースイム |
| 50-80 | 通常の練習 |
| 80-120 | ハードセッション |
| > 120 | レースまたはテスト |

---

### 4. hrTSS（心拍ベース - 全種目対応）

パワーメーターやGPSがない場合のフォールバック：

```
hrTSS = hrIF² × Duration(時間) × 100 × 0.9
```

| 要素 | 説明 | 計算方法 |
|------|------|---------|
| **hrIF** | 心拍強度係数 | `平均心拍 ÷ 閾値心拍` |
| **閾値心拍** | LTHR | 乳酸閾値での心拍数 |
| **0.9** | 補正係数 | 心拍の変動を考慮 |

---

## 📈 CTL / ATL / TSB（フィットネス・疲労・フォーム）

### 計算式

```
CTL (Chronic Training Load) = 指数移動平均（42日）
ATL (Acute Training Load) = 指数移動平均（7日）
TSB (Training Stress Balance) = CTL - ATL
```

詳細な計算：
```
CTL_today = CTL_yesterday + (TSS_today - CTL_yesterday) × (1 - e^(-1/42))
ATL_today = ATL_yesterday + (TSS_today - ATL_yesterday) × (1 - e^(-1/7))
```

### 指標の意味

| 指標 | 別名 | 意味 |
|------|------|------|
| **CTL** | フィットネス | 長期的なトレーニング適応 |
| **ATL** | 疲労 | 短期的な疲労度 |
| **TSB** | フォーム | パフォーマンス準備状態 |

### TSB（フォーム）の解釈

| TSB値 | 状態 | 推奨アクション |
|-------|------|---------------|
| > +25 | 非常にフレッシュ | トレーニング再開可能 |
| +5 ~ +25 | レース最適 | パフォーマンス発揮に最適 |
| -10 ~ +5 | 通常 | 通常のトレーニング継続 |
| -30 ~ -10 | 疲労蓄積 | 回復を意識 |
| < -30 | 過負荷 | 休養が必要 |

---

## 🎯 週間TSS目安

### 競技レベル別

| レベル | 週間TSS | 説明 |
|--------|---------|------|
| 初心者 | 200-300 | トレーニングを始めたばかり |
| 中級者 | 400-500 | 定期的にトレーニング |
| 上級者 | 600-800 | 競技志向 |
| エリート | 800-1200+ | プロレベル |

### トライアスロン距離別（レース週間前の目安）

| 距離 | 週間TSS目安 |
|------|------------|
| スプリント | 300-400 |
| オリンピック | 400-600 |
| 70.3 | 600-800 |
| アイアンマン | 800-1200 |

---

## 💻 API使用例

### TSS計算

```javascript
// リクエスト
POST /.netlify/functions/strava-tss
{
    "token": "アクセストークン",
    "activityId": 12345678,
    "thresholds": {
        "ftp": 250,              // バイクFTP (W)
        "rFtpPacePerKm": 270,    // ラン閾値ペース (秒/km) = 4:30/km
        "sFtpPacePer100m": 95,   // スイム閾値ペース (秒/100m) = 1:35/100m
        "maxHr": 185,            // 最大心拍
        "thresholdHr": 165       // 閾値心拍
    }
}

// レスポンス
{
    "success": true,
    "activityType": "Run",
    "tss": {
        "type": "rTSS",
        "sport": "Run",
        "method": "pace_stream",
        "tss": 85,
        "details": {
            "ngpPacePerKm": "5:15/km",
            "intensityFactor": "0.86",
            "formula": "rTSS = IF² × Duration(h) × 100"
        }
    }
}
```

### CTL/ATL/TSB計算

```javascript
// リクエスト
POST /.netlify/functions/strava-training-load
{
    "tssHistory": [
        { "date": "2024-01-01", "tss": 75 },
        { "date": "2024-01-02", "tss": 0 },
        { "date": "2024-01-03", "tss": 85 },
        // ...
    ],
    "ctlDays": 42,
    "atlDays": 7
}

// レスポンス
{
    "current": {
        "ctl": 52.3,
        "atl": 68.7,
        "tsb": -16.4,
        "fitness": { "level": "中程度" },
        "fatigue": { "level": "高い" },
        "form": { "status": "疲労" }
    },
    "analysis": {
        "raceReadiness": {
            "score": 45,
            "status": "トレーニング継続推奨"
        }
    }
}
```

---

## ⚠️ 注意事項

1. **FTP/閾値ペースの設定が重要**
   - 不正確な閾値設定はTSSの計算精度を大きく下げます
   - 定期的なテスト（FTPテスト、閾値走など）で更新しましょう

2. **異なる計算方法の精度**
   - パワーベース > ペースベース > 心拍ベース > 時間ベース

3. **個人差**
   - 回復能力は個人差が大きいため、目安は参考程度に

4. **累積疲労**
   - 単発のTSSより、週間・月間の累積と回復のバランスが重要
